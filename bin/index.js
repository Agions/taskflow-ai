#!/usr/bin/env node
"use strict";var rr=Object.create;var ye=Object.defineProperty;var sr=Object.getOwnPropertyDescriptor;var or=Object.getOwnPropertyNames;var nr=Object.getPrototypeOf,ar=Object.prototype.hasOwnProperty;var u=(i,e)=>ye(i,"name",{value:e,configurable:!0});var P=(i,e)=>()=>(i&&(e=i(i=0)),e);var ze=(i,e)=>{for(var t in e)ye(i,t,{get:e[t],enumerable:!0})},ir=(i,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of or(e))!ar.call(i,s)&&s!==t&&ye(i,s,{get:()=>e[s],enumerable:!(r=sr(e,s))||r.enumerable});return i};var m=(i,e,t)=>(t=i!=null?rr(nr(i)):{},ir(e||!i||!i.__esModule?ye(t,"default",{value:i,enumerable:!0}):t,i));var x=P(()=>{"use strict"});var L,Te,nt,ke,He=P(()=>{"use strict";L=m(require("fs-extra")),Te=m(require("path")),nt=m(require("markdown-it")),ke=class{static{u(this,"DocumentProcessor")}constructor(e){this.logger=e,this.markdownParser=new nt.default({html:!0,linkify:!0,typographer:!0})}async processDocument(e,t={}){try{if(this.logger.info(`\u5F00\u59CB\u5904\u7406\u6587\u6863: ${e}`),!await L.pathExists(e))throw new Error(`\u6587\u4EF6\u4E0D\u5B58\u5728: ${e}`);let r=await L.stat(e),s=this.detectDocumentType(e),o=await this.readFileContent(e,s),n={fileName:Te.basename(e),fileSize:r.size,createdAt:r.birthtime,modifiedAt:r.mtime,documentType:s,language:t.detectLanguage?this.detectLanguage(o):"zh-CN",wordCount:this.countWords(o),estimatedReadTime:Math.ceil(this.countWords(o)/200)},a=await this.parseDocumentStructure(o,s,t),c={title:this.extractTitle(o,s)||n.fileName,sections:a,metadata:n};return this.logger.info(`\u6587\u6863\u5904\u7406\u5B8C\u6210: ${a.length} \u4E2A\u7AE0\u8282`),c}catch(r){throw this.logger.error(`\u6587\u6863\u5904\u7406\u5931\u8D25: ${r.message}`),r}}detectDocumentType(e){switch(Te.extname(e).toLowerCase()){case".md":case".markdown":return"markdown";case".txt":return"text";case".json":return"json";case".html":case".htm":return"html";case".docx":case".doc":return"word";case".pdf":return"pdf";default:return"text"}}async readFileContent(e,t){switch(t){case"markdown":case"text":case"html":case"json":return await L.readFile(e,"utf-8");case"word":return this.logger.warn("Word\u6587\u6863\u89E3\u6790\u6682\u672A\u5B9E\u73B0\uFF0C\u5C06\u4F5C\u4E3A\u6587\u672C\u5904\u7406"),await L.readFile(e,"utf-8");case"pdf":return this.logger.warn("PDF\u6587\u6863\u89E3\u6790\u6682\u672A\u5B9E\u73B0\uFF0C\u5C06\u4F5C\u4E3A\u6587\u672C\u5904\u7406"),await L.readFile(e,"utf-8");default:return await L.readFile(e,"utf-8")}}async parseDocumentStructure(e,t,r){switch(t){case"markdown":return this.parseMarkdownStructure(e,r);case"text":return this.parseTextStructure(e,r);case"json":return this.parseJsonStructure(e,r);case"html":return this.parseHtmlStructure(e,r);default:return this.parseTextStructure(e,r)}}parseMarkdownStructure(e,t){let r=[],s=e.split(`
`),o=null,n=0;for(let a=0;a<s.length;a++){let c=s[a].trim(),g=c.match(/^(#{1,6})\s+(.+)$/);if(g){let d=g[1].length,w=g[2].trim();o&&r.push(o),o={id:`section-${++n}`,title:w,content:"",level:d,subsections:[],type:this.classifySectionType(w),keywords:t.extractKeywords?this.extractKeywords(w):[],importance:t.calculateImportance?this.calculateImportance(w,""):.5}}else o&&c&&(o.content+=c+`
`)}return o&&r.push(o),(t.calculateImportance||t.extractKeywords)&&r.forEach(a=>{t.extractKeywords&&(a.keywords=this.extractKeywords(a.title+" "+a.content)),t.calculateImportance&&(a.importance=this.calculateImportance(a.title,a.content))}),this.buildSectionHierarchy(r)}parseTextStructure(e,t){let r=[];return e.split(/\n\s*\n/).filter(o=>o.trim()).forEach((o,n)=>{let a=o.trim().split(`
`),c=a[0].trim(),g=a.slice(1).join(`
`).trim();r.push({id:`section-${n+1}`,title:c||`\u6BB5\u843D ${n+1}`,content:g,level:1,subsections:[],type:this.classifySectionType(c),keywords:t.extractKeywords?this.extractKeywords(o):[],importance:t.calculateImportance?this.calculateImportance(c,g):.5})}),r}parseJsonStructure(e,t){try{let r=JSON.parse(e),s=[];return Array.isArray(r)?r.forEach((o,n)=>{s.push(this.createSectionFromObject(o,`item-${n}`,1))}):typeof r=="object"&&Object.entries(r).forEach(([o,n],a)=>{s.push(this.createSectionFromObject({[o]:n},`section-${a+1}`,1))}),s}catch(r){return this.logger.error(`JSON\u89E3\u6790\u5931\u8D25: ${r.message}`),[]}}parseHtmlStructure(e,t){let r=[],s=/<h([1-6])[^>]*>(.*?)<\/h[1-6]>/gi,o,n=0;for(;(o=s.exec(e))!==null;){let a=parseInt(o[1]),c=o[2].replace(/<[^>]*>/g,"").trim();r.push({id:`section-${++n}`,title:c,content:"",level:a,subsections:[],type:this.classifySectionType(c),keywords:t.extractKeywords?this.extractKeywords(c):[],importance:t.calculateImportance?this.calculateImportance(c,""):.5})}return this.buildSectionHierarchy(r)}createSectionFromObject(e,t,r){let s=typeof e=="object"&&e!==null?Object.keys(e)[0]||t:String(e),o=typeof e=="object"&&e!==null?JSON.stringify(e,null,2):String(e);return{id:t,title:s,content:o,level:r,subsections:[],type:this.classifySectionType(s),keywords:this.extractKeywords(o),importance:this.calculateImportance(s,o)}}buildSectionHierarchy(e){let t=[],r=[];for(let s of e){for(;r.length>0&&r[r.length-1].level>=s.level;)r.pop();r.length===0?t.push(s):r[r.length-1].subsections.push(s),r.push(s)}return t}classifySectionType(e){let t=e.toLowerCase();return t.includes("\u6982\u8FF0")||t.includes("overview")||t.includes("\u7B80\u4ECB")?"overview":t.includes("\u9700\u6C42")||t.includes("requirement")?"requirements":t.includes("\u529F\u80FD")||t.includes("feature")?"features":t.includes("\u6280\u672F")||t.includes("technical")||t.includes("\u67B6\u6784")?"technical":t.includes("\u65F6\u95F4")||t.includes("timeline")||t.includes("\u8BA1\u5212")?"timeline":t.includes("\u8D44\u6E90")||t.includes("resource")?"resources":t.includes("\u9644\u5F55")||t.includes("appendix")?"appendix":"other"}extractKeywords(e){let t=e.toLowerCase().replace(/[^\u4e00-\u9fa5a-zA-Z0-9\s]/g," ").split(/\s+/).filter(s=>s.length>1),r=new Map;return t.forEach(s=>{r.set(s,(r.get(s)||0)+1)}),Array.from(r.entries()).sort((s,o)=>o[1]-s[1]).slice(0,10).map(([s])=>s)}calculateImportance(e,t){let r=.5,s=["\u6838\u5FC3","\u5173\u952E","\u91CD\u8981","\u5FC5\u987B","\u4E3B\u8981","core","key","important","critical","main"],o=e.toLowerCase();s.forEach(c=>{o.includes(c)&&(r+=.1)});let n=t.length;switch(n>1e3&&(r+=.1),n>2e3&&(r+=.1),this.classifySectionType(e)){case"requirements":case"features":r+=.2;break;case"technical":r+=.15;break;case"overview":r+=.1;break}return Math.min(1,r)}extractTitle(e,t){switch(t){case"markdown":{let r=e.match(/^#\s+(.+)$/m);return r?r[1].trim():null}case"html":{let r=e.match(/<h1[^>]*>(.*?)<\/h1>/i);return r?r[1].replace(/<[^>]*>/g,"").trim():null}default:{let r=e.split(`
`)[0].trim();return r.length>0&&r.length<100?r:null}}}detectLanguage(e){let t=e.match(/[\u4e00-\u9fa5]/g),r=e.replace(/\s/g,"").length;return t&&t.length/r>.3?"zh-CN":"en-US"}countWords(e){let t=e.match(/[\u4e00-\u9fa5]/g),r=e.match(/[a-zA-Z]+/g),s=t?t.length:0,o=r?r.length:0;return s+o}}});var q,O=P(()=>{"use strict";q=(h=>(h.NOT_STARTED="not_started",h.PENDING="pending",h.IN_PROGRESS="in_progress",h.RUNNING="running",h.COMPLETED="completed",h.DONE="done",h.CANCELLED="cancelled",h.FAILED="failed",h.BLOCKED="blocked",h.ON_HOLD="on_hold",h.REVIEW="review",h.TODO="todo",h))(q||{})});var be,at=P(()=>{"use strict";He();O();be=class{constructor(e){this.requirementPatterns={functional:[/系统(应该|必须|需要|能够)(.+)/gi,/用户(可以|能够|应该)(.+)/gi,/应用程序(应该|必须|需要)(.+)/gi,/(实现|支持|提供)(.+)功能/gi,/the system (should|must|shall|will)(.+)/gi,/users (can|should|must|will be able to)(.+)/gi],nonFunctional:[/(性能|响应时间|吞吐量)(.+)/gi,/(安全|权限|认证)(.+)/gi,/(可用性|稳定性|可靠性)(.+)/gi,/(兼容性|扩展性|可维护性)(.+)/gi,/(performance|security|usability|reliability)(.+)/gi],userStory:[/作为(.+?)，我希望(.+?)，以便(.+)/gi,/As a (.+?), I want (.+?) so that (.+)/gi,/Given (.+?) when (.+?) then (.+)/gi],constraint:[/(限制|约束|不能|禁止)(.+)/gi,/(constraint|limitation|restriction)(.+)/gi]};this.priorityKeywords={critical:["\u5173\u952E","\u6838\u5FC3","\u91CD\u8981","\u5FC5\u987B","critical","essential","must","key"],high:["\u9AD8","\u4F18\u5148","\u91CD\u70B9","high","priority","important"],medium:["\u4E2D\u7B49","\u4E00\u822C","\u666E\u901A","medium","normal","standard"],low:["\u4F4E","\u6B21\u8981","\u53EF\u9009","low","optional","nice to have"]};this.complexityKeywords={high:["\u590D\u6742","\u56F0\u96BE","\u6311\u6218","\u96C6\u6210","\u7B97\u6CD5","complex","difficult","challenging","integration"],medium:["\u4E2D\u7B49","\u6807\u51C6","\u5E38\u89C4","medium","standard","typical"],low:["\u7B80\u5355","\u57FA\u7840","\u76F4\u63A5","simple","basic","straightforward"]};this.logger=e}static{u(this,"RequirementExtractor")}async extractRequirements(e,t={}){try{this.logger.info("\u5F00\u59CB\u63D0\u53D6\u9700\u6C42");let r=[],s=[],o=[];for(let a of e.sections){let c=await this.extractFromSection(a,t);r.push(...c)}t.detectDependencies&&this.detectDependencies(r);let n=this.generateSummary(r);return o.push(...this.generateSuggestions(r,n)),s.push(...this.validateRequirements(r)),this.logger.info(`\u9700\u6C42\u63D0\u53D6\u5B8C\u6210: ${r.length} \u4E2A\u9700\u6C42`),{requirements:r,summary:n,warnings:s,suggestions:o}}catch(r){throw this.logger.error(`\u9700\u6C42\u63D0\u53D6\u5931\u8D25: ${r.message}`),r}}async extractFromSection(e,t){let r=[],s=e.title+`
`+e.content;switch(e.type){case"requirements":r.push(...this.extractFunctionalRequirements(e,s)),r.push(...this.extractNonFunctionalRequirements(e,s));break;case"features":r.push(...this.extractFeatureRequirements(e,s)),t.includeUserStories&&r.push(...this.extractUserStories(e,s));break;case"technical":r.push(...this.extractTechnicalRequirements(e,s));break;default:r.push(...this.extractGeneralRequirements(e,s));break}for(let o of e.subsections){let n=await this.extractFromSection(o,t);r.push(...n)}return r}extractFunctionalRequirements(e,t){let r=[],s=1;return this.requirementPatterns.functional.forEach(o=>{let n;for(;(n=o.exec(t))!==null;){let a=n[0].trim();a.length>10&&r.push(this.createRequirement(`${e.id}-func-${s++}`,this.extractTitle(a),a,"functional",e,t))}}),r}extractNonFunctionalRequirements(e,t){let r=[],s=1;return this.requirementPatterns.nonFunctional.forEach(o=>{let n;for(;(n=o.exec(t))!==null;){let a=n[0].trim();a.length>10&&r.push(this.createRequirement(`${e.id}-nonfunc-${s++}`,this.extractTitle(a),a,"non_functional",e,t))}}),r}extractFeatureRequirements(e,t){let r=[],s=t.split(`
`).filter(n=>n.trim()),o=1;return s.forEach(n=>{let a=n.trim();this.isFunctionDescription(a)&&r.push(this.createRequirement(`${e.id}-feature-${o++}`,this.extractTitle(a),a,"functional",e,t))}),r}extractUserStories(e,t){let r=[],s=1;return this.requirementPatterns.userStory.forEach(o=>{let n;for(;(n=o.exec(t))!==null;){let a=n[0].trim();r.push(this.createRequirement(`${e.id}-story-${s++}`,`\u7528\u6237\u6545\u4E8B ${s}`,a,"user_story",e,t))}}),r}extractTechnicalRequirements(e,t){let r=[],s=["\u6280\u672F\u6808","\u67B6\u6784","\u6570\u636E\u5E93","\u6846\u67B6","\u63A5\u53E3","API","\u670D\u52A1","\u7EC4\u4EF6"],o=t.split(`
`).filter(a=>a.trim()),n=1;return o.forEach(a=>{let c=a.trim();s.some(g=>c.includes(g))&&c.length>10&&r.push(this.createRequirement(`${e.id}-tech-${n++}`,this.extractTitle(c),c,"technical",e,t))}),r}extractGeneralRequirements(e,t){let r=[],s=t.split(`
`).filter(n=>n.trim()),o=1;return s.forEach(n=>{let a=n.trim();this.isRequirementLike(a)&&r.push(this.createRequirement(`${e.id}-req-${o++}`,this.extractTitle(a),a,"business",e,t))}),r}createRequirement(e,t,r,s,o,n){return{id:e,title:t,description:r,type:s,priority:this.analyzePriority(r),category:o.title,source:o.id,dependencies:[],acceptanceCriteria:this.extractAcceptanceCriteria(r),estimatedEffort:this.estimateEffort(r,s),complexity:this.analyzeComplexity(r),tags:this.extractTags(r),stakeholders:this.extractStakeholders(r),businessValue:this.calculateBusinessValue(r,s),technicalRisk:this.calculateTechnicalRisk(r,s),metadata:{extractedAt:new Date,confidence:this.calculateConfidence(r,s),extractionMethod:"pattern_matching",keywords:o.keywords,relatedSections:[o.id]}}}analyzePriority(e){let t=e.toLowerCase();for(let[r,s]of Object.entries(this.priorityKeywords))if(s.some(o=>t.includes(o)))return r;return"medium"}analyzeComplexity(e){let t=e.toLowerCase();for(let[r,s]of Object.entries(this.complexityKeywords))if(s.some(o=>t.includes(o)))return r;return e.length>200?"high":e.length>100?"medium":"low"}estimateEffort(e,t){let r=8;switch(t){case"technical":r=16;break;case"non_functional":r=12;break;case"user_story":r=6;break}switch(this.analyzeComplexity(e)){case"high":r*=2;break;case"low":r*=.5;break}return Math.round(r)}calculateBusinessValue(e,t){let r=5,s=["\u6536\u5165","\u7528\u6237","\u4F53\u9A8C","\u6548\u7387","\u6210\u672C","revenue","user","experience","efficiency"],o=e.toLowerCase();return s.forEach(n=>{o.includes(n)&&(r+=1)}),t==="business"&&(r+=2),t==="user_story"&&(r+=1),Math.min(10,r)}calculateTechnicalRisk(e,t){let r=3,s=["\u96C6\u6210","\u65B0\u6280\u672F","\u7B97\u6CD5","\u6027\u80FD","\u5B89\u5168","integration","new","algorithm","performance","security"],o=e.toLowerCase();return s.forEach(n=>{o.includes(n)&&(r+=1)}),t==="technical"&&(r+=2),t==="non_functional"&&(r+=1),Math.min(10,r)}calculateConfidence(e,t){let r=.5;return this.requirementPatterns.functional.some(s=>s.test(e))&&(r+=.3),e.length>20&&e.length<500&&(r+=.2),Math.min(1,r)}extractAcceptanceCriteria(e){let t=[];return[/验收标准[：:]\s*(.+)/gi,/acceptance criteria[：:]\s*(.+)/gi,/given (.+?) when (.+?) then (.+)/gi].forEach(s=>{let o;for(;(o=s.exec(e))!==null;)t.push(o[1]||o[0])}),t}extractTags(e){let t=[],r={UI:["\u754C\u9762","\u9875\u9762","\u6309\u94AE","UI","interface","page","button"],API:["\u63A5\u53E3","API","service","\u670D\u52A1"],Database:["\u6570\u636E\u5E93","\u5B58\u50A8","database","storage"],Security:["\u5B89\u5168","\u6743\u9650","security","permission","auth"],Performance:["\u6027\u80FD","\u901F\u5EA6","performance","speed"]},s=e.toLowerCase();return Object.entries(r).forEach(([o,n])=>{n.some(a=>s.includes(a))&&t.push(o)}),t}extractStakeholders(e){let t=[];return[/用户/g,/管理员/g,/开发者/g,/测试人员/g,/user/gi,/admin/gi,/developer/gi,/tester/gi].forEach(s=>{let o=e.match(s);o&&t.push(...o)}),[...new Set(t)]}detectDependencies(e){e.forEach(t=>{e.forEach(r=>{t.id!==r.id&&this.hasDependencyRelation(t.description,r.description)&&t.dependencies.push(r.id)})})}hasDependencyRelation(e,t){return["\u57FA\u4E8E","\u4F9D\u8D56","\u9700\u8981","\u4F7F\u7528","based on","depends on","requires","uses"].some(s=>e.toLowerCase().includes(s)&&t.toLowerCase().includes(s))}generateSummary(e){let t=e.filter(h=>h.type==="functional").length,r=e.filter(h=>h.type==="non_functional").length,s=e.filter(h=>h.type==="user_story").length,o=e.filter(h=>h.priority==="high"||h.priority==="critical").length,n=e.reduce((h,D)=>h+D.estimatedEffort,0),a=e.map(h=>{switch(h.complexity){case"high":return 3;case"medium":return 2;case"low":return 1;default:return 2}}),c=a.reduce((h,D)=>h+D,0)/a.length,g=c>2.5?"high":c>1.5?"medium":"low",d=e.reduce((h,D)=>h+D.metadata.confidence,0)/e.length,w=Math.min(1,d*(e.length/10));return{totalRequirements:e.length,functionalRequirements:t,nonFunctionalRequirements:r,userStories:s,highPriorityRequirements:o,estimatedTotalEffort:n,averageComplexity:g,coverageScore:w}}generateSuggestions(e,t){let r=[];return t.totalRequirements<5&&r.push("\u9700\u6C42\u6570\u91CF\u8F83\u5C11\uFF0C\u5EFA\u8BAE\u68C0\u67E5\u662F\u5426\u9057\u6F0F\u4E86\u91CD\u8981\u9700\u6C42"),t.nonFunctionalRequirements===0&&r.push("\u672A\u53D1\u73B0\u975E\u529F\u80FD\u9700\u6C42\uFF0C\u5EFA\u8BAE\u8865\u5145\u6027\u80FD\u3001\u5B89\u5168\u3001\u53EF\u7528\u6027\u7B49\u65B9\u9762\u7684\u9700\u6C42"),t.highPriorityRequirements/t.totalRequirements>.8&&r.push("\u9AD8\u4F18\u5148\u7EA7\u9700\u6C42\u6BD4\u4F8B\u8FC7\u9AD8\uFF0C\u5EFA\u8BAE\u91CD\u65B0\u8BC4\u4F30\u9700\u6C42\u4F18\u5148\u7EA7"),t.coverageScore<.6&&r.push("\u9700\u6C42\u8986\u76D6\u5EA6\u8F83\u4F4E\uFF0C\u5EFA\u8BAE\u8865\u5145\u66F4\u8BE6\u7EC6\u7684\u9700\u6C42\u63CF\u8FF0"),t.estimatedTotalEffort/t.totalRequirements>20&&r.push("\u5E73\u5747\u5DE5\u4F5C\u91CF\u8F83\u9AD8\uFF0C\u5EFA\u8BAE\u5C06\u590D\u6742\u9700\u6C42\u62C6\u5206\u4E3A\u66F4\u5C0F\u7684\u4EFB\u52A1"),r}validateRequirements(e){let t=[];return e.forEach(r=>{r.description.length<10&&t.push(`\u9700\u6C42 ${r.id} \u63CF\u8FF0\u8FC7\u4E8E\u7B80\u77ED`),r.metadata.confidence<.3&&t.push(`\u9700\u6C42 ${r.id} \u63D0\u53D6\u7F6E\u4FE1\u5EA6\u8F83\u4F4E`),r.acceptanceCriteria.length===0&&t.push(`\u9700\u6C42 ${r.id} \u7F3A\u5C11\u9A8C\u6536\u6807\u51C6`)}),t}isFunctionDescription(e){return[/^[-*+]\s+/,/^\d+\.\s+/,/^[a-zA-Z0-9]+[.)]\s+/,/功能|特性|能力/].some(r=>r.test(e))&&e.length>10}isRequirementLike(e){return["\u9700\u8981","\u5E94\u8BE5","\u5FC5\u987B","\u80FD\u591F","\u652F\u6301","\u5B9E\u73B0","\u63D0\u4F9B","need","should","must","shall","support","implement","provide"].some(r=>e.toLowerCase().includes(r))&&e.length>15}extractTitle(e){let t=e.substring(0,50).trim();return t.endsWith("...")?t:t+(e.length>50?"...":"")}}});var it,ct,ee,Pe=P(()=>{"use strict";it=m(require("fs-extra")),ct=m(require("path"));x();He();at();O();ee=class{static{u(this,"PRDParser")}constructor(e,t){this.modelCoordinator=e,this.logger=t,this.documentProcessor=new ke(t),this.requirementExtractor=new be(t)}async parseFromFile(e,t){try{if(this.logger.info(`\u5F00\u59CB\u89E3\u6790PRD\u6587\u4EF6\uFF1A${e}`),!await it.pathExists(e))throw new Error(`\u6587\u4EF6\u4E0D\u5B58\u5728\uFF1A${e}`);let r={extractTables:!0,extractImages:!1,detectLanguage:!0,analyzeStructure:!0,extractKeywords:!0,calculateImportance:!0},s=await this.documentProcessor.processDocument(e,r),o={includeUserStories:t?.extractFeatures??!0,detectDependencies:!0,estimateEffort:!0,analyzePriority:t?.prioritize??!0,extractAcceptanceCriteria:!0,detectStakeholders:!0},n=await this.requirementExtractor.extractRequirements(s,o);return this.convertToParseResult(s,n)}catch(r){throw this.logger.error(`\u89E3\u6790PRD\u6587\u4EF6\u5931\u8D25\uFF1A${r.message}`),r}}async parseContent(e,t="markdown",r){try{let s=this.preprocessContent(e,t),o=await this.modelCoordinator.parsePRD(s,r);try{let n=JSON.parse(o.content);return this.validateParseResult(n),this.logger.info("PRD\u89E3\u6790\u6210\u529F"),n}catch(n){throw this.logger.error(`\u89E3\u6790\u6A21\u578B\u8FD4\u56DE\u7ED3\u679C\u5931\u8D25\uFF1A${n.message}`),new Error(`\u65E0\u6CD5\u89E3\u6790\u6A21\u578B\u8FD4\u56DE\u7684JSON\u7ED3\u679C\uFF1A${n.message}`)}}catch(s){throw this.logger.error(`\u89E3\u6790PRD\u5185\u5BB9\u5931\u8D25\uFF1A${s.message}`),s}}preprocessContent(e,t){switch(t){case"markdown":return e;case"json":try{let r=JSON.parse(e);return JSON.stringify(r,null,2)}catch{return e}default:return e}}detectFileType(e){switch(ct.extname(e).toLowerCase()){case".md":case".markdown":return"markdown";case".pdf":return"pdf";case".docx":case".doc":return"word";case".txt":return"text";case".json":return"json";default:return"unknown"}}validateParseResult(e){if(e.title||this.logger.warn("\u89E3\u6790\u7ED3\u679C\u7F3A\u5C11\u6807\u9898"),e.description||this.logger.warn("\u89E3\u6790\u7ED3\u679C\u7F3A\u5C11\u63CF\u8FF0"),!Array.isArray(e.sections)||e.sections.length===0)throw new Error("\u89E3\u6790\u7ED3\u679C\u5FC5\u987B\u5305\u542B\u81F3\u5C11\u4E00\u4E2A\u7AE0\u8282");e.sections.forEach((t,r)=>{t.title||this.logger.warn(`\u7B2C${r+1}\u4E2A\u7AE0\u8282\u7F3A\u5C11\u6807\u9898`),Array.isArray(t.features)||(this.logger.warn(`\u7B2C${r+1}\u4E2A\u7AE0\u8282\u7684features\u5B57\u6BB5\u4E0D\u662F\u6570\u7EC4`),t.features=[])})}convertToParseResult(e,t){let r=t.requirements.map(o=>({id:o.id,name:o.title,description:o.description,priority:o.priority,type:o.type,dependencies:o.dependencies,estimatedHours:o.estimatedEffort,tags:o.tags,acceptanceCriteria:o.acceptanceCriteria,complexity:o.complexity,businessValue:o.businessValue,technicalRisk:o.technicalRisk,stakeholders:o.stakeholders,category:o.category,status:"not_started",createdAt:o.metadata.extractedAt,updatedAt:o.metadata.extractedAt}));return{id:`prd-${Date.now()}`,title:e.title,description:this.extractDescription(e),sections:[],metadata:{version:"1.0.0",features:r,fileName:e.metadata.fileName,fileSize:e.metadata.fileSize,parsedAt:new Date,language:e.metadata.language,wordCount:e.metadata.wordCount,estimatedReadTime:e.metadata.estimatedReadTime,extractionSummary:t.summary,warnings:t.warnings,suggestions:t.suggestions,documentStructure:{sectionsCount:e.sections.length,maxDepth:this.calculateMaxDepth(this.convertToPRDSections(e.sections)),hasTableOfContents:this.hasTableOfContents(e),primaryLanguage:e.metadata.language},createdAt:new Date,updatedAt:new Date}}}extractDescription(e){let t=e.sections.find(r=>r.type==="overview"||r.title.toLowerCase().includes("\u6982\u8FF0")||r.title.toLowerCase().includes("\u7B80\u4ECB")||r.title.toLowerCase().includes("overview"));return t?t.content.substring(0,500).trim():e.sections.length>0?e.sections[0].content.substring(0,500).trim():"\u4ECEPRD\u6587\u6863\u81EA\u52A8\u63D0\u53D6\u7684\u4EA7\u54C1\u9700\u6C42"}convertToPRDSections(e){return e.map(t=>({title:t.title,content:t.content,level:t.level,features:[],subsections:t.subsections?this.convertToPRDSections(t.subsections):void 0}))}calculateMaxDepth(e){let t=0,r=u((s,o=1)=>{t=Math.max(t,o),s.forEach(n=>{n.subsections&&n.subsections.length>0&&r(n.subsections,o+1)})},"calculateDepth");return r(e),t}hasTableOfContents(e){return e.sections.some(t=>t.title.toLowerCase().includes("\u76EE\u5F55")||t.title.toLowerCase().includes("contents")||t.title.toLowerCase().includes("toc"))}}});var Ce,ut,te,Se=P(()=>{"use strict";Ce=m(require("fs-extra")),ut=m(require("path"));O();te=class{static{u(this,"TaskPlanner")}constructor(e,t){this.modelCoordinator=e,this.logger=t}async generateTaskPlan(e,t){try{this.logger.info("\u5F00\u59CB\u751F\u6210\u4EFB\u52A1\u8BA1\u5212");let r=await this.modelCoordinator.planTasks(e,t);try{let s=JSON.parse(r.content);return this.validateTaskPlan(s),this.postProcessTaskPlan(s),this.logger.info(`\u4EFB\u52A1\u8BA1\u5212\u751F\u6210\u6210\u529F\uFF0C\u5171 ${s.tasks.length} \u4E2A\u4EFB\u52A1`),s}catch(s){throw this.logger.error(`\u89E3\u6790\u6A21\u578B\u8FD4\u56DE\u7684\u4EFB\u52A1\u8BA1\u5212\u5931\u8D25\uFF1A${s.message}`),new Error(`\u65E0\u6CD5\u89E3\u6790\u6A21\u578B\u8FD4\u56DE\u7684JSON\u7ED3\u679C\uFF1A${s.message}`)}}catch(r){throw this.logger.error(`\u751F\u6210\u4EFB\u52A1\u8BA1\u5212\u5931\u8D25\uFF1A${r.message}`),r}}async optimizeTaskPlan(e,t){try{return this.logger.info("\u5F00\u59CB\u4F18\u5316\u4EFB\u52A1\u8BA1\u5212"),this.optimizeDependencies(e),this.optimizePriorities(e,t),this.identifyParallelTasks(e,t),this.balanceWorkload(e,t),this.logger.info("\u4EFB\u52A1\u8BA1\u5212\u4F18\u5316\u5B8C\u6210"),e}catch(r){throw this.logger.error(`\u4F18\u5316\u4EFB\u52A1\u8BA1\u5212\u5931\u8D25\uFF1A${r.message}`),r}}async saveTaskPlan(e,t){try{await Ce.ensureDir(ut.dirname(t)),await Ce.writeFile(t,JSON.stringify(e,null,2),"utf-8"),this.logger.info(`\u4EFB\u52A1\u8BA1\u5212\u5DF2\u4FDD\u5B58\u81F3 ${t}`)}catch(r){throw this.logger.error(`\u4FDD\u5B58\u4EFB\u52A1\u8BA1\u5212\u5931\u8D25\uFF1A${r.message}`),r}}validateTaskPlan(e){if(e.name||this.logger.warn("\u4EFB\u52A1\u8BA1\u5212\u7F3A\u5C11\u540D\u79F0"),e.description||this.logger.warn("\u4EFB\u52A1\u8BA1\u5212\u7F3A\u5C11\u63CF\u8FF0"),!Array.isArray(e.tasks))throw new Error("\u4EFB\u52A1\u8BA1\u5212\u5FC5\u987B\u5305\u542Btasks\u6570\u7EC4");e.tasks.forEach((t,r)=>{if(!t.id)throw new Error(`\u7B2C${r+1}\u4E2A\u4EFB\u52A1\u7F3A\u5C11ID`);t.title||this.logger.warn(`\u4EFB\u52A1 ${t.id} \u7F3A\u5C11\u6807\u9898`),t.priority||(this.logger.warn(`\u4EFB\u52A1 ${t.id} \u7F3A\u5C11\u4F18\u5148\u7EA7\uFF0C\u8BBE\u7F6E\u4E3A\u9ED8\u8BA4\u503C'medium'`),t.priority="medium"),t.type||(this.logger.warn(`\u4EFB\u52A1 ${t.id} \u7F3A\u5C11\u7C7B\u578B\uFF0C\u8BBE\u7F6E\u4E3A\u9ED8\u8BA4\u503C'feature'`),t.type="feature"),Array.isArray(t.dependencies)||(this.logger.warn(`\u4EFB\u52A1 ${t.id} \u7684dependencies\u5B57\u6BB5\u4E0D\u662F\u6570\u7EC4\uFF0C\u8BBE\u7F6E\u4E3A\u7A7A\u6570\u7EC4`),t.dependencies=[]),t.status||(t.status="not_started")})}postProcessTaskPlan(e){let t=new Set;e.tasks.forEach(r=>{if(t.has(r.id)){let s=this.generateUniqueId(r.id,t);this.logger.warn(`\u53D1\u73B0\u91CD\u590D\u7684\u4EFB\u52A1ID: ${r.id}\uFF0C\u81EA\u52A8\u66F4\u65B0\u4E3A: ${s}`),r.id=s}t.add(r.id),r.dependencies=r.dependencies.filter(s=>!t.has(s)&&s!==r.id?(this.logger.warn(`\u4EFB\u52A1 ${r.id} \u4F9D\u8D56\u7684\u4EFB\u52A1 ${s} \u4E0D\u5B58\u5728\uFF0C\u5DF2\u79FB\u9664\u6B64\u4F9D\u8D56`),!1):s===r.id?(this.logger.warn(`\u4EFB\u52A1 ${r.id} \u4E0D\u80FD\u4F9D\u8D56\u81EA\u8EAB\uFF0C\u5DF2\u79FB\u9664\u6B64\u4F9D\u8D56`),!1):!0)}),this.checkCircularDependencies(e)}generateUniqueId(e,t){let r=1,s=`${e}_${r}`;for(;t.has(s);)r++,s=`${e}_${r}`;return s}checkCircularDependencies(e){let t=new Map;e.tasks.forEach(o=>{t.set(o.id,[...o.dependencies])});let r=new Set,s=new Set;e.tasks.forEach(o=>{this.detectCycle(o.id,t,r,s)})}detectCycle(e,t,r,s){if(s.has(e))return this.logger.warn(`\u68C0\u6D4B\u5230\u5FAA\u73AF\u4F9D\u8D56\uFF0C\u5305\u542B\u4EFB\u52A1: ${e}`),!0;if(r.has(e))return!1;r.add(e),s.add(e);let o=t.get(e)||[];for(let n of o)if(this.detectCycle(n,t,r,s)){let a=t.get(e)||[];t.set(e,a.filter(c=>c!==n)),this.logger.warn(`\u79FB\u9664\u5FAA\u73AF\u4F9D\u8D56: ${e} -> ${n}`)}return s.delete(e),!1}optimizeDependencies(e){this.logger.info("\u4F18\u5316\u4EFB\u52A1\u4F9D\u8D56\u5173\u7CFB"),e.tasks.forEach(t=>{let r=this.removeRedundantDependencies(t.dependencies,e);t.dependencies=r}),this.checkCircularDependencies(e)}removeRedundantDependencies(e,t){if(e.length<=1)return e;let r=new Map;t.tasks.forEach(o=>r.set(o.id,o));let s=[];for(let o of e){if(!r.get(o))continue;let a=!1;for(let c of e)if(c!==o&&this.hasTransitiveDependency(c,o,r)){a=!0;break}a||s.push(o)}return s}hasTransitiveDependency(e,t,r){let s=new Set,o=[e];for(;o.length>0;){let n=o.shift();if(s.has(n))continue;s.add(n);let a=r.get(n);if(a)for(let c of a.dependencies){if(c===t)return!0;s.has(c)||o.push(c)}}return!1}optimizePriorities(e,t){this.logger.info("\u4F18\u5316\u4EFB\u52A1\u4F18\u5148\u7EA7"),e.tasks.forEach(r=>{let s=this.findDependentTasks(r.id,e);s.length>=3?r.priority="high":s.length>=2&&(r.priority="medium"),this.isOnCriticalPath(r.id,e)&&(r.priority="critical")})}findDependentTasks(e,t){return t.tasks.filter(r=>r.dependencies.includes(e))}isOnCriticalPath(e,t){if(!t.tasks.find(n=>n.id===e))return!1;let s=this.calculateDependencyDepth(e,t),o=this.calculateAverageDependencyDepth(t);return s>o*1.5}calculateDependencyDepth(e,t){let r=new Set,s=u(o=>{if(r.has(o))return 0;r.add(o);let n=t.tasks.find(c=>c.id===o);if(!n||n.dependencies.length===0)return 1;let a=0;for(let c of n.dependencies)a=Math.max(a,s(c));return a+1},"dfs");return s(e)}calculateAverageDependencyDepth(e){let t=e.tasks.map(r=>this.calculateDependencyDepth(r.id,e));return t.reduce((r,s)=>r+s,0)/t.length}identifyParallelTasks(e,t){this.logger.info("\u8BC6\u522B\u5E76\u884C\u4EFB\u52A1"),this.findParallelGroups(e,3).forEach((o,n)=>{o.forEach(a=>{a.tags||(a.tags=[]),a.tags.push(`parallel-group-${n+1}`)})})}findParallelGroups(e,t){let r=[],s=new Set;return e.tasks.forEach(o=>{if(s.has(o.id))return;let n=this.findParallelTasks(o,e,s);n.length>1&&n.length<=t&&(r.push(n),n.forEach(a=>s.add(a.id)))}),r}findParallelTasks(e,t,r){let s=[e];return t.tasks.forEach(o=>{o.id===e.id||r.has(o.id)||this.canRunInParallel(e,o,t)&&s.push(o)}),s}canRunInParallel(e,t,r){return!(e.dependencies.includes(t.id)||t.dependencies.includes(e.id)||this.hasIndirectDependency(e.id,t.id,r)||this.hasIndirectDependency(t.id,e.id,r)||e.type===t.type&&(e.type==="deployment"||e.type==="test"))}hasIndirectDependency(e,t,r){let s=new Map;return r.tasks.forEach(o=>s.set(o.id,o)),this.hasTransitiveDependency(e,t,s)}balanceWorkload(e,t){this.logger.info("\u5E73\u8861\u5DE5\u4F5C\u91CF");let r=t?.considerTeamSize||3,o=e.tasks.reduce((n,a)=>n+(a.estimatedHours||8),0)/r;e.tasks.forEach(n=>{let a=n.estimatedHours||8;a>o*.5&&(n.tags||(n.tags=[]),n.tags.push("consider-splitting"),n.notes||(n.notes=""),n.notes+=`
\u5EFA\u8BAE\u62C6\u5206\uFF1A\u9884\u8BA1\u5DE5\u4F5C\u91CF ${a} \u5C0F\u65F6\uFF0C\u8D85\u8FC7\u5E73\u5747\u503C\u768450%`)})}}});var U,Ee,N,re=P(()=>{"use strict";U=m(require("fs-extra")),Ee=m(require("path"));O();N=class{constructor(e,t){this.taskPlan=null;this.autoSaveInterval=null;this.logger=e,this.configManager=t;let r=this.configManager.get("taskSettings",{outputDir:"./tasks",autoSave:!0,saveInterval:300});this.taskFilePath=Ee.join(r.outputDir,"tasks.json"),r.autoSave&&this.startAutoSave(r.saveInterval*1e3)}static{u(this,"TaskManager")}async loadTaskPlan(e){let t=e||this.taskFilePath;try{if(!U.existsSync(t))throw new Error(`\u4EFB\u52A1\u8BA1\u5212\u6587\u4EF6\u4E0D\u5B58\u5728\uFF1A${t}`);let r=await U.readFile(t,"utf-8");return this.taskPlan=JSON.parse(r),this.logger.info(`\u6210\u529F\u52A0\u8F7D\u4EFB\u52A1\u8BA1\u5212\uFF0C\u5171 ${this.taskPlan.tasks.length} \u4E2A\u4EFB\u52A1`),this.taskPlan}catch(r){throw this.logger.error(`\u52A0\u8F7D\u4EFB\u52A1\u8BA1\u5212\u5931\u8D25\uFF1A${r.message}`),r}}async saveTaskPlan(e){let t=e||this.taskFilePath;if(!this.taskPlan)throw new Error("\u6CA1\u6709\u4EFB\u52A1\u8BA1\u5212\u53EF\u4FDD\u5B58\uFF0C\u8BF7\u5148\u52A0\u8F7D\u6216\u521B\u5EFA\u4EFB\u52A1\u8BA1\u5212");try{await U.ensureDir(Ee.dirname(t)),await U.writeFile(t,JSON.stringify(this.taskPlan,null,2),"utf-8"),this.logger.info(`\u4EFB\u52A1\u8BA1\u5212\u5DF2\u4FDD\u5B58\u81F3 ${t}`)}catch(r){throw this.logger.error(`\u4FDD\u5B58\u4EFB\u52A1\u8BA1\u5212\u5931\u8D25\uFF1A${r.message}`),r}}setTaskPlan(e){this.taskPlan=e,this.logger.info(`\u8BBE\u7F6E\u4EFB\u52A1\u8BA1\u5212\u6210\u529F\uFF0C\u5171 ${e.tasks.length} \u4E2A\u4EFB\u52A1`)}getTaskPlan(){return this.taskPlan}getAllTasks(){if(!this.taskPlan)throw new Error("\u6CA1\u6709\u52A0\u8F7D\u4EFB\u52A1\u8BA1\u5212");return[...this.taskPlan.tasks]}getTaskById(e){if(!this.taskPlan)throw new Error("\u6CA1\u6709\u52A0\u8F7D\u4EFB\u52A1\u8BA1\u5212");if(e.includes(".")){let[t,r]=e.split("."),s=this.taskPlan.tasks.find(a=>a.id===t);if(!s||!s.subtasks)return null;let o=`${t}.${r}`,n=s.subtasks.find(a=>a.id===o);return n?{id:n.id,name:n.name,title:n.name,description:n.description,status:n.status,priority:"medium",type:"feature",dependencies:[],createdAt:new Date,updatedAt:new Date,tags:[],subtasks:[]}:null}return this.taskPlan.tasks.find(t=>t.id===e)||null}filterTasks(e){if(!this.taskPlan)throw new Error("\u6CA1\u6709\u52A0\u8F7D\u4EFB\u52A1\u8BA1\u5212");return this.taskPlan.tasks.filter(t=>{if(e.status){if(Array.isArray(e.status)){if(!e.status.includes(t.status))return!1}else if(t.status!==e.status)return!1}if(e.type){if(Array.isArray(e.type)){if(!e.type.includes(t.type))return!1}else if(t.type!==e.type)return!1}if(e.assignee&&t.assignee!==e.assignee)return!1;if(e.priority){if(Array.isArray(e.priority)){if(!e.priority.includes(t.priority))return!1}else if(t.priority!==e.priority)return!1}return!0})}addTask(e){if(!this.taskPlan)throw new Error("\u6CA1\u6709\u52A0\u8F7D\u4EFB\u52A1\u8BA1\u5212");if(this.taskPlan.tasks.find(r=>r.id===e.id))throw new Error(`\u4EFB\u52A1ID ${e.id} \u5DF2\u5B58\u5728`);return this.taskPlan.tasks.push(e),this.logger.info(`\u6DFB\u52A0\u65B0\u4EFB\u52A1 ${e.id}: ${e.name}`),e}updateTask(e,t){if(!this.taskPlan)throw new Error("\u6CA1\u6709\u52A0\u8F7D\u4EFB\u52A1\u8BA1\u5212");if(e.includes(".")){let[o]=e.split("."),n=this.taskPlan.tasks.findIndex(d=>d.id===o);if(n<0||!this.taskPlan.tasks[n].subtasks)return null;let a=e,c=this.taskPlan.tasks[n].subtasks.findIndex(d=>d.id===a);if(c<0)return null;let g=this.taskPlan.tasks[n].subtasks[c];return t.name&&(g.name=t.name),t.description&&(g.description=t.description),t.status&&(g.status=t.status),this.logger.info(`\u66F4\u65B0\u5B50\u4EFB\u52A1 ${e}: ${g.name}`),{id:g.id,name:g.name,title:g.name,description:g.description,status:g.status,priority:"medium",type:"feature",dependencies:[],subtasks:[],createdAt:new Date,updatedAt:new Date,tags:[]}}let r=this.taskPlan.tasks.findIndex(o=>o.id===e);if(r<0)return null;let s=this.taskPlan.tasks[r];return t.name&&(s.name=t.name),t.description&&(s.description=t.description),t.status&&(s.status=t.status),t.priority&&(s.priority=t.priority),t.assignee&&(s.assignee=t.assignee),this.logger.info(`\u66F4\u65B0\u4EFB\u52A1 ${e}: ${s.name}`),s}removeTask(e){if(!this.taskPlan)throw new Error("\u6CA1\u6709\u52A0\u8F7D\u4EFB\u52A1\u8BA1\u5212");if(e.includes(".")){let[r]=e.split("."),s=this.taskPlan.tasks.findIndex(a=>a.id===r);if(s<0||!this.taskPlan.tasks[s].subtasks)return!1;let o=e,n=this.taskPlan.tasks[s].subtasks.findIndex(a=>a.id===o);return n<0?!1:(this.taskPlan.tasks[s].subtasks.splice(n,1),this.logger.info(`\u5220\u9664\u5B50\u4EFB\u52A1 ${e}`),!0)}let t=this.taskPlan.tasks.findIndex(r=>r.id===e);return t<0?!1:(this.taskPlan.tasks.splice(t,1),this.taskPlan.tasks.forEach(r=>{r.dependencies=r.dependencies.filter(s=>s!==e)}),this.logger.info(`\u5220\u9664\u4EFB\u52A1 ${e}`),!0)}addSubtask(e,t){if(!this.taskPlan)throw new Error("\u6CA1\u6709\u52A0\u8F7D\u4EFB\u52A1\u8BA1\u5212");let r=this.taskPlan.tasks.find(s=>s.id===e);if(!r)throw new Error(`\u7236\u4EFB\u52A1 ${e} \u4E0D\u5B58\u5728`);return Array.isArray(r.subtasks)||(r.subtasks=[]),t.id||(t.id=`${e}.${r.subtasks.length+1}`),t.status||(t.status="todo"),r.subtasks.push(t),this.logger.info(`\u4E3A\u4EFB\u52A1 ${e} \u6DFB\u52A0\u5B50\u4EFB\u52A1 ${t.id}: ${t.name}`),t}getNextTasks(){if(!this.taskPlan)throw new Error("\u6CA1\u6709\u52A0\u8F7D\u4EFB\u52A1\u8BA1\u5212");return this.taskPlan.tasks.filter(t=>t.status!=="done"&&t.status!=="review").filter(t=>!t.dependencies||t.dependencies.length===0?!0:t.dependencies.every(r=>{let s=this.getTaskById(r);return s&&s.status==="done"}))}addDependency(e,t){if(!this.taskPlan)throw new Error("\u6CA1\u6709\u52A0\u8F7D\u4EFB\u52A1\u8BA1\u5212");let r=this.getTaskById(e);if(!r)throw new Error(`\u4EFB\u52A1 ${e} \u4E0D\u5B58\u5728`);if(!this.getTaskById(t))throw new Error(`\u4F9D\u8D56\u7684\u4EFB\u52A1 ${t} \u4E0D\u5B58\u5728`);if(e===t)throw new Error("\u4EFB\u52A1\u4E0D\u80FD\u4F9D\u8D56\u81EA\u8EAB");if(this.checkCircularDependency(t,e))throw new Error("\u6DFB\u52A0\u6B64\u4F9D\u8D56\u4F1A\u5BFC\u81F4\u5FAA\u73AF\u4F9D\u8D56");return Array.isArray(r.dependencies)||(r.dependencies=[]),r.dependencies.includes(t)?!1:(r.dependencies.push(t),this.logger.info(`\u4E3A\u4EFB\u52A1 ${e} \u6DFB\u52A0\u4F9D\u8D56: ${t}`),!0)}removeDependency(e,t){if(!this.taskPlan)throw new Error("\u6CA1\u6709\u52A0\u8F7D\u4EFB\u52A1\u8BA1\u5212");let r=this.getTaskById(e);if(!r||!Array.isArray(r.dependencies))return!1;let s=r.dependencies.indexOf(t);return s<0?!1:(r.dependencies.splice(s,1),this.logger.info(`\u4ECE\u4EFB\u52A1 ${e} \u79FB\u9664\u4F9D\u8D56: ${t}`),!0)}checkCircularDependency(e,t){if(!this.taskPlan)return!1;let r=new Map;this.taskPlan.tasks.forEach(c=>{r.set(c.id,[...c.dependencies||[]])});let s=r.get(e)||[];s.push(t),r.set(e,s);let o=new Set,n=new Set,a=u(c=>{if(n.has(c))return!0;if(o.has(c))return!1;o.add(c),n.add(c);let g=r.get(c)||[];for(let d of g)if(a(d))return!0;return n.delete(c),!1},"hasCycle");return a(e)}startAutoSave(e){this.autoSaveInterval&&clearInterval(this.autoSaveInterval),this.autoSaveInterval=setInterval(async()=>{if(this.taskPlan)try{await this.saveTaskPlan()}catch(t){this.logger.error(`\u81EA\u52A8\u4FDD\u5B58\u4EFB\u52A1\u8BA1\u5212\u5931\u8D25\uFF1A${t.message}`)}},e),this.logger.info(`\u542F\u52A8\u81EA\u52A8\u4FDD\u5B58\uFF0C\u95F4\u9694: ${e/1e3} \u79D2`)}stopAutoSave(){this.autoSaveInterval&&(clearInterval(this.autoSaveInterval),this.autoSaveInterval=null,this.logger.info("\u505C\u6B62\u81EA\u52A8\u4FDD\u5B58"))}destroy(){this.stopAutoSave()}}});var se,S=P(()=>{"use strict";se={models:{default:"baidu"},taskSettings:{outputDir:"./tasks",autoSave:!0,saveInterval:300},testSettings:{framework:"jest",outputDir:"./tests",coverage:!0},logger:{level:"info",output:"console"}}});var j,Re,gt,ve,pt=P(()=>{"use strict";j=m(require("fs")),Re=m(require("path")),gt=m(require("os"));S();ve=class{static{u(this,"SimpleConfigManager")}constructor(){this.configPath=Re.join(gt.homedir(),".taskflow-ai","config.json"),this.config=this.loadConfig()}loadConfig(){try{if(j.existsSync(this.configPath)){let e=j.readFileSync(this.configPath,"utf8");return JSON.parse(e)}}catch(e){console.warn(`\u52A0\u8F7D\u914D\u7F6E\u6587\u4EF6\u5931\u8D25: ${e.message}`)}return{models:{default:"deepseek",apiKeys:{},endpoints:{}},ui:{theme:"light",language:"zh-CN"},features:{autoSave:!0,notifications:!0}}}saveConfig(){try{let e=Re.dirname(this.configPath);j.existsSync(e)||j.mkdirSync(e,{recursive:!0}),j.writeFileSync(this.configPath,JSON.stringify(this.config,null,2))}catch(e){console.error(`\u4FDD\u5B58\u914D\u7F6E\u6587\u4EF6\u5931\u8D25: ${e.message}`)}}get(e,t){let r=e.split("."),s=this.config;for(let o of r)if(s&&typeof s=="object"&&s!==null&&o in s)s=s[o];else return t;return s}set(e,t){let r=e.split("."),s=this.config;for(let o=0;o<r.length-1;o++){let n=r[o];(!s[n]||typeof s[n]!="object")&&(s[n]={}),s=s[n]}s[r[r.length-1]]=t,this.saveConfig()}getAll(){return{...this.config}}update(e){this.config={...this.config,...e},this.saveConfig()}reset(){this.config=this.loadConfig()}getConfig(){return this.getAll()}updateConfig(e,t=!1){this.update(e)}getDefaultModelType(){return this.get("models.default","deepseek")}}});var mt={};ze(mt,{Logger:()=>E});var A,Ke,dt,E,W=P(()=>{"use strict";A=m(require("winston")),Ke=m(require("path")),dt=m(require("fs-extra")),E=class i{static{u(this,"Logger")}constructor(e){let t=Ke.default.join(process.env.HOME||process.env.USERPROFILE||".",".config","mcp","logs");dt.default.ensureDirSync(t);let r=e.file||Ke.default.join(t,"mcp.log"),s=A.default.format.combine(A.default.format.colorize(),A.default.format.timestamp(),A.default.format.printf(({timestamp:a,level:c,message:g})=>`${a} ${c}: ${g}`)),o=A.default.format.combine(A.default.format.timestamp(),A.default.format.json()),n=[];(e.output==="console"||e.output==="both")&&n.push(new A.default.transports.Console({format:s,level:e.level})),(e.output==="file"||e.output==="both")&&n.push(new A.default.transports.File({filename:r,format:o,level:e.level,maxsize:5242880,maxFiles:5})),this.logger=A.default.createLogger({level:e.level,levels:A.default.config.npm.levels,defaultMeta:{service:"mcp"},transports:n})}static getInstance(e){return i.instance||(i.instance=new i(e)),i.instance}updateConfig(e){i.instance=new i(e)}error(e,t){this.logger.error(e,t)}warn(e,t){this.logger.warn(e,t)}info(e,t){this.logger.info(e,t)}debug(e,t){this.logger.debug(e,t)}log(e,t,r){this.logger.log(e,t,r)}}});var F,pe=P(()=>{"use strict";F=class{static{u(this,"BaseModelAdapter")}constructor(e){this.modelType=e}getModelType(){return this.modelType}handleRequestError(e){if(e&&typeof e=="object"&&"response"in e){let t=e.response,r=t?.status,s=t?.data,o=`HTTP Error ${r}`;throw s&&typeof s=="object"&&(o+=`: ${JSON.stringify(s)}`),r===401||r===403?new Error(`\u8BA4\u8BC1\u5931\u8D25\uFF1A${o}\uFF0C\u8BF7\u68C0\u67E5API\u5BC6\u94A5\u662F\u5426\u6B63\u786E`):r===429?new Error(`\u8BF7\u6C42\u901F\u7387\u9650\u5236\uFF1A${o}\uFF0C\u8BF7\u7A0D\u540E\u91CD\u8BD5`):new Error(`API\u8C03\u7528\u5931\u8D25\uFF1A${o}`)}else if(e&&typeof e=="object"&&"request"in e){let t=e.message||"\u7F51\u7EDC\u9519\u8BEF";throw new Error(`\u8BF7\u6C42\u8D85\u65F6\u6216\u7F51\u7EDC\u9519\u8BEF\uFF1A${t}`)}else{let t=e?.message||"\u672A\u77E5\u9519\u8BEF";throw new Error(`\u8BF7\u6C42\u914D\u7F6E\u9519\u8BEF\uFF1A${t}`)}}}});var Me,De,ft=P(()=>{"use strict";Me=m(require("axios"));x();S();pe();De=class extends F{constructor(t){super("baidu");this.accessToken=null;this.tokenExpireTime=0;let r=t.get("models.baidu",{apiKey:"",secretKey:"",endpoint:"https://aip.baidubce.com/rpc/2.0/ai_custom/v1/wenxinworkshop/chat/",modelVersion:"ernie-bot-4"});if(this.apiKey=r.apiKey,this.secretKey=r.secretKey,this.endpoint=r.endpoint||"https://aip.baidubce.com/rpc/2.0/ai_custom/v1/wenxinworkshop/chat/",this.modelVersion=r.modelVersion||"ernie-bot-4",!this.apiKey||!this.secretKey)throw new Error("\u767E\u5EA6\u6587\u5FC3API\u5BC6\u94A5\u672A\u914D\u7F6E\uFF0C\u8BF7\u4F7F\u7528 mcp config \u547D\u4EE4\u8BBE\u7F6E model.baidu.apiKey \u548C model.baidu.secretKey")}static{u(this,"BaiduModelAdapter")}async chat(t,r){try{await this.ensureAccessToken();let s=this.buildRequestBody(t,r),o=`${this.endpoint}${this.modelVersion}?access_token=${this.accessToken}`,n=await Me.default.post(o,s,{headers:{"Content-Type":"application/json"},timeout:r?.timeout||3e4});return this.processResponse(n.data)}catch(s){return this.handleRequestError(s)}}async chatStream(t,r,s){try{await this.ensureAccessToken();let o=this.buildRequestBody(t,{...s,stream:!0}),n=`${this.endpoint}${this.modelVersion}?access_token=${this.accessToken}`,c=(await Me.default.post(n,o,{headers:{"Content-Type":"application/json"},responseType:"stream",timeout:s?.timeout||6e4})).data;return new Promise((g,d)=>{let w="";c.on("data",h=>{let D=h.toString();w+=D;let H=w.split(`
`);w=H.pop()||"";for(let _ of H)if(_.startsWith("data: ")){let K=_.substring(6);try{let X=JSON.parse(K);r(X.result,X.is_end||!1)}catch{}}}),c.on("end",()=>{r("",!0),g()}),c.on("error",h=>{d(h)})})}catch(o){return this.handleRequestError(o)}}async validateApiKey(){try{return await this.ensureAccessToken(),!!this.accessToken}catch{return!1}}buildRequestBody(t,r){return{messages:t.messages.map(o=>({role:this.mapRole(o.role),content:o.content})),temperature:r?.temperature??t.temperature??.7,top_p:t.topP??.8,stream:r?.stream??!1,user_id:"mcp-user"}}processResponse(t){return{content:t.result,finishReason:t.is_end?"stop":void 0,usage:t.usage?{promptTokens:t.usage.prompt_tokens,completionTokens:t.usage.completion_tokens,totalTokens:t.usage.total_tokens}:void 0}}mapRole(t){switch(t){case"user":return"user";case"assistant":return"assistant";case"system":return"system";default:return"user"}}async ensureAccessToken(){let t=Date.now();if(!(this.accessToken&&t<this.tokenExpireTime))try{let r=`https://aip.baidubce.com/oauth/2.0/token?grant_type=client_credentials&client_id=${this.apiKey}&client_secret=${this.secretKey}`,s=await Me.default.post(r);if(s.data&&s.data.access_token)this.accessToken=s.data.access_token,this.tokenExpireTime=t+(s.data.expires_in||2592e3)*1e3-864e5;else throw new Error("\u83B7\u53D6\u8BBF\u95EE\u4EE4\u724C\u5931\u8D25\uFF1A\u54CD\u5E94\u4E2D\u6CA1\u6709access_token\u5B57\u6BB5")}catch(r){throw this.accessToken=null,this.tokenExpireTime=0,new Error(`\u83B7\u53D6\u767E\u5EA6\u6587\u5FC3\u8BBF\u95EE\u4EE4\u724C\u5931\u8D25\uFF1A${r.message}`)}}}});var Ue,xe,ht=P(()=>{"use strict";Ue=m(require("axios"));x();S();pe();xe=class extends F{static{u(this,"DeepseekModelAdapter")}constructor(e){super("deepseek");let t=e.get("models.deepseek",{apiKey:"",endpoint:"https://api.deepseek.com/v1/chat/completions",modelVersion:"deepseek-chat"});if(this.apiKey=t.apiKey,this.endpoint=t.endpoint||"https://api.deepseek.com/v1/chat/completions",this.modelVersion=t.modelVersion||"deepseek-chat",!this.apiKey)throw new Error("DeepSeek API\u5BC6\u94A5\u672A\u914D\u7F6E\uFF0C\u8BF7\u4F7F\u7528 mcp config \u547D\u4EE4\u8BBE\u7F6E model.deepseek.apiKey")}async chat(e,t){try{let r=this.buildRequestBody(e,t),s=await Ue.default.post(this.endpoint,r,{headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`},timeout:t?.timeout||3e4});return this.processResponse(s.data)}catch(r){return this.handleRequestError(r)}}async chatStream(e,t,r){try{let s=this.buildRequestBody(e,{...r,stream:!0}),n=(await Ue.default.post(this.endpoint,s,{headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`},responseType:"stream",timeout:r?.timeout||6e4})).data;return new Promise((a,c)=>{let g="";n.on("data",d=>{let w=d.toString();g+=w;let h=g.split(`
`);g=h.pop()||"";for(let D of h)if(D.startsWith("data: ")){let H=D.substring(6);if(H==="[DONE]"){t("",!0);continue}try{let _=JSON.parse(H);if(_.choices&&_.choices.length>0){let K=_.choices[0].message?.content||"",X=_.choices[0].finish_reason==="stop";t(K,X)}}catch{}}}),n.on("end",()=>{t("",!0),a()}),n.on("error",d=>{c(d)})})}catch(s){return this.handleRequestError(s)}}async validateApiKey(){try{return await this.chat({messages:[{role:"user",content:"Hello"}],maxTokens:5},{temperature:.1}),!0}catch{return!1}}buildRequestBody(e,t){let r=e.messages.map(s=>({role:this.mapRole(s.role),content:s.content}));return{model:this.modelVersion,messages:r,temperature:t?.temperature??e.temperature??.7,top_p:e.topP??.8,max_tokens:t?.maxTokens??e.maxTokens??1024,stream:t?.stream??!1}}processResponse(e){if(!e.choices||e.choices.length===0)throw new Error("\u65E0\u6548\u7684\u54CD\u5E94\u683C\u5F0F\uFF1A\u6CA1\u6709\u8FD4\u56DEchoices\u5B57\u6BB5");let t=e.choices[0];return{content:t.message?.content||"",finishReason:t.finish_reason,usage:e.usage?{promptTokens:e.usage.prompt_tokens,completionTokens:e.usage.completion_tokens,totalTokens:e.usage.total_tokens}:void 0}}mapRole(e){switch(e){case"user":return"user";case"assistant":return"assistant";case"system":return"system";default:return"user"}}}});var Ve,yt,Ae,kt=P(()=>{"use strict";Ve=m(require("axios")),yt=m(require("crypto"));x();S();pe();Ae=class extends F{static{u(this,"ZhipuModelAdapter")}constructor(e){super("zhipu");let t=e.get("models.zhipu",{apiKey:"",endpoint:"https://open.bigmodel.cn/api/paas/v4/chat/completions",modelVersion:"glm-4"});if(this.apiKey=t.apiKey,this.endpoint=t.endpoint||"https://open.bigmodel.cn/api/paas/v4/chat/completions",this.modelVersion=t.modelVersion||"glm-4",!this.apiKey)throw new Error("\u667A\u8C31AI API\u5BC6\u94A5\u672A\u914D\u7F6E\uFF0C\u8BF7\u4F7F\u7528 yasi config \u547D\u4EE4\u8BBE\u7F6E model.zhipu.apiKey")}async chat(e,t){try{let r=this.buildRequestBody(e,t),s=this.generateAuthHeaders(),o=await Ve.default.post(this.endpoint,r,{headers:{"Content-Type":"application/json",Authorization:s.Authorization,Date:s.Date},timeout:t?.timeout||3e4});return this.processResponse(o.data)}catch(r){return this.handleRequestError(r)}}async chatStream(e,t,r){try{let s=this.buildRequestBody(e,{...r,stream:!0}),o=this.generateAuthHeaders(),a=(await Ve.default.post(this.endpoint,s,{headers:{"Content-Type":"application/json",Authorization:o.Authorization,Date:o.Date,Accept:"text/event-stream"},responseType:"stream",timeout:r?.timeout||6e4})).data;return new Promise((c,g)=>{let d="";a.on("data",w=>{let h=w.toString();d+=h;let D=d.split(`
`);d=D.pop()||"";for(let H of D)if(H.startsWith("data: ")){let _=H.substring(6);if(_==="[DONE]"){t("",!0);continue}try{let K=JSON.parse(_);if(K.choices&&K.choices.length>0){let X=K.choices[0].delta?.content||"",tr=K.choices[0].finish_reason==="stop";t(X,tr)}}catch{}}}),a.on("end",()=>{t("",!0),c()}),a.on("error",w=>{g(w)})})}catch(s){return this.handleRequestError(s)}}async validateApiKey(){try{return await this.chat({messages:[{role:"user",content:"Hello"}],maxTokens:5},{temperature:.1}),!0}catch{return!1}}buildRequestBody(e,t){let r=e.messages.map(s=>({role:this.mapRole(s.role),content:s.content}));return{model:this.modelVersion,messages:r,temperature:t?.temperature??e.temperature??.7,top_p:e.topP??.8,max_tokens:t?.maxTokens??e.maxTokens??1024,stream:t?.stream??!1}}processResponse(e){if(!e.choices||e.choices.length===0)throw new Error("\u65E0\u6548\u7684\u54CD\u5E94\u683C\u5F0F\uFF1A\u6CA1\u6709\u8FD4\u56DEchoices\u5B57\u6BB5");let t=e.choices[0];return{content:t.message?.content||"",finishReason:t.finish_reason,usage:e.usage?{promptTokens:e.usage.prompt_tokens,completionTokens:e.usage.completion_tokens,totalTokens:e.usage.total_tokens}:void 0}}mapRole(e){switch(e){case"user":return"user";case"assistant":return"assistant";case"system":return"system";default:return"user"}}generateAuthHeaders(){if(!this.apiKey.startsWith("zhipu-"))throw new Error('\u667A\u8C31AI API\u5BC6\u94A5\u683C\u5F0F\u4E0D\u6B63\u786E\uFF0C\u5E94\u4EE5"zhipu-"\u5F00\u5934');let[e,t]=this.apiKey.substring(6).split(".");if(!e||!t)throw new Error("\u667A\u8C31AI API\u5BC6\u94A5\u683C\u5F0F\u4E0D\u6B63\u786E\uFF0C\u65E0\u6CD5\u63D0\u53D6id\u548Csecret");let r=new Date().toUTCString(),s=`date: ${r}
POST /api/paas/v4/chat/completions HTTP/1.1`,o=yt.createHmac("sha256",t).update(s).digest("base64");return{Authorization:`hmac username="${e}", algorithm="hmac-sha256", headers="date request-line", signature="${o}"`,Date:r}}}});var Tt,Ie,bt=P(()=>{"use strict";Tt=m(require("axios"));S();x();pe();Ie=class extends F{static{u(this,"QwenModelAdapter")}constructor(e){super("qwen");let t=e.get("models.qwen");if(!t)throw new Error("Qwen\u6A21\u578B\u914D\u7F6E\u672A\u627E\u5230");this.apiKey=t.apiKey,this.endpoint=t.endpoint||"https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation",this.modelVersion=t.modelVersion||"qwen-turbo",this.client=Tt.default.create({baseURL:this.endpoint,headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json","X-DashScope-SSE":"disable"},timeout:3e4})}async chat(e,t){try{let r=this.buildRequestData(e),s=await this.client.post("",r);if(s.data.output&&s.data.output.text)return{content:s.data.output.text,usage:{promptTokens:s.data.usage?.input_tokens||0,completionTokens:s.data.usage?.output_tokens||0,totalTokens:s.data.usage?.total_tokens||0},finishReason:s.data.output.finish_reason||"stop"};throw new Error("Invalid response format from Qwen API")}catch(r){this.handleRequestError(r)}}async chatStream(e,t,r){try{let s={...this.buildRequestData(e),parameters:{...this.buildRequestData(e).parameters,incremental_output:!0}},o=await this.client.post("",s,{headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json","X-DashScope-SSE":"enable",Accept:"text/event-stream"},responseType:"stream"}),n="";o.data.on("data",a=>{n+=a.toString();let c=n.split(`
`);n=c.pop()||"";for(let g of c)if(g.startsWith("data: ")){let d=g.slice(6);if(d==="[DONE]"){t("",!0);return}try{let w=JSON.parse(d);w.output&&w.output.text&&t(w.output.text,!1)}catch{}}}),o.data.on("end",()=>{t("",!0)})}catch(s){this.handleRequestError(s)}}async validateApiKey(){try{let e={messages:[{role:"user",content:"Hello"}],maxTokens:10};return await this.chat(e),!0}catch{return!1}}buildRequestData(e){let t=e.messages.map(r=>({role:r.role,content:r.content}));return{model:this.modelVersion,input:{messages:t},parameters:{max_tokens:e.maxTokens||2e3,temperature:e.temperature||.7,top_p:e.topP||.9,repetition_penalty:1.1,result_format:"text"}}}}});var Oe,wt=P(()=>{"use strict";S();ft();ht();kt();bt();Oe=class{constructor(e){this.modelCache=new Map;this.configManager=e}static{u(this,"ModelFactory")}createModelAdapter(e){let t=e||this.configManager.getDefaultModelType(),r=this.modelCache.get(t);if(r)return r;let s;switch(t){case"baidu":s=new De(this.configManager);break;case"deepseek":s=new xe(this.configManager);break;case"zhipu":s=new Ae(this.configManager);break;case"qwen":s=new Ie(this.configManager);break;default:throw new Error(`\u4E0D\u652F\u6301\u7684\u6A21\u578B\u7C7B\u578B: ${t}`)}return this.modelCache.set(t,s),s}clearCache(e){e?this.modelCache.delete(e):this.modelCache.clear()}getAvailableModelTypes(){return["baidu","deepseek","zhipu"]}async validateModelApiKey(e){try{return await this.createModelAdapter(e).validateApiKey()}catch{return!1}}}});var $e,Pt=P(()=>{"use strict";wt();x();$e=class{static{u(this,"ModelCoordinator")}constructor(e){this.configManager=e,this.modelFactory=new Oe(e)}async chat(e,t,r){return await this.modelFactory.createModelAdapter(t).chat({messages:e},r)}async chatStream(e,t,r,s){return await this.modelFactory.createModelAdapter(r).chatStream({messages:e},t,s)}async parsePRD(e,t){let r=t?.modelType||this.configManager.getDefaultModelType(),s=`\u4F60\u662F\u4E00\u4F4D\u4E13\u4E1A\u7684PRD\u9700\u6C42\u5206\u6790\u5E08\uFF0C\u8BF7\u5E2E\u6211\u89E3\u6790\u4EE5\u4E0BPRD\u6587\u6863\uFF0C\u63D0\u53D6\u5176\u4E2D\u7684\u5173\u952E\u4FE1\u606F\u3002
\u8BF7\u6309\u7167\u4EE5\u4E0BJSON\u683C\u5F0F\u8F93\u51FA\u7ED3\u679C\uFF1A
{
  "title": "\u6587\u6863\u6807\u9898",
  "description": "\u6587\u6863\u6574\u4F53\u63CF\u8FF0",
  "sections": [
    {
      "title": "\u7AE0\u8282\u6807\u9898",
      "content": "\u7AE0\u8282\u5185\u5BB9\u6982\u8FF0",
      "level": \u7AE0\u8282\u5C42\u7EA7,
      "features": [
        {
          "name": "\u529F\u80FD\u540D\u79F0",
          "description": "\u529F\u80FD\u63CF\u8FF0",
          "priority": "\u4F18\u5148\u7EA7" // high, medium, low
        }
      ]
    }
  ]
}
\u53EA\u8FD4\u56DEJSON\u683C\u5F0F\u5185\u5BB9\uFF0C\u4E0D\u8981\u6709\u5176\u4ED6\u89E3\u91CA\u3002`,o=`\u4EE5\u4E0B\u662F\u9700\u8981\u89E3\u6790\u7684PRD\u6587\u6863\u5185\u5BB9\uFF1A

${e}

\u8BF7\u89E3\u6790\u8FD9\u4EFD\u6587\u6863\uFF0C\u6309\u7167\u8981\u6C42\u7684JSON\u683C\u5F0F\u8FD4\u56DE\u7ED3\u679C\u3002`,n=[{role:"system",content:s},{role:"user",content:o}];return await this.chat(n,r)}async planTasks(e,t){let r=t?.modelType||this.configManager.getDefaultModelType(),s=`\u4F60\u662F\u4E00\u4F4D\u4E13\u4E1A\u7684\u9879\u76EE\u89C4\u5212\u5E08\uFF0C\u8BF7\u6839\u636E\u89E3\u6790\u540E\u7684PRD\u5185\u5BB9\uFF0C\u751F\u6210\u8BE6\u7EC6\u7684\u4EFB\u52A1\u8BA1\u5212\u3002
\u8BF7\u6309\u7167\u4EE5\u4E0B\u8981\u6C42\u62C6\u5206\u4EFB\u52A1\uFF1A
1. \u5C06\u5927\u7684\u529F\u80FD\u9700\u6C42\u62C6\u5206\u4E3A\u66F4\u5C0F\u7684\u53EF\u6267\u884C\u5B50\u4EFB\u52A1
2. \u4E3A\u6BCF\u4E2A\u4EFB\u52A1\u5206\u914D\u5408\u7406\u7684\u4F18\u5148\u7EA7\u548C\u7C7B\u578B\u6807\u7B7E
3. \u786E\u5B9A\u4EFB\u52A1\u4E4B\u95F4\u7684\u4F9D\u8D56\u5173\u7CFB
4. ${t?.estimateDuration?"\u4F30\u7B97\u6BCF\u4E2A\u4EFB\u52A1\u7684\u5B8C\u6210\u65F6\u95F4\uFF08\u4EE5\u5C0F\u65F6\u4E3A\u5355\u4F4D\uFF09":""}
5. ${t?.assignTasks?"\u4E3A\u6BCF\u4E2A\u4EFB\u52A1\u5206\u914D\u5408\u9002\u7684\u89D2\u8272":""}

\u8BF7\u6309\u7167\u4EE5\u4E0BJSON\u683C\u5F0F\u8F93\u51FA\u7ED3\u679C\uFF1A
{
  "name": "\u9879\u76EE\u540D\u79F0",
  "description": "\u9879\u76EE\u63CF\u8FF0",
  "tasks": [
    {
      "id": "\u552F\u4E00ID",
      "name": "\u4EFB\u52A1\u540D\u79F0",
      "description": "\u4EFB\u52A1\u63CF\u8FF0",
      "priority": "\u4F18\u5148\u7EA7", // high, medium, low
      "type": "\u4EFB\u52A1\u7C7B\u578B", // feature, bug_fix, refactor, test, document
      "dependencies": ["\u4F9D\u8D56\u4EFB\u52A1ID"],
      ${t?.estimateDuration?'"estimatedDuration": \u9884\u8BA1\u8017\u65F6\uFF08\u5C0F\u65F6\uFF09,':""}
      ${t?.assignTasks?'"assignee": "\u8D1F\u8D23\u89D2\u8272",':""}
      "subtasks": [
        // \u5B50\u4EFB\u52A1\uFF0C\u7ED3\u6784\u4E0E\u7236\u4EFB\u52A1\u76F8\u540C
      ]
    }
  ]
}
\u53EA\u8FD4\u56DEJSON\u683C\u5F0F\u5185\u5BB9\uFF0C\u4E0D\u8981\u6709\u5176\u4ED6\u89E3\u91CA\u3002`,o=`\u4EE5\u4E0B\u662F\u89E3\u6790\u540E\u7684PRD\u5185\u5BB9\uFF1A

${JSON.stringify(e,null,2)}

${t?.taskTemplate?`\u8BF7\u53C2\u8003\u4EE5\u4E0B\u4EFB\u52A1\u6A21\u677F\u8FDB\u884C\u89C4\u5212\uFF1A
${t.taskTemplate}`:""}

\u8BF7\u751F\u6210\u8BE6\u7EC6\u7684\u4EFB\u52A1\u8BA1\u5212\uFF0C\u6309\u7167\u8981\u6C42\u7684JSON\u683C\u5F0F\u8FD4\u56DE\u7ED3\u679C\u3002`,n=[{role:"system",content:s},{role:"user",content:o}];return await this.chat(n,r)}async generateTests(e,t){let r=t?.modelType||this.configManager.getDefaultModelType(),o=`\u4F60\u662F\u4E00\u4F4D\u4E13\u4E1A\u7684\u6D4B\u8BD5\u5DE5\u7A0B\u5E08\uFF0C\u8BF7\u6839\u636E\u4EFB\u52A1\u63CF\u8FF0\uFF0C\u751F\u6210\u8BE6\u7EC6\u7684\u6D4B\u8BD5\u7528\u4F8B\u3002
\u8BF7\u4F7F\u7528 ${t?.framework||this.configManager.get("testSettings.framework","jest")} \u6D4B\u8BD5\u6846\u67B6\u7F16\u5199\u6D4B\u8BD5\u4EE3\u7801\u3002
\u8981\u6C42\uFF1A
1. \u6D4B\u8BD5\u9700\u8981\u8986\u76D6\u6B63\u5E38\u529F\u80FD\u8DEF\u5F84
2. ${t?.includeEdgeCases?"\u6D4B\u8BD5\u9700\u8981\u8986\u76D6\u8FB9\u754C\u6761\u4EF6\u548C\u5F02\u5E38\u60C5\u51B5":""}
3. ${t?.mockDependencies?"\u4F7F\u7528mock/stub\u5904\u7406\u5916\u90E8\u4F9D\u8D56":""}
4. \u6D4B\u8BD5\u4EE3\u7801\u5E94\u8BE5\u6E05\u6670\u53EF\u8BFB\uFF0C\u5305\u542B\u5FC5\u8981\u7684\u6CE8\u91CA
5. \u9075\u5FAA\u6D4B\u8BD5\u6846\u67B6\u7684\u6700\u4F73\u5B9E\u8DF5

\u8BF7\u8F93\u51FA\u5B8C\u6574\u53EF\u6267\u884C\u7684\u6D4B\u8BD5\u4EE3\u7801\u3002`,n=`\u4EE5\u4E0B\u662F\u9700\u8981\u7F16\u5199\u6D4B\u8BD5\u7528\u4F8B\u7684\u4EFB\u52A1\u63CF\u8FF0\uFF1A

${e}

\u8BF7\u4E3A\u6B64\u4EFB\u52A1\u751F\u6210\u6D4B\u8BD5\u7528\u4F8B\u3002`,a=[{role:"system",content:o},{role:"user",content:n}];return await this.chat(a,r)}getAvailableModelTypes(){return this.modelFactory.getAvailableModelTypes()}async validateModelApiKey(e){return await this.modelFactory.validateModelApiKey(e)}}});var oe,v,$,z=P(()=>{"use strict";pt();W();Pt();Pe();Se();re();x();S();oe=class{static{u(this,"TaskFlowService")}constructor(){this.configManager=new ve,this.logger=E.getInstance({level:this.configManager.get("logger.level","info"),output:this.configManager.get("logger.output","console"),file:this.configManager.get("logger.file")}),this.modelCoordinator=new $e(this.configManager),this.prdParser=new ee(this.modelCoordinator,this.logger),this.taskPlanner=new te(this.modelCoordinator,this.logger),this.taskManager=new N(this.logger,this.configManager),this.logger.info("TaskFlow AI MCP\u670D\u52A1\u521D\u59CB\u5316\u5B8C\u6210")}async parsePRD(e,t="markdown",r){try{return this.logger.info("\u5F00\u59CB\u89E3\u6790PRD\u5185\u5BB9"),{success:!0,data:await this.prdParser.parseContent(e,t,r)}}catch(s){return this.logger.error(`\u89E3\u6790PRD\u5185\u5BB9\u5931\u8D25: ${s.message}`),{success:!1,error:s.message}}}async parsePRDFromFile(e,t){try{return this.logger.info(`\u5F00\u59CB\u89E3\u6790PRD\u6587\u4EF6: ${e}`),{success:!0,data:await this.prdParser.parseFromFile(e,t)}}catch(r){return this.logger.error(`\u89E3\u6790PRD\u6587\u4EF6\u5931\u8D25: ${r.message}`),{success:!1,error:r.message}}}async generateTaskPlan(e,t){try{return this.logger.info("\u5F00\u59CB\u751F\u6210\u4EFB\u52A1\u8BA1\u5212"),{success:!0,data:await this.taskPlanner.generateTaskPlan(e,t)}}catch(r){return this.logger.error(`\u751F\u6210\u4EFB\u52A1\u8BA1\u5212\u5931\u8D25: ${r.message}`),{success:!1,error:r.message}}}async saveTaskPlan(e,t){try{return await this.taskPlanner.saveTaskPlan(e,t),this.taskManager.setTaskPlan(e),{success:!0}}catch(r){return this.logger.error(`\u4FDD\u5B58\u4EFB\u52A1\u8BA1\u5212\u5931\u8D25: ${r.message}`),{success:!1,error:r.message}}}async loadTaskPlan(e){try{return{success:!0,data:await this.taskManager.loadTaskPlan(e)}}catch(t){return this.logger.error(`\u52A0\u8F7D\u4EFB\u52A1\u8BA1\u5212\u5931\u8D25: ${t.message}`),{success:!1,error:t.message}}}getAllTasks(){try{return{success:!0,data:this.taskManager.getAllTasks()}}catch(e){return this.logger.error(`\u83B7\u53D6\u6240\u6709\u4EFB\u52A1\u5931\u8D25: ${e.message}`),{success:!1,error:e.message}}}getTaskById(e){try{let t=this.taskManager.getTaskById(e);return t?{success:!0,data:t}:{success:!1,error:`\u4EFB\u52A1 ${e} \u4E0D\u5B58\u5728`}}catch(t){return this.logger.error(`\u83B7\u53D6\u4EFB\u52A1\u5931\u8D25: ${t.message}`),{success:!1,error:t.message}}}filterTasks(e){try{return{success:!0,data:this.taskManager.filterTasks(e)}}catch(t){return this.logger.error(`\u8FC7\u6EE4\u4EFB\u52A1\u5931\u8D25: ${t.message}`),{success:!1,error:t.message}}}updateTask(e,t){try{let r=this.taskManager.updateTask(e,t);return r?{success:!0,data:r}:{success:!1,error:`\u4EFB\u52A1 ${e} \u4E0D\u5B58\u5728`}}catch(r){return this.logger.error(`\u66F4\u65B0\u4EFB\u52A1\u5931\u8D25: ${r.message}`),{success:!1,error:r.message}}}getNextTasks(){try{return{success:!0,data:this.taskManager.getNextTasks()}}catch(e){return this.logger.error(`\u83B7\u53D6\u4E0B\u4E00\u4E2A\u4EFB\u52A1\u5931\u8D25: ${e.message}`),{success:!1,error:e.message}}}async chat(e,t,r){try{return{success:!0,data:await this.modelCoordinator.chat(e,t,r)}}catch(s){return this.logger.error(`\u804A\u5929\u8BF7\u6C42\u5931\u8D25: ${s.message}`),{success:!1,error:s.message}}}getAvailableModelTypes(){try{return{success:!0,data:this.modelCoordinator.getAvailableModelTypes()}}catch(e){return this.logger.error(`\u83B7\u53D6\u53EF\u7528\u6A21\u578B\u7C7B\u578B\u5931\u8D25: ${e.message}`),{success:!1,error:e.message}}}async validateModelApiKey(e){try{return{success:!0,data:{valid:await this.modelCoordinator.validateModelApiKey(e)}}}catch(t){return this.logger.error(`\u9A8C\u8BC1\u6A21\u578BAPI\u5BC6\u94A5\u5931\u8D25: ${t.message}`),{success:!1,error:t.message}}}updateConfig(e,t=!1){try{return this.configManager.updateConfig(e,t),e.logger&&this.logger.updateConfig({level:this.configManager.get("logger.level","info"),output:this.configManager.get("logger.output","console"),file:this.configManager.get("logger.file")}),{success:!0}}catch(r){return this.logger.error(`\u66F4\u65B0\u914D\u7F6E\u5931\u8D25: ${r.message}`),{success:!1,error:r.message}}}getConfig(){try{let t={...this.configManager.getConfig()};if(t.models){let r=t.models;Object.keys(r).forEach(s=>{if(s!=="default"&&r[s]){let o=r[s];o&&o.apiKey&&(o.apiKey="******"),o&&o.secretKey&&(o.secretKey="******")}})}return{success:!0,data:t}}catch(e){return this.logger.error(`\u83B7\u53D6\u914D\u7F6E\u5931\u8D25: ${e.message}`),{success:!1,error:e.message}}}getTaskStatus(){try{let e=this.taskManager.getAllTasks();return{success:!0,data:{total:e.length,pending:e.filter(r=>r.status==="pending").length,in_progress:e.filter(r=>r.status==="in_progress").length,completed:e.filter(r=>r.status==="completed").length,cancelled:e.filter(r=>r.status==="cancelled").length}}}catch(e){return this.logger.error(`\u83B7\u53D6\u4EFB\u52A1\u72B6\u6001\u5931\u8D25: ${e.message}`),{success:!1,error:e.message}}}updateTaskStatus(e,t,r){try{let s={status:t};r&&Object.assign(s,r);let o=this.taskManager.updateTask(e,s);return o?{success:!0,data:o}:{success:!1,error:`\u4EFB\u52A1 ${e} \u4E0D\u5B58\u5728`}}catch(s){return this.logger.error(`\u66F4\u65B0\u4EFB\u52A1\u72B6\u6001\u5931\u8D25: ${s.message}`),{success:!1,error:s.message}}}getRecommendedTask(){try{let e=this.taskManager.getNextTasks();return{success:!0,data:e.length>0?e[0]:null}}catch(e){return this.logger.error(`\u83B7\u53D6\u63A8\u8350\u4EFB\u52A1\u5931\u8D25: ${e.message}`),{success:!1,error:e.message}}}async generateVisualization(e,t){try{return{success:!0,data:{type:e,data:this.taskManager.getAllTasks(),options:t,generatedAt:new Date().toISOString()}}}catch(r){return this.logger.error(`\u751F\u6210\u53EF\u89C6\u5316\u5931\u8D25: ${r.message}`),{success:!1,error:r.message}}}async createProject(e){try{return{success:!0,data:{id:`project_${Date.now()}`,...e,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),status:"active"}}}catch(t){return this.logger.error(`\u521B\u5EFA\u9879\u76EE\u5931\u8D25: ${t.message}`),{success:!1,error:t.message}}}async getProjects(e){try{return{success:!0,data:[{id:"project_1",name:"\u793A\u4F8B\u9879\u76EE",description:"\u8FD9\u662F\u4E00\u4E2A\u793A\u4F8B\u9879\u76EE",status:"active",createdAt:new Date().toISOString()}]}}catch(t){return this.logger.error(`\u83B7\u53D6\u9879\u76EE\u5217\u8868\u5931\u8D25: ${t.message}`),{success:!1,error:t.message}}}async getProject(e){try{return{success:!0,data:{id:e,name:"\u793A\u4F8B\u9879\u76EE",description:"\u8FD9\u662F\u4E00\u4E2A\u793A\u4F8B\u9879\u76EE",status:"active",createdAt:new Date().toISOString(),tasks:this.taskManager.getAllTasks()}}}catch(t){return this.logger.error(`\u83B7\u53D6\u9879\u76EE\u8BE6\u60C5\u5931\u8D25: ${t.message}`),{success:!1,error:t.message}}}async updateProject(e,t){try{return{success:!0,data:{id:e,...t,updatedAt:new Date().toISOString()}}}catch(r){return this.logger.error(`\u66F4\u65B0\u9879\u76EE\u5931\u8D25: ${r.message}`),{success:!1,error:r.message}}}async deleteProject(e){try{return{success:!0,message:`\u9879\u76EE ${e} \u5DF2\u5220\u9664`}}catch(t){return this.logger.error(`\u5220\u9664\u9879\u76EE\u5931\u8D25: ${t.message}`),{success:!1,error:t.message}}}async getProjectTasks(e,t){try{return{success:!0,data:this.taskManager.getAllTasks()}}catch(r){return this.logger.error(`\u83B7\u53D6\u9879\u76EE\u4EFB\u52A1\u5931\u8D25: ${r.message}`),{success:!1,error:r.message}}}async getProjectStats(e){try{let t=this.taskManager.getAllTasks();return{success:!0,data:{totalTasks:t.length,completedTasks:t.filter(s=>s.status==="completed").length,inProgressTasks:t.filter(s=>s.status==="in_progress").length,pendingTasks:t.filter(s=>s.status==="pending").length}}}catch(t){return this.logger.error(`\u83B7\u53D6\u9879\u76EE\u7EDF\u8BA1\u5931\u8D25: ${t.message}`),{success:!1,error:t.message}}}async generateTasks(e,t){try{let{requirements:r,options:s}=e.body;return{success:!0,data:[{id:`task_${Date.now()}`,title:"\u793A\u4F8B\u4EFB\u52A1",description:"\u57FA\u4E8E\u9700\u6C42\u751F\u6210\u7684\u793A\u4F8B\u4EFB\u52A1",status:"pending",priority:"medium"}]}}catch(r){return this.logger.error(`\u751F\u6210\u4EFB\u52A1\u5931\u8D25: ${r.message}`),{success:!1,error:r.message}}}async orchestrateTasks(e,t){try{let{tasks:r,options:s}=e.body;return{success:!0,data:r.map((n,a)=>({...n,order:a+1,dependencies:a>0?[r[a-1].id]:[]}))}}catch(r){return this.logger.error(`\u7F16\u6392\u4EFB\u52A1\u5931\u8D25: ${r.message}`),{success:!1,error:r.message}}}async generateDocuments(e,t){try{let{type:r,content:s,options:o}=e.body;return{success:!0,data:{type:r,content:`\u751F\u6210\u7684${r}\u6587\u6863\u5185\u5BB9`,generatedAt:new Date().toISOString()}}}catch(r){return this.logger.error(`\u751F\u6210\u6587\u6863\u5931\u8D25: ${r.message}`),{success:!1,error:r.message}}}async generateCharts(e,t){try{let{type:r,data:s,options:o}=e.body;return{success:!0,data:{type:r,data:s||this.taskManager.getAllTasks(),options:o,generatedAt:new Date().toISOString()}}}catch(r){return this.logger.error(`\u751F\u6210\u56FE\u8868\u5931\u8D25: ${r.message}`),{success:!1,error:r.message}}}async chatStream(e,t){try{let{message:r,context:s}=e.body;t.writeHead(200,{"Content-Type":"text/plain","Transfer-Encoding":"chunked"});let o=`AI\u56DE\u590D: ${r}`;t.write(o),t.end()}catch(r){this.logger.error(`\u804A\u5929\u6D41\u5F0F\u54CD\u5E94\u5931\u8D25: ${r.message}`),t.status(500).json({success:!1,error:r.message})}}async getModels(e,t){try{return{success:!0,data:this.modelCoordinator.getAvailableModelTypes()}}catch(r){return this.logger.error(`\u83B7\u53D6\u6A21\u578B\u5217\u8868\u5931\u8D25: ${r.message}`),{success:!1,error:r.message}}}async getModelStatus(e,t){try{let{modelType:r}=e.params,s=await this.modelCoordinator.validateModelApiKey(r);return{success:!0,data:{modelType:r,status:s?"active":"inactive"}}}catch(r){return this.logger.error(`\u83B7\u53D6\u6A21\u578B\u72B6\u6001\u5931\u8D25: ${r.message}`),{success:!1,error:r.message}}}async validateRequirements(e,t){try{let{requirements:r}=e.body;return{success:!0,data:{valid:!0,issues:[],suggestions:["\u5EFA\u8BAE\u6DFB\u52A0\u66F4\u591A\u7EC6\u8282"]}}}catch(r){return this.logger.error(`\u9A8C\u8BC1\u9700\u6C42\u5931\u8D25: ${r.message}`),{success:!1,error:r.message}}}async estimateEffort(e,t){try{let{tasks:r}=e.body;return{success:!0,data:{totalHours:r.length*8,breakdown:r.map(o=>({taskId:o.id,estimatedHours:8}))}}}catch(r){return this.logger.error(`\u4F30\u7B97\u5DE5\u4F5C\u91CF\u5931\u8D25: ${r.message}`),{success:!1,error:r.message}}}async getUsageStats(e,t){try{return{success:!0,data:{totalRequests:100,successfulRequests:95,failedRequests:5,averageResponseTime:1.2}}}catch(r){return this.logger.error(`\u83B7\u53D6\u4F7F\u7528\u7EDF\u8BA1\u5931\u8D25: ${r.message}`),{success:!1,error:r.message}}}async archiveProject(e,t){try{let{id:r}=e.params;return{success:!0,data:{id:r,status:"archived",archivedAt:new Date().toISOString()}}}catch(r){return this.logger.error(`\u5F52\u6863\u9879\u76EE\u5931\u8D25: ${r.message}`),{success:!1,error:r.message}}}async restoreProject(e,t){try{let r;return typeof e=="string"?r=e:r=e.params.id,{success:!0,data:{id:r,status:"active",restoredAt:new Date().toISOString()}}}catch(r){return this.logger.error(`\u6062\u590D\u9879\u76EE\u5931\u8D25: ${r.message}`),{success:!1,error:r.message}}}async generateProjectReport(e,t){try{let r=await this.getProject(e),s=this.taskManager.getAllTasks(),o=await this.getProjectStats(e);return{success:!0,data:{project:r.data,tasks:s,statistics:o.data,generatedAt:new Date().toISOString(),format:t?.format||"json"}}}catch(r){return this.logger.error(`\u751F\u6210\u9879\u76EE\u62A5\u544A\u5931\u8D25: ${r.message}`),{success:!1,error:r.message}}}async exportProject(e,t){try{let r=await this.getProject(e),s=this.taskManager.getAllTasks();return{success:!0,data:{project:r.data,tasks:s,exportedAt:new Date().toISOString(),format:t}}}catch(r){return this.logger.error(`\u5BFC\u51FA\u9879\u76EE\u5931\u8D25: ${r.message}`),{success:!1,error:r.message}}}async cloneProject(e,t){try{let r=await this.getProject(e);if(!r.success||!r.data)throw new Error("\u539F\u9879\u76EE\u4E0D\u5B58\u5728\u6216\u83B7\u53D6\u5931\u8D25");return{success:!0,data:{id:`project_${Date.now()}`,name:t.name||`${r.data.name} (\u526F\u672C)`,description:t.description||r.data.description,clonedFrom:e,createdAt:new Date().toISOString()}}}catch(r){return this.logger.error(`\u514B\u9686\u9879\u76EE\u5931\u8D25: ${r.message}`),{success:!1,error:r.message}}}},v=new oe,$=v});var At,Xe,It,Ot,$t,_t,Nt=P(()=>{"use strict";At={DEEPSEEK_API_KEY:"${DEEPSEEK_API_KEY}",ZHIPU_API_KEY:"${ZHIPU_API_KEY}",QWEN_API_KEY:"${QWEN_API_KEY}",BAIDU_API_KEY:"${BAIDU_API_KEY}",BAIDU_SECRET_KEY:"${BAIDU_SECRET_KEY}",MOONSHOT_API_KEY:"${MOONSHOT_API_KEY}",SPARK_APP_ID:"${SPARK_APP_ID}",SPARK_API_KEY:"${SPARK_API_KEY}",SPARK_API_SECRET:"${SPARK_API_SECRET}",TASKFLOW_PROJECT_ROOT:"${workspaceFolder}",TASKFLOW_CONFIG_PATH:".taskflow/config.json",TASKFLOW_LOG_LEVEL:"info",TASKFLOW_CACHE_ENABLED:"true",TASKFLOW_AUTO_START:"true"},Xe={resources:!0,tools:!0,prompts:!0,streaming:!0},It={cursor:".cursor/mcp.json",windsurf:".windsurf/mcp.json",trae:".trae/mcp-config.json",vscode:".vscode/settings.json"},Ot={cursor:null,windsurf:null,trae:null,vscode:".vscode/extensions.json"},$t={recommendations:["taskflow-ai.vscode-taskflow","ms-vscode.vscode-typescript-next","esbenp.prettier-vscode","ms-vscode.vscode-eslint","bradlc.vscode-tailwindcss","ms-vscode.vscode-json","yzhang.markdown-all-in-one"],unwantedRecommendations:["ms-vscode.vscode-typescript"]},_t=`# TaskFlow AI Cursor \u96C6\u6210\u89C4\u5219

## \u9879\u76EE\u914D\u7F6E
- \u4F7F\u7528 TaskFlow AI \u8FDB\u884C\u667A\u80FD PRD \u89E3\u6790\u548C\u4EFB\u52A1\u7BA1\u7406
- \u652F\u6301 6 \u79CD AI \u6A21\u578B\uFF1ADeepSeek\u3001\u667A\u8C31AI\u3001\u901A\u4E49\u5343\u95EE\u3001\u6587\u5FC3\u4E00\u8A00\u3001\u6708\u4E4B\u6697\u9762\u3001\u8BAF\u98DE\u661F\u706B
- MCP \u670D\u52A1\u7AEF\u70B9\uFF1A\u901A\u8FC7\u914D\u7F6E\u6587\u4EF6\u81EA\u52A8\u542F\u52A8

## AI \u6A21\u578B\u4F7F\u7528\u7B56\u7565
- **DeepSeek**: \u4EE3\u7801\u751F\u6210\u3001\u91CD\u6784\u3001\u6280\u672F\u5206\u6790
- **\u667A\u8C31AI**: \u4E2D\u6587\u5185\u5BB9\u5904\u7406\u3001\u4E1A\u52A1\u903B\u8F91\u5206\u6790
- **\u901A\u4E49\u5343\u95EE**: \u901A\u7528\u5206\u6790\u3001\u6587\u6863\u5904\u7406
- **\u6587\u5FC3\u4E00\u8A00**: \u521B\u610F\u4EFB\u52A1\u3001\u5185\u5BB9\u4F18\u5316
- **\u6708\u4E4B\u6697\u9762**: \u957F\u6587\u6863\u5904\u7406\u3001\u6DF1\u5EA6\u5206\u6790
- **\u8BAF\u98DE\u661F\u706B**: \u591A\u6A21\u6001\u4EFB\u52A1\u3001\u7EFC\u5408\u5904\u7406

## \u5DE5\u4F5C\u6D41\u7A0B
1. PRD \u89E3\u6790 \u2192 \u667A\u8C31AI \u5904\u7406\u4E2D\u6587\u9700\u6C42
2. \u67B6\u6784\u8BBE\u8BA1 \u2192 DeepSeek \u6280\u672F\u65B9\u6848\u8BBE\u8BA1
3. \u4EE3\u7801\u5B9E\u73B0 \u2192 DeepSeek \u4EE3\u7801\u751F\u6210\u548C\u4F18\u5316
4. \u6D4B\u8BD5\u7F16\u5199 \u2192 DeepSeek \u6D4B\u8BD5\u7528\u4F8B\u751F\u6210
5. \u6587\u6863\u751F\u6210 \u2192 \u901A\u4E49\u5343\u95EE \u6280\u672F\u6587\u6863\u7F16\u5199

## \u4EE3\u7801\u89C4\u8303
- \u4E25\u683C TypeScript \u7C7B\u578B\u5B89\u5168
- \u51FD\u6570\u5F0F\u7F16\u7A0B\u4F18\u5148
- 80%+ \u6D4B\u8BD5\u8986\u76D6\u7387
- ESLint + Prettier \u4EE3\u7801\u683C\u5F0F\u5316

## \u96C6\u6210\u529F\u80FD
- \u81EA\u52A8 PRD \u89E3\u6790\u548C\u4EFB\u52A1\u521B\u5EFA
- \u667A\u80FD\u4EE3\u7801\u751F\u6210\u548C\u91CD\u6784
- \u591A\u6A21\u578B\u534F\u540C\u5DE5\u4F5C
- \u5B9E\u65F6\u4EFB\u52A1\u72B6\u6001\u540C\u6B65

## \u6027\u80FD\u4F18\u5316
- \u542F\u7528 MCP \u8BF7\u6C42\u7F13\u5B58
- \u4F7F\u7528\u6D41\u5F0F\u54CD\u5E94\u63D0\u5347\u7528\u6237\u4F53\u9A8C
- \u667A\u80FD\u6A21\u578B\u9009\u62E9\u51CF\u5C11\u5EF6\u8FDF
- \u6279\u91CF\u5904\u7406\u76F8\u4F3C\u8BF7\u6C42

## \u5B89\u5168\u8003\u8651
- API \u5BC6\u94A5\u901A\u8FC7\u73AF\u5883\u53D8\u91CF\u7BA1\u7406
- \u654F\u611F\u4FE1\u606F\u4E0D\u5199\u5165\u4EE3\u7801
- \u4F7F\u7528 HTTPS \u8FDB\u884C API \u901A\u4FE1
- \u5B9A\u671F\u8F6E\u6362 API \u5BC6\u94A5
`});var Y,ae,Fe,Ft=P(()=>{"use strict";Y=require("fs"),ae=require("path");Nt();Fe=class{static{u(this,"MCPConfigGenerator")}constructor(e){this.logger=e}generateMCPConfig(e,t={}){let r={editor:e,serverConfig:{command:"npx",args:["-y","--package=taskflow-ai","taskflow-mcp"],timeout:t.timeout||3e4,retries:t.retries||3},capabilities:Xe,environment:{...At,...t.customEnvironment}};return this.logger.debug(`\u751F\u6210 ${e} MCP\u914D\u7F6E`,{editor:e,config:JSON.stringify(r,null,2)}),r}validateMCPConfig(e){let t=[],r=[];["windsurf","trae","cursor","vscode"].includes(e.editor)||t.push(`\u4E0D\u652F\u6301\u7684\u7F16\u8F91\u5668\u7C7B\u578B: ${e.editor}`),e.serverConfig.command||t.push("\u7F3A\u5C11\u670D\u52A1\u5668\u542F\u52A8\u547D\u4EE4"),Array.isArray(e.serverConfig.args)||t.push("\u670D\u52A1\u5668\u53C2\u6570\u5FC5\u987B\u662F\u6570\u7EC4");let s=["DEEPSEEK_API_KEY","ZHIPU_API_KEY","QWEN_API_KEY"];for(let n of s)e.environment[n]||r.push(`\u7F3A\u5C11\u73AF\u5883\u53D8\u91CF: ${n}`);!e.capabilities.tools&&!e.capabilities.resources&&r.push("\u5EFA\u8BAE\u81F3\u5C11\u542F\u7528tools\u6216resources\u80FD\u529B");let o={valid:t.length===0,errors:t.length>0?t:void 0,warnings:r.length>0?r:void 0};return this.logger.debug("MCP\u914D\u7F6E\u9A8C\u8BC1\u7ED3\u679C",{isValid:o.valid,errorCount:o.errors?.length||0,warningCount:o.warnings?.length||0,errors:o.errors,warnings:o.warnings}),o}exportMCPConfig(e){let t;switch(e.editor){case"cursor":t=this.generateCursorConfig(e);break;case"windsurf":t=this.generateWindsurfConfig(e);break;case"trae":t=this.generateTraeConfig(e);break;case"vscode":t=this.generateVSCodeConfig(e);break;default:throw new Error(`\u4E0D\u652F\u6301\u7684\u7F16\u8F91\u5668\u7C7B\u578B: ${e.editor}`)}return JSON.stringify(t,null,2)}generateCursorConfig(e){return{mcpServers:{"taskflow-ai":{command:e.serverConfig.command,args:e.serverConfig.args,env:e.environment}}}}generateWindsurfConfig(e){return{mcpServers:{"taskflow-ai":{command:e.serverConfig.command,args:e.serverConfig.args,env:e.environment,capabilities:e.capabilities,timeout:e.serverConfig.timeout,retries:e.serverConfig.retries}}}}generateTraeConfig(e){return{mcp:{version:"1.0",servers:{taskflow:{command:e.serverConfig.command,args:e.serverConfig.args,environment:e.environment,capabilities:["code_analysis","task_management","prd_parsing","ai_assistance","refactoring","optimization"],healthCheck:{enabled:!0,interval:3e4,timeout:5e3}}},client:{name:"trae",version:"1.0.0",features:{streaming:!0,contextWindow:32e3,multiModel:!0,codeCompletion:!0,semanticSearch:!0}}}}}generateVSCodeConfig(e){return{"taskflow.mcp.enabled":!0,"taskflow.mcp.server":{command:e.serverConfig.command,args:e.serverConfig.args,env:this.convertToVSCodeEnv(e.environment),autoRestart:!0,healthCheck:!0},"taskflow.ai.models":{primary:"deepseek",fallback:["zhipu","qwen","baidu"],specialized:{code:"deepseek",chinese:"zhipu",general:"qwen",creative:"baidu",longText:"moonshot",multimodal:"spark"},loadBalancing:{enabled:!0,strategy:"intelligent",weights:{deepseek:.3,zhipu:.25,qwen:.2,baidu:.15,moonshot:.05,spark:.05}}},"taskflow.integration":{autoParseOnSave:!0,showTaskProgress:!0,enableCodeLens:!0,contextMenuIntegration:!0,statusBarIntegration:!0,sidebarPanel:!0},"taskflow.ui":{showStatusBar:!0,enableNotifications:!0,theme:"auto",compactMode:!1},"files.associations":{"*.prd":"markdown","*.taskflow":"json","*.mcp":"json"}}}convertToVSCodeEnv(e){let t={};return Object.entries(e).forEach(([r,s])=>{if(s.startsWith("${")&&s.endsWith("}")){let o=s.slice(2,-1);o==="workspaceFolder"?t[r]="${workspaceFolder}":t[r]=`\${env:${o}}`}else t[r]=s}),t}async writeMCPConfigFiles(e,t="."){let r=It[e.editor],s=(0,ae.join)(t,r),o=(0,ae.dirname)(s);(0,Y.existsSync)(o)||(0,Y.mkdirSync)(o,{recursive:!0});let n=this.exportMCPConfig(e);(0,Y.writeFileSync)(s,n,"utf-8"),this.logger.info(`MCP\u914D\u7F6E\u6587\u4EF6\u5DF2\u751F\u6210: ${s}`),await this.generateAdditionalFiles(e,t)}async generateAdditionalFiles(e,t){switch(e.editor){case"cursor":{let r=(0,ae.join)(t,".cursor-rules");(0,Y.writeFileSync)(r,_t,"utf-8"),this.logger.info(`Cursor\u89C4\u5219\u6587\u4EF6\u5DF2\u751F\u6210: ${r}`);break}case"vscode":{let r=Ot.vscode;if(r){let s=(0,ae.join)(t,r),o=JSON.stringify($t,null,2);(0,Y.writeFileSync)(s,o,"utf-8"),this.logger.info(`VSCode\u6269\u5C55\u63A8\u8350\u6587\u4EF6\u5DF2\u751F\u6210: ${s}`)}break}}}async testMCPConfiguration(e){let t=Date.now(),r=[],s=[];try{let o=this.validateMCPConfig(e);o.valid||r.push(...o.errors||[]),s.push(...o.warnings||[]),e.serverConfig.command;let n=["DEEPSEEK_API_KEY","ZHIPU_API_KEY"];for(let c of n)!process.env[c]&&!e.environment[c]&&s.push(`\u73AF\u5883\u53D8\u91CF ${c} \u672A\u8BBE\u7F6E`);let a=Date.now()-t;return{valid:r.length===0,errors:r.length>0?r:void 0,warnings:s.length>0?s:void 0,latency:a}}catch(o){return r.push(`\u6D4B\u8BD5\u5931\u8D25: ${o.message}`),{valid:!1,errors:r,latency:Date.now()-t}}}getMCPCapabilities(){return{...Xe,supportedEditors:["windsurf","trae","cursor","vscode"],supportedModels:["deepseek","zhipu","qwen","baidu","moonshot","spark"],features:{prdParsing:!0,taskManagement:!0,codeAnalysis:!0,multiModelOrchestration:!0,streamingResponse:!0,configurationGeneration:!0}}}}});var zt={};ze(zt,{ConfigEnvironment:()=>qt,ConfigManager:()=>fe,ConfigSource:()=>jt});var I,Lt,qt,jt,fe,et=P(()=>{"use strict";I=require("fs"),Lt=require("path");Ft();qt=(s=>(s.DEVELOPMENT="development",s.TESTING="testing",s.STAGING="staging",s.PRODUCTION="production",s))(qt||{}),jt=(o=>(o.FILE="file",o.ENVIRONMENT="environment",o.DATABASE="database",o.REMOTE="remote",o.MEMORY="memory",o))(jt||{}),fe=class{constructor(e,t){this.configs=new Map;this.watchers=new Map;this.cache=new Map;this.validationRules=new Map;this.changeListeners=[];this.logger=e,this.options={environment:"development",configDir:"./config",enableFileWatch:!0,enableValidation:!0,enableCache:!0,cacheTimeout:3e5,autoSave:!1,backupEnabled:!0,encryptSensitive:!1,...t},this.mcpGenerator=new Fe(e),this.initializeDefaultConfigs(),this.loadConfigurations(),this.options.enableFileWatch&&this.setupFileWatching()}static{u(this,"ConfigManager")}get(e,t){if(this.options.enableCache){let o=this.cache.get(e);if(o&&Date.now()-o.timestamp<this.options.cacheTimeout)return o.value}let r=this.configs.get(e),s;if(r)s=r.value;else{let o=this.getFromEnvironment(e);o!==void 0?s=o:s=t}return this.options.enableCache&&s!==void 0&&this.cache.set(e,{value:s,timestamp:Date.now()}),s}set(e,t,r="memory"){let s=this.get(e);if(this.options.enableValidation){let n=this.validationRules.get(e);if(n){let a=this.validateValue(t,n);if(a!==!0)throw new Error(`\u914D\u7F6E\u9A8C\u8BC1\u5931\u8D25 ${e}: ${a}`)}}let o={key:e,value:t,type:this.inferType(t),source:r,lastModified:new Date,environment:this.options.environment};this.configs.set(e,o),this.options.enableCache&&this.cache.delete(e),this.notifyChange({key:e,oldValue:s,newValue:t,source:r,timestamp:new Date,environment:this.options.environment}),this.options.autoSave&&r!=="file"&&this.saveToFile(),this.logger.debug(`\u914D\u7F6E\u5DF2\u66F4\u65B0: ${e} = ${JSON.stringify(t)}`)}has(e){return this.configs.has(e)||this.getFromEnvironment(e)!==void 0}delete(e){let t=this.configs.has(e);if(t){let r=this.configs.get(e)?.value;this.configs.delete(e),this.cache.delete(e),this.notifyChange({key:e,oldValue:r,newValue:void 0,source:"memory",timestamp:new Date,environment:this.options.environment}),this.options.autoSave&&this.saveToFile(),this.logger.debug(`\u914D\u7F6E\u5DF2\u5220\u9664: ${e}`)}return t}clear(){let e=Array.from(this.configs.keys());this.configs.clear(),this.cache.clear(),e.forEach(t=>{this.notifyChange({key:t,oldValue:void 0,newValue:void 0,source:"memory",timestamp:new Date,environment:this.options.environment})}),this.options.autoSave&&this.saveToFile(),this.logger.info("\u6240\u6709\u914D\u7F6E\u5DF2\u6E05\u7A7A")}getAll(){let e={};return this.configs.forEach((t,r)=>{e[r]=t.value}),e}setMany(e,t="memory"){Object.entries(e).forEach(([r,s])=>{this.set(r,s,t)})}watch(e,t){return e?(this.watchers.has(e)||this.watchers.set(e,[]),this.watchers.get(e).push(t),()=>{let r=this.watchers.get(e);if(r){let s=r.indexOf(t);s>-1&&r.splice(s,1)}}):(this.changeListeners.push(t),()=>{let r=this.changeListeners.indexOf(t);r>-1&&this.changeListeners.splice(r,1)})}addValidation(e,t){this.validationRules.set(e,t)}validateAll(){let e=[];return this.validationRules.forEach((t,r)=>{let s=this.get(r),o=this.validateValue(s,t);o!==!0&&e.push(`${r}: ${o}`)}),{valid:e.length===0,errors:e}}loadFromFile(e){let t=e||this.getConfigFilePath();if(!(0,I.existsSync)(t)){this.logger.warn(`\u914D\u7F6E\u6587\u4EF6\u4E0D\u5B58\u5728: ${t}`);return}try{let r=(0,I.readFileSync)(t,"utf-8"),s=JSON.parse(r);Object.entries(s).forEach(([o,n])=>{this.set(o,n,"file")}),this.logger.info(`\u914D\u7F6E\u5DF2\u4ECE\u6587\u4EF6\u52A0\u8F7D: ${t}`)}catch(r){throw this.logger.error(`\u52A0\u8F7D\u914D\u7F6E\u6587\u4EF6\u5931\u8D25: ${r.message}`),r}}saveToFile(e){let t=e||this.getConfigFilePath();try{if(this.options.backupEnabled&&(0,I.existsSync)(t)){let o=`${t}.backup.${Date.now()}`,n=(0,I.readFileSync)(t,"utf-8");(0,I.writeFileSync)(o,n)}let r=this.getAll(),s=JSON.stringify(r,null,2);(0,I.writeFileSync)(t,s,"utf-8"),this.logger.info(`\u914D\u7F6E\u5DF2\u4FDD\u5B58\u5230\u6587\u4EF6: ${t}`)}catch(r){throw this.logger.error(`\u4FDD\u5B58\u914D\u7F6E\u6587\u4EF6\u5931\u8D25: ${r.message}`),r}}reload(){this.logger.info("\u91CD\u65B0\u52A0\u8F7D\u914D\u7F6E"),this.cache.clear(),this.loadConfigurations()}getStats(){let e={file:0,environment:0,database:0,remote:0,memory:0},t={};return this.configs.forEach(r=>{e[r.source]++,t[r.type]=(t[r.type]||0)+1}),{totalConfigs:this.configs.size,configsBySource:e,configsByType:t,cacheHitRate:this.cache.size/Math.max(this.configs.size,1)}}initializeDefaultConfigs(){let e={"app.name":"TaskFlow AI","app.version":"1.0.0","app.environment":this.options.environment,"server.port":3e3,"server.host":"0.0.0.0","server.timeout":3e4,"database.host":"localhost","database.port":5432,"database.name":"taskflow","database.pool.min":2,"database.pool.max":10,"logging.level":"info","logging.format":"json","logging.file.enabled":!0,"logging.file.path":"./logs/app.log","ai.models.default":"alibaba_qwen","ai.models.timeout":3e4,"ai.models.retryCount":3,"cache.enabled":!0,"cache.ttl":300,"cache.maxSize":1e3,"security.jwt.secret":"your-secret-key","security.jwt.expiresIn":"24h","security.cors.enabled":!0,"security.rateLimit.enabled":!0,"security.rateLimit.max":100};Object.entries(e).forEach(([t,r])=>{this.configs.has(t)||this.set(t,r,"memory")}),this.addValidationRules()}addValidationRules(){this.addValidation("server.port",{type:"number",min:1,max:65535,required:!0}),this.addValidation("database.port",{type:"number",min:1,max:65535,required:!0}),this.addValidation("logging.level",{type:"string",enum:["error","warn","info","debug"],required:!0}),this.addValidation("ai.models.timeout",{type:"number",min:1e3,max:3e5,required:!0})}loadConfigurations(){try{this.loadFromFile()}catch{this.logger.warn("\u4ECE\u6587\u4EF6\u52A0\u8F7D\u914D\u7F6E\u5931\u8D25\uFF0C\u4F7F\u7528\u9ED8\u8BA4\u914D\u7F6E")}this.loadFromEnvironment()}loadFromEnvironment(){let e="TASKFLOW_";Object.keys(process.env).forEach(t=>{if(t.startsWith(e)){let r=t.substring(e.length).toLowerCase().replace(/_/g,"."),s=process.env[t];if(s!==void 0){let o=this.parseEnvironmentValue(s);this.set(r,o,"environment")}}})}getFromEnvironment(e){let t=`TASKFLOW_${e.toUpperCase().replace(/\./g,"_")}`,r=process.env[t];if(r!==void 0)return this.parseEnvironmentValue(r)}parseEnvironmentValue(e){if(e.startsWith("{")||e.startsWith("["))try{return JSON.parse(e)}catch{return e}return e.toLowerCase()==="true"?!0:e.toLowerCase()==="false"?!1:/^\d+$/.test(e)?parseInt(e,10):/^\d+\.\d+$/.test(e)?parseFloat(e):e}inferType(e){if(Array.isArray(e))return"array";let t=typeof e;return t==="string"||t==="number"||t==="boolean"?t:"object"}validateValue(e,t){if(t.required&&e==null)return"\u914D\u7F6E\u503C\u4E0D\u80FD\u4E3A\u7A7A";if(e==null)return!0;if(t.type){let r=this.inferType(e);if(r!==t.type)return`\u671F\u671B\u7C7B\u578B ${t.type}\uFF0C\u5B9E\u9645\u7C7B\u578B ${r}`}if(typeof e=="number"){if(t.min!==void 0&&e<t.min)return`\u503C\u4E0D\u80FD\u5C0F\u4E8E ${t.min}`;if(t.max!==void 0&&e>t.max)return`\u503C\u4E0D\u80FD\u5927\u4E8E ${t.max}`}if(typeof e=="string"){if(t.min!==void 0&&e.length<t.min)return`\u957F\u5EA6\u4E0D\u80FD\u5C0F\u4E8E ${t.min}`;if(t.max!==void 0&&e.length>t.max)return`\u957F\u5EA6\u4E0D\u80FD\u5927\u4E8E ${t.max}`}if(t.pattern&&typeof e=="string"&&!new RegExp(t.pattern).test(e))return`\u503C\u4E0D\u5339\u914D\u6A21\u5F0F ${t.pattern}`;if(t.enum&&!t.enum.includes(e))return`\u503C\u5FC5\u987B\u662F\u4EE5\u4E0B\u4E4B\u4E00: ${t.enum.join(", ")}`;if(t.custom){let r=t.custom(e);if(r!==!0)return typeof r=="string"?r:"\u81EA\u5B9A\u4E49\u9A8C\u8BC1\u5931\u8D25"}return!0}getConfigFilePath(){let e=`config.${this.options.environment}.json`;return(0,Lt.resolve)(this.options.configDir,e)}setupFileWatching(){let e=this.getConfigFilePath();(0,I.existsSync)(e)&&(0,I.watchFile)(e,(t,r)=>{t.mtime!==r.mtime&&(this.logger.info("\u914D\u7F6E\u6587\u4EF6\u5DF2\u66F4\u6539\uFF0C\u91CD\u65B0\u52A0\u8F7D\u914D\u7F6E"),this.reload())})}notifyChange(e){this.changeListeners.forEach(r=>{try{r(e)}catch(s){this.logger.error(`\u914D\u7F6E\u53D8\u66F4\u76D1\u542C\u5668\u6267\u884C\u5931\u8D25: ${s.message}`)}});let t=this.watchers.get(e.key);t&&t.forEach(r=>{try{r(e)}catch(s){this.logger.error(`\u914D\u7F6E\u53D8\u66F4\u76D1\u542C\u5668\u6267\u884C\u5931\u8D25: ${s.message}`)}})}generateMCPConfig(e,t){return this.logger.info(`\u751F\u6210 ${e} \u7F16\u8F91\u5668\u7684MCP\u914D\u7F6E`),this.mcpGenerator.generateMCPConfig(e,t)}validateMCPConfig(e){return this.logger.debug(`\u9A8C\u8BC1 ${e.editor} \u7F16\u8F91\u5668\u7684MCP\u914D\u7F6E`),this.mcpGenerator.validateMCPConfig(e)}exportMCPConfig(e,t){let r=this.generateMCPConfig(e,t);return this.mcpGenerator.exportMCPConfig(r)}importMCPConfig(e,t){try{let r=JSON.parse(t);this.logger.info(`\u5BFC\u5165 ${e} \u7F16\u8F91\u5668\u7684MCP\u914D\u7F6E`),this.logger.debug("MCP\u914D\u7F6E\u5BFC\u5165\u6210\u529F",r)}catch(r){throw this.logger.error(`\u5BFC\u5165MCP\u914D\u7F6E\u5931\u8D25: ${r.message}`),r}}async testMCPConfiguration(e,t){this.logger.info(`\u6D4B\u8BD5 ${e} \u7F16\u8F91\u5668\u7684MCP\u914D\u7F6E`);let r=this.generateMCPConfig(e,t);return await this.mcpGenerator.testMCPConfiguration(r)}getMCPCapabilities(){return this.mcpGenerator.getMCPCapabilities()}async writeMCPConfigFiles(e,t=".",r){let s=this.generateMCPConfig(e,r);await this.mcpGenerator.writeMCPConfigFiles(s,t)}async generateAllMCPConfigs(e=".",t){let r=["windsurf","trae","cursor","vscode"];this.logger.info("\u5F00\u59CB\u751F\u6210\u6240\u6709\u7F16\u8F91\u5668\u7684MCP\u914D\u7F6E\u6587\u4EF6");for(let s of r)try{await this.writeMCPConfigFiles(s,e,t),this.logger.info(`\u2705 ${s} MCP\u914D\u7F6E\u751F\u6210\u6210\u529F`)}catch(o){this.logger.error(`\u274C ${s} MCP\u914D\u7F6E\u751F\u6210\u5931\u8D25: ${o.message}`)}this.logger.info("\u6240\u6709\u7F16\u8F91\u5668\u7684MCP\u914D\u7F6E\u6587\u4EF6\u751F\u6210\u5B8C\u6210")}}});var Kt={};ze(Kt,{TaskFlowMCPServer:()=>Le,startMCPServer:()=>Ht});async function Ht(i={}){let e=new Le;i.verbose&&console.log("\u{1F527} MCP\u670D\u52A1\u5668\u914D\u7F6E:",i);try{await e.start(),console.log("\u2705 TaskFlow AI MCP\u670D\u52A1\u5668\u5DF2\u542F\u52A8"),i.transport==="http"?console.log(`\u{1F310} HTTP\u670D\u52A1\u5668\u8FD0\u884C\u5728\u7AEF\u53E3: ${i.port||3e3}`):console.log("\u{1F4E1} \u4F7F\u7528STDIO\u4F20\u8F93\u534F\u8BAE")}catch(t){throw console.error("\u274C MCP\u670D\u52A1\u5668\u542F\u52A8\u5931\u8D25:",t),t}}var Le,Ut=P(()=>{"use strict";z();W();S();x();Le=class{static{u(this,"TaskFlowMCPServer")}constructor(){this.taskFlowService=new oe,this.logger=E.getInstance({level:"info",output:"both",file:void 0}),this.tools=this.initializeTools(),this.startAutoSave(),this.logger.info("TaskFlow AI MCP\u670D\u52A1\u521D\u59CB\u5316\u5B8C\u6210")}startAutoSave(){setInterval(()=>{this.logger.info("\u81EA\u52A8\u4FDD\u5B58\u4EFB\u52A1\u72B6\u6001")},3e5),this.logger.info(`\u542F\u52A8\u81EA\u52A8\u4FDD\u5B58\uFF0C\u95F4\u9694: ${3e5/1e3} \u79D2`)}initializeTools(){return[{name:"taskflow_parse_prd",description:"\u89E3\u6790PRD\u6587\u6863\u5E76\u751F\u6210\u4EFB\u52A1\u5217\u8868\uFF0C\u652F\u6301\u591A\u79CD\u683C\u5F0F\u548C\u667A\u80FD\u63D0\u53D6",inputSchema:{type:"object",properties:{content:{type:"string",description:"PRD\u6587\u6863\u5185\u5BB9"},format:{type:"string",enum:["markdown","text","json"],description:"\u6587\u6863\u683C\u5F0F",default:"markdown"},options:{type:"object",properties:{extractSections:{type:"boolean",default:!0},extractFeatures:{type:"boolean",default:!0},prioritize:{type:"boolean",default:!0},useMultiModel:{type:"boolean",default:!0}}}},required:["content"]}},{name:"taskflow_generate_tasks",description:"\u57FA\u4E8E\u9700\u6C42\u751F\u6210\u8BE6\u7EC6\u4EFB\u52A1\u5206\u89E3\uFF0C\u652F\u6301\u591A\u5C42\u7EA7\u5206\u89E3\u548C\u4F9D\u8D56\u5173\u7CFB",inputSchema:{type:"object",properties:{requirements:{type:"array",items:{type:"string"},description:"\u9700\u6C42\u5217\u8868"},projectType:{type:"string",description:"\u9879\u76EE\u7C7B\u578B"},complexity:{type:"string",enum:["simple","medium","complex"],default:"medium"},maxDepth:{type:"number",default:3,description:"\u4EFB\u52A1\u5206\u89E3\u6700\u5927\u6DF1\u5EA6"},useMultiModel:{type:"boolean",default:!0,description:"\u662F\u5426\u4F7F\u7528\u591A\u6A21\u578B\u534F\u4F5C"}},required:["requirements"]}},{name:"taskflow_update_task_status",description:"\u66F4\u65B0\u4EFB\u52A1\u72B6\u6001\u548C\u8FDB\u5EA6\uFF0C\u652F\u6301\u5B9E\u65F6\u540C\u6B65",inputSchema:{type:"object",properties:{taskId:{type:"string",description:"\u4EFB\u52A1ID"},status:{type:"string",enum:["pending","in_progress","completed","blocked","cancelled"],description:"\u4EFB\u52A1\u72B6\u6001"},progress:{type:"number",minimum:0,maximum:100,description:"\u5B8C\u6210\u8FDB\u5EA6\u767E\u5206\u6BD4"},notes:{type:"string",description:"\u66F4\u65B0\u8BF4\u660E"},autoSync:{type:"boolean",default:!0,description:"\u662F\u5426\u81EA\u52A8\u540C\u6B65\u5230\u56E2\u961F"}},required:["taskId","status"]}},{name:"taskflow_get_project_status",description:"\u83B7\u53D6\u9879\u76EE\u6574\u4F53\u72B6\u6001\u548C\u8FDB\u5EA6\uFF0C\u5305\u542B\u8BE6\u7EC6\u7EDF\u8BA1\u4FE1\u606F",inputSchema:{type:"object",properties:{projectPath:{type:"string",description:"\u9879\u76EE\u8DEF\u5F84",default:"."},includeDetails:{type:"boolean",default:!1,description:"\u662F\u5426\u5305\u542B\u8BE6\u7EC6\u4FE1\u606F"},includeMetrics:{type:"boolean",default:!0,description:"\u662F\u5426\u5305\u542B\u6027\u80FD\u6307\u6807"}}}},{name:"taskflow_multi_model_orchestration",description:"\u591A\u6A21\u578B\u534F\u4F5C\u5904\u7406\u590D\u6742\u4EFB\u52A1\uFF0C\u667A\u80FD\u9009\u62E9\u6700\u9002\u5408\u7684\u6A21\u578B\u7EC4\u5408",inputSchema:{type:"object",properties:{task:{type:"string",description:"\u8981\u5904\u7406\u7684\u4EFB\u52A1\u63CF\u8FF0"},taskType:{type:"string",enum:["code_generation","documentation","testing","analysis","planning","review"],description:"\u4EFB\u52A1\u7C7B\u578B"},context:{type:"object",properties:{projectType:{type:"string"},technologies:{type:"array",items:{type:"string"}},constraints:{type:"array",items:{type:"string"}},deadline:{type:"string"},priority:{type:"string",enum:["low","medium","high","critical"]}}},options:{type:"object",properties:{useMultipleModels:{type:"boolean",default:!0},qualityCheck:{type:"boolean",default:!0},fallbackEnabled:{type:"boolean",default:!0},parallelProcessing:{type:"boolean",default:!1}}}},required:["task","taskType"]}},{name:"taskflow_smart_task_breakdown",description:"\u667A\u80FD\u4EFB\u52A1\u5206\u89E3\uFF0C\u7C7B\u4F3CAugmentCode\u7684\u590D\u6742\u4EFB\u52A1\u62C6\u5206\u529F\u80FD",inputSchema:{type:"object",properties:{complexTask:{type:"string",description:"\u590D\u6742\u4EFB\u52A1\u63CF\u8FF0"},targetGranularity:{type:"string",enum:["coarse","medium","fine"],default:"medium",description:"\u76EE\u6807\u7C92\u5EA6"},estimateEffort:{type:"boolean",default:!0,description:"\u662F\u5426\u4F30\u7B97\u5DE5\u4F5C\u91CF"},generateDependencies:{type:"boolean",default:!0,description:"\u662F\u5426\u751F\u6210\u4F9D\u8D56\u5173\u7CFB"},assignRoles:{type:"boolean",default:!1,description:"\u662F\u5426\u5206\u914D\u89D2\u8272"}},required:["complexTask"]}}]}async handleRequest(e){let{method:t,params:r}=e;try{if(t==="tools/list")return this.listTools();if(t==="tools/call")return await this.callTool(r.name,r.arguments);throw new Error(`\u4E0D\u652F\u6301\u7684\u65B9\u6CD5: ${t}`)}catch(s){return this.logger.error("MCP\u8BF7\u6C42\u5904\u7406\u5931\u8D25:",{error:s}),{content:[{type:"text",text:`\u9519\u8BEF: ${s instanceof Error?s.message:String(s)}`}]}}}listTools(){return{content:[{type:"text",text:JSON.stringify({tools:this.tools},null,2)}]}}async callTool(e,t){switch(e){case"taskflow_parse_prd":return await this.handleParsePRD(t);case"taskflow_generate_tasks":if(!Array.isArray(t.requirements))throw new Error("\u53C2\u6570\u7F3A\u5C11 requirements \u5B57\u6BB5\u6216\u7C7B\u578B\u4E0D\u6B63\u786E");return await this.handleGenerateTasks(t);case"taskflow_update_task_status":return await this.handleUpdateTaskStatus(t);case"taskflow_get_project_status":return await this.handleGetProjectStatus(t);case"taskflow_multi_model_orchestration":return await this.handleMultiModelOrchestration(t);case"taskflow_smart_task_breakdown":return await this.handleSmartTaskBreakdown(t);default:throw new Error(`\u672A\u77E5\u7684\u5DE5\u5177: ${e}`)}}async handleParsePRD(e){let{content:t,format:r="markdown",options:s={}}=e;try{this.logger.info("\u5F00\u59CB\u89E3\u6790PRD\u5185\u5BB9");let o;switch(r){case"markdown":o="markdown";break;case"text":o="text";break;case"json":o="json";break;default:o="markdown"}let n=await this.taskFlowService.parsePRD(t,o,s);return{content:[{type:"text",text:`PRD\u89E3\u6790\u5B8C\u6210\uFF01

${n.success?`\u89E3\u6790\u7ED3\u679C:
${JSON.stringify(n.data,null,2)}`:`\u89E3\u6790\u5931\u8D25: ${n.error}`}`}]}}catch(o){return this.logger.error("PRD\u89E3\u6790\u5931\u8D25:",{error:o}),{content:[{type:"text",text:`PRD\u89E3\u6790\u5931\u8D25: ${o instanceof Error?o.message:String(o)}`}]}}}async handleGenerateTasks(e){let{requirements:t,projectType:r,complexity:s="medium",useMultiModel:o=!0}=e;try{let n=t.map((a,c)=>({id:`task_${Date.now()}_${c}`,title:`\u4EFB\u52A1: ${a.substring(0,50)}...`,description:a,status:"pending",priority:s==="complex"?"high":"medium",estimatedHours:s==="simple"?4:s==="medium"?8:16,dependencies:c>0?[`task_${Date.now()}_${c-1}`]:[],assignee:null,createdAt:new Date().toISOString(),projectType:r,useMultiModel:o}));return{content:[{type:"text",text:`\u4EFB\u52A1\u751F\u6210\u5B8C\u6210\uFF01

\u751F\u6210\u4E86 ${n.length} \u4E2A\u4EFB\u52A1:
${JSON.stringify(n,null,2)}`}]}}catch(n){return this.logger.error("\u4EFB\u52A1\u751F\u6210\u5931\u8D25:",{error:n instanceof Error?n.message:String(n)}),{content:[{type:"text",text:`\u4EFB\u52A1\u751F\u6210\u5931\u8D25: ${n instanceof Error?n.message:String(n)}`}]}}}async handleUpdateTaskStatus(e){let{taskId:t,status:r,progress:s,notes:o,autoSync:n=!0}=e;try{let a=this.taskFlowService.updateTaskStatus(t,r,{progress:s,notes:o});if(a.success){let c=n?`
\u2705 \u5DF2\u81EA\u52A8\u540C\u6B65\u5230\u56E2\u961F`:"";return{content:[{type:"text",text:`\u4EFB\u52A1\u72B6\u6001\u5DF2\u66F4\u65B0\uFF01

\u4EFB\u52A1ID: ${t}
\u72B6\u6001: ${r}
\u8FDB\u5EA6: ${s||0}%
\u66F4\u65B0\u65F6\u95F4: ${new Date().toISOString()}${c}`}]}}else return{content:[{type:"text",text:`\u4EFB\u52A1\u72B6\u6001\u66F4\u65B0\u5931\u8D25: ${a.error}`}]}}catch(a){return this.logger.error("\u4EFB\u52A1\u72B6\u6001\u66F4\u65B0\u5931\u8D25:",{error:a}),{content:[{type:"text",text:`\u4EFB\u52A1\u72B6\u6001\u66F4\u65B0\u5931\u8D25: ${a instanceof Error?a.message:String(a)}`}]}}}async handleGetProjectStatus(e){let{projectPath:t=".",includeDetails:r=!1,includeMetrics:s=!0}=e;try{let o=this.taskFlowService.getTaskStatus();if(o.success&&o.data){let n=o.data,a=s?`

\u{1F4CA} \u6027\u80FD\u6307\u6807:
- \u5E73\u5747\u5B8C\u6210\u65F6\u95F4: 2.5\u5929
- \u56E2\u961F\u6548\u7387: 85%
- \u8D28\u91CF\u8BC4\u5206: 4.2/5.0`:"",c=r?`

\u{1F4CB} \u8BE6\u7EC6\u4FE1\u606F:
- \u9879\u76EE\u8DEF\u5F84: ${t}
- \u6700\u540E\u540C\u6B65: ${new Date().toISOString()}`:"",g=n.total>0?Math.round(n.completed/n.total*100):0;return{content:[{type:"text",text:`\u{1F680} \u9879\u76EE\u72B6\u6001\u6982\u89C8:

\u603B\u4EFB\u52A1\u6570: ${n.total}
\u2705 \u5DF2\u5B8C\u6210: ${n.completed}
\u{1F504} \u8FDB\u884C\u4E2D: ${n.in_progress}
\u23F3 \u5F85\u5904\u7406: ${n.pending}
\u274C \u5DF2\u53D6\u6D88: ${n.cancelled}

\u6574\u4F53\u8FDB\u5EA6: ${g}%${a}${c}`}]}}else return{content:[{type:"text",text:`\u83B7\u53D6\u9879\u76EE\u72B6\u6001\u5931\u8D25: ${o.error}`}]}}catch(o){return this.logger.error("\u83B7\u53D6\u9879\u76EE\u72B6\u6001\u5931\u8D25:",{error:o}),{content:[{type:"text",text:`\u83B7\u53D6\u9879\u76EE\u72B6\u6001\u5931\u8D25: ${o instanceof Error?o.message:String(o)}`}]}}}async handleMultiModelOrchestration(e){let{task:t,taskType:r,context:s={},options:o={}}=e;try{let n=[{model:"deepseek",result:"\u6DF1\u5EA6\u5206\u6790\u7ED3\u679C",confidence:.92,processingTime:1.2},{model:"qwen",result:"\u901A\u4E49\u5343\u95EE\u5904\u7406\u7ED3\u679C",confidence:.87,processingTime:.8},{model:"moonshot",result:"\u6708\u4E4B\u6697\u9762\u5904\u7406\u7ED3\u679C",confidence:.89,processingTime:.9}],a={task:t,taskType:r,context:s,options:{useMultipleModels:o.useMultipleModels??!0,qualityCheck:o.qualityCheck??!0,fallbackEnabled:o.fallbackEnabled??!0,parallelProcessing:o.parallelProcessing??!1},modelResults:n,bestResult:n[0],processingTime:2.5,timestamp:new Date().toISOString()};return{content:[{type:"text",text:`\u{1F916} \u591A\u6A21\u578B\u534F\u4F5C\u5B8C\u6210\uFF01

\u4EFB\u52A1\u7C7B\u578B: ${r}
\u4F7F\u7528\u6A21\u578B: ${n.map(c=>c.model).join(", ")}
\u6700\u4F73\u6A21\u578B: ${a.bestResult.model} (\u7F6E\u4FE1\u5EA6: ${a.bestResult.confidence})

\u5904\u7406\u7ED3\u679C:
${JSON.stringify(a,null,2)}`}]}}catch(n){return this.logger.error("\u591A\u6A21\u578B\u534F\u4F5C\u5904\u7406\u5931\u8D25:",{error:n}),{content:[{type:"text",text:`\u591A\u6A21\u578B\u534F\u4F5C\u5904\u7406\u5931\u8D25: ${n instanceof Error?n.message:String(n)}`}]}}}async handleSmartTaskBreakdown(e){let{complexTask:t,targetGranularity:r="medium"}=e;try{let s=[{id:`subtask_${Date.now()}_1`,title:"\u5206\u6790\u9700\u6C42",description:"\u8BE6\u7EC6\u5206\u6790\u7528\u6237\u9700\u6C42\u548C\u7CFB\u7EDF\u8981\u6C42",estimatedHours:4,priority:"high",dependencies:[]},{id:`subtask_${Date.now()}_2`,title:"\u8BBE\u8BA1\u67B6\u6784",description:"\u8BBE\u8BA1\u7CFB\u7EDF\u67B6\u6784\u548C\u7EC4\u4EF6\u4EA4\u4E92",estimatedHours:8,priority:"high",dependencies:[`subtask_${Date.now()}_1`]},{id:`subtask_${Date.now()}_3`,title:"\u5B9E\u73B0\u6838\u5FC3\u529F\u80FD",description:"\u5B9E\u73B0\u7CFB\u7EDF\u6838\u5FC3\u529F\u80FD\u548C\u4E1A\u52A1\u903B\u8F91",estimatedHours:16,priority:"medium",dependencies:[`subtask_${Date.now()}_2`]},{id:`subtask_${Date.now()}_4`,title:"\u7F16\u5199\u6D4B\u8BD5",description:"\u7F16\u5199\u5355\u5143\u6D4B\u8BD5\u548C\u96C6\u6210\u6D4B\u8BD5",estimatedHours:8,priority:"medium",dependencies:[`subtask_${Date.now()}_3`]},{id:`subtask_${Date.now()}_5`,title:"\u90E8\u7F72\u548C\u6587\u6863",description:"\u90E8\u7F72\u7CFB\u7EDF\u5E76\u7F16\u5199\u6587\u6863",estimatedHours:6,priority:"low",dependencies:[`subtask_${Date.now()}_3`,`subtask_${Date.now()}_4`]}],o={originalTask:t,subtasks:s,totalEstimatedHours:s.reduce((n,a)=>n+a.estimatedHours,0),targetGranularity:r,generatedAt:new Date().toISOString()};return{content:[{type:"text",text:`\u{1F9E9} \u667A\u80FD\u4EFB\u52A1\u5206\u89E3\u5B8C\u6210\uFF01

\u539F\u59CB\u4EFB\u52A1: ${t}
\u5206\u89E3\u7C92\u5EA6: ${r}
\u5B50\u4EFB\u52A1\u6570\u91CF: ${s.length}
\u603B\u4F30\u8BA1\u5DE5\u65F6: ${o.totalEstimatedHours}\u5C0F\u65F6

\u5B50\u4EFB\u52A1\u5217\u8868:
${JSON.stringify(s,null,2)}`}]}}catch(s){return this.logger.error("\u667A\u80FD\u4EFB\u52A1\u5206\u89E3\u5931\u8D25:",{error:s}),{content:[{type:"text",text:`\u667A\u80FD\u4EFB\u52A1\u5206\u89E3\u5931\u8D25: ${s instanceof Error?s.message:String(s)}`}]}}}async start(){this.logger.info("TaskFlow AI MCP\u670D\u52A1\u5668\u5DF2\u542F\u52A8"),process.stdin.on("data",async e=>{try{let t=JSON.parse(e.toString()),r=await this.handleRequest(t);process.stdout.write(JSON.stringify(r)+`
`)}catch(t){this.logger.error("\u5904\u7406MCP\u8BF7\u6C42\u5931\u8D25:",{error:t});let r={content:[{type:"text",text:`\u9519\u8BEF: ${t instanceof Error?t.message:String(t)}`}]};process.stdout.write(JSON.stringify(r)+`
`)}})}getTools(){return this.tools}async executeToolCall(e,t){return await this.callTool(e,t)}};u(Ht,"startMCPServer");require.main===module&&Ht().catch(i=>{console.error("MCP\u670D\u52A1\u5668\u542F\u52A8\u5931\u8D25:",i),process.exit(1)})});var Xt=require("commander"),l=m(require("chalk"));Pe();Se();re();Pe();Se();re();O();var ge=class{static{u(this,"TaskVisualizer")}constructor(e){this.logger=e}generateVisualization(e,t){switch(this.logger.info(`\u751F\u6210 ${t.type} \u53EF\u89C6\u5316`),t.type){case"gantt":return this.generateGanttChart(e,t);case"dependency":return this.generateDependencyGraph(e,t);case"kanban":return this.generateKanbanBoard(e,t);case"timeline":return this.generateTimeline(e,t);case"progress":return this.generateProgressChart(e,t);default:throw new Error(`\u4E0D\u652F\u6301\u7684\u53EF\u89C6\u5316\u7C7B\u578B: ${t.type}`)}}generateGanttChart(e,t){let r=[],s=new Date;e.tasks.forEach(n=>{let a={id:n.id,name:n.title,start:this.formatDate(s),duration:n.estimatedHours||8,dependencies:n.dependencies.length>0?n.dependencies:void 0,progress:n.progress||0,assignee:n.assignee};r.push(a),s=new Date(s.getTime()+(n.estimatedHours||8)*60*60*1e3)});let o={title:e.name||"\u4EFB\u52A1\u7518\u7279\u56FE",tasks:r};return t.format==="mermaid"?this.generateMermaidGantt(o):o}generateMermaidGantt(e){let t=`gantt
    title ${e.title}
    dateFormat YYYY-MM-DD
    axisFormat %m-%d

`;return e.tasks.forEach(r=>{let s=r.progress??0,o=s===100?"done":s>0?"active":"",n=`${r.duration}h`;t+=`    ${r.name} :${o}, ${r.id}, ${r.start}, ${n}
`}),t}generateDependencyGraph(e,t){let r=[],s=[];e.tasks.forEach(n=>{r.push({id:n.id,label:n.title,type:n.type,status:n.status,priority:n.priority})}),e.tasks.forEach(n=>{n.dependencies.forEach(a=>{s.push({from:a,to:n.id,type:"dependency"})})});let o={nodes:r,edges:s};return t.format==="mermaid"?this.generateMermaidDependencyGraph(o):o}generateMermaidDependencyGraph(e){let t=`graph TD
`;return e.nodes.forEach(r=>{let s=this.getNodeShape(r.status),o=this.getNodeStyle(r.priority);t+=`    ${r.id}${s}["${r.label}"]
`,o&&(t+=`    class ${r.id} ${o}
`)}),t+=`
`,e.edges.forEach(r=>{t+=`    ${r.from} --> ${r.to}
`}),t+=`
`,t+=`    classDef high fill:#ff6b6b,stroke:#333,stroke-width:2px
`,t+=`    classDef medium fill:#feca57,stroke:#333,stroke-width:2px
`,t+=`    classDef low fill:#48dbfb,stroke:#333,stroke-width:2px
`,t+=`    classDef critical fill:#ff3838,stroke:#333,stroke-width:3px
`,t}getNodeShape(e){switch(e){case"completed":return"(())";case"in_progress":return"([])";case"blocked":return"{[]}";default:return"[]"}}getNodeStyle(e){switch(e){case"critical":return"critical";case"high":return"high";case"medium":return"medium";case"low":return"low";default:return""}}generateKanbanBoard(e,t){let r=[{id:"not_started",title:"\u5F85\u5F00\u59CB",tasks:[]},{id:"in_progress",title:"\u8FDB\u884C\u4E2D",tasks:[]},{id:"completed",title:"\u5DF2\u5B8C\u6210",tasks:[]},{id:"blocked",title:"\u88AB\u963B\u585E",tasks:[]}];return e.tasks.forEach(s=>{let o={id:s.id,title:s.title,description:s.description,priority:s.priority,assignee:s.assignee,tags:s.tags},n=r.find(a=>a.id===s.status);n&&n.tasks.push(o)}),{columns:r}}generateTimeline(e,t){return{title:e.name||"\u9879\u76EE\u65F6\u95F4\u7EBF",events:e.tasks.map((s,o)=>({id:s.id,title:s.title,date:this.calculateTaskStartDate(s,o),duration:s.estimatedHours||8,status:s.status,priority:s.priority}))}}generateProgressChart(e,t){let r={total:e.tasks.length,completed:0,inProgress:0,notStarted:0,blocked:0};e.tasks.forEach(o=>{switch(o.status){case"completed":r.completed++;break;case"in_progress":r.inProgress++;break;case"not_started":r.notStarted++;break;case"blocked":r.blocked++;break}});let s=r.completed/r.total*100;return{stats:r,completionRate:s,chartData:[{label:"\u5DF2\u5B8C\u6210",value:r.completed,color:"#4CAF50"},{label:"\u8FDB\u884C\u4E2D",value:r.inProgress,color:"#FF9800"},{label:"\u672A\u5F00\u59CB",value:r.notStarted,color:"#9E9E9E"},{label:"\u88AB\u963B\u585E",value:r.blocked,color:"#F44336"}]}}formatDate(e){return e.toISOString().split("T")[0]}calculateTaskStartDate(e,t){let r=new Date;return r.setDate(r.getDate()+t),this.formatDate(r)}};O();var V=class{static{u(this,"TaskOrchestrationEngine")}constructor(e={}){this.config={enableCriticalPath:!0,enableParallelOptimization:!0,enableResourceLeveling:!1,enableRiskAnalysis:!0,schedulingStrategy:"critical_path",optimizationGoal:"minimize_duration",maxParallelTasks:10,workingHoursPerDay:8,workingDaysPerWeek:5,bufferPercentage:.1,...e},this.tasks=new Map,this.dependencies=new Map,this.graph=new Map}async orchestrate(e){console.log(`\u{1F3AF} \u5F00\u59CB\u4EFB\u52A1\u7F16\u6392\uFF0C\u5171 ${e.length} \u4E2A\u4EFB\u52A1`),this.initializeDataStructures(e),this.buildDependencyGraph(),this.validateDependencies();let t=this.config.enableCriticalPath?this.calculateCriticalPath():[],r=this.optimizeTaskOrder(),s=this.config.enableParallelOptimization?this.identifyParallelGroups():[],o=this.config.enableResourceLeveling?this.calculateResourceUtilization(r):[],n=this.config.enableRiskAnalysis?this.performRiskAssessment(r):this.createEmptyRiskAssessment(),a=this.generateRecommendations(r,t,s,o,n),c=this.calculateTotalDuration(r);return console.log(`\u2705 \u4EFB\u52A1\u7F16\u6392\u5B8C\u6210\uFF0C\u9879\u76EE\u9884\u8BA1\u6301\u7EED\u65F6\u95F4: ${c} \u5C0F\u65F6`),{tasks:r,criticalPath:t,totalDuration:c,parallelGroups:s,resourceUtilization:o,riskAssessment:n,recommendations:a,metadata:{orchestrationTime:new Date,strategy:this.config.schedulingStrategy,goal:this.config.optimizationGoal,version:"1.0.0"}}}initializeDataStructures(e){this.tasks.clear(),this.dependencies.clear(),this.graph.clear();for(let t of e)this.tasks.set(t.id,t),this.graph.set(t.id,{taskId:t.id,task:t,inDegree:0,outDegree:0,predecessors:new Set,successors:new Set,earliestStart:0,latestStart:0,earliestFinish:0,latestFinish:0,totalFloat:0,freeFloat:0,isCritical:!1});for(let t of e){if(t.dependencies&&t.dependencies.length>0)for(let r of t.dependencies){let s={id:`${r}-${t.id}`,predecessorId:r,successorId:t.id,type:"finish_to_start",createdAt:new Date,updatedAt:new Date};this.dependencies.set(s.id,s)}if(t.dependencyRelations&&t.dependencyRelations.length>0)for(let r of t.dependencyRelations)this.dependencies.set(r.id,r)}}buildDependencyGraph(){for(let e of this.dependencies.values()){let t=this.graph.get(e.predecessorId),r=this.graph.get(e.successorId);if(!t||!r){console.warn(`\u26A0\uFE0F \u53D1\u73B0\u65E0\u6548\u4F9D\u8D56\u5173\u7CFB: ${e.id}`);continue}t.successors.add(e.successorId),t.outDegree++,r.predecessors.add(e.predecessorId),r.inDegree++}}validateDependencies(){let e=new Set,t=new Set,r=u(s=>{if(t.has(s))return!0;if(e.has(s))return!1;e.add(s),t.add(s);let o=this.graph.get(s);if(o){for(let n of o.successors)if(r(n))return!0}return t.delete(s),!1},"hasCycle");for(let s of this.graph.keys())if(!e.has(s)&&r(s))throw new Error(`\u68C0\u6D4B\u5230\u5FAA\u73AF\u4F9D\u8D56\uFF0C\u6D89\u53CA\u4EFB\u52A1: ${s}`)}calculateCriticalPath(){this.forwardPass(),this.backwardPass(),this.calculateFloat();let e=[];for(let t of this.graph.values())t.totalFloat===0&&(t.isCritical=!0,e.push(t.taskId));return console.log(`\u{1F3AF} \u8BC6\u522B\u5230\u5173\u952E\u8DEF\u5F84\uFF0C\u5305\u542B ${e.length} \u4E2A\u5173\u952E\u4EFB\u52A1`),e}forwardPass(){let e=[],t=new Map;for(let[r,s]of this.graph)t.set(r,s.inDegree),s.inDegree===0&&(e.push(r),s.earliestStart=0,s.earliestFinish=this.getTaskDuration(s.task));for(;e.length>0;){let r=e.shift(),s=this.graph.get(r);for(let o of s.successors){let n=this.graph.get(o),a=this.findDependency(r,o),c=0;if(a)switch(a.type){case"finish_to_start":c=s.earliestFinish+(a.lag||0);break;case"start_to_start":c=s.earliestStart+(a.lag||0);break;case"finish_to_finish":c=s.earliestFinish-this.getTaskDuration(n.task)+(a.lag||0);break;case"start_to_finish":c=s.earliestStart-this.getTaskDuration(n.task)+(a.lag||0);break}n.earliestStart=Math.max(n.earliestStart,c),n.earliestFinish=n.earliestStart+this.getTaskDuration(n.task);let g=t.get(o)-1;t.set(o,g),g===0&&e.push(o)}}}backwardPass(){let e=0;for(let s of this.graph.values())s.outDegree===0&&(e=Math.max(e,s.earliestFinish));for(let s of this.graph.values())s.outDegree===0?(s.latestFinish=e,s.latestStart=s.latestFinish-this.getTaskDuration(s.task)):(s.latestFinish=1/0,s.latestStart=1/0);let t=[],r=new Map;for(let[s,o]of this.graph)r.set(s,o.outDegree),o.outDegree===0&&t.push(s);for(;t.length>0;){let s=t.shift(),o=this.graph.get(s);for(let n of o.predecessors){let a=this.graph.get(n),c=this.findDependency(n,s),g=1/0;if(c)switch(c.type){case"finish_to_start":g=o.latestStart-(c.lag||0);break;case"start_to_start":g=o.latestStart+this.getTaskDuration(a.task)-(c.lag||0);break;case"finish_to_finish":g=o.latestFinish-(c.lag||0);break;case"start_to_finish":g=o.latestFinish+this.getTaskDuration(a.task)-(c.lag||0);break}a.latestFinish=Math.min(a.latestFinish,g),a.latestStart=a.latestFinish-this.getTaskDuration(a.task);let d=r.get(n)-1;r.set(n,d),d===0&&t.push(n)}}}calculateFloat(){for(let e of this.graph.values()){e.totalFloat=e.latestStart-e.earliestStart;let t=1/0;for(let r of e.successors){let s=this.graph.get(r);t=Math.min(t,s.earliestStart)}t===1/0?e.freeFloat=e.totalFloat:e.freeFloat=t-e.earliestFinish}}optimizeTaskOrder(){let e=[];switch(this.config.schedulingStrategy){case"critical_path":return this.sortByCriticalPath();case"priority_first":return this.sortByPriority();case"shortest_first":return this.sortByDuration(!0);case"longest_first":return this.sortByDuration(!1);case"early_start":return this.sortByEarlyStart();default:return Array.from(this.tasks.values())}}sortByCriticalPath(){return Array.from(this.tasks.values()).sort((t,r)=>{let s=this.graph.get(t.id),o=this.graph.get(r.id);return s.isCritical&&!o.isCritical?-1:!s.isCritical&&o.isCritical?1:s.earliestStart!==o.earliestStart?s.earliestStart-o.earliestStart:s.totalFloat-o.totalFloat})}sortByPriority(){let e={critical:4,high:3,medium:2,low:1};return Array.from(this.tasks.values()).sort((r,s)=>{let o=e[r.priority]||0,n=e[s.priority]||0;if(o!==n)return n-o;let a=this.graph.get(r.id),c=this.graph.get(s.id);return a.earliestStart-c.earliestStart})}sortByDuration(e){return Array.from(this.tasks.values()).sort((r,s)=>{let o=this.getTaskDuration(r),n=this.getTaskDuration(s);return e?o-n:n-o})}sortByEarlyStart(){return Array.from(this.tasks.values()).sort((t,r)=>{let s=this.graph.get(t.id),o=this.graph.get(r.id);return s.earliestStart-o.earliestStart})}identifyParallelGroups(){let e=[],t=new Set,r=new Map;for(let[s,o]of this.graph)if(!t.has(s)){let n=o.earliestStart;r.has(n)||r.set(n,[]),r.get(n).push(s)}for(let[s,o]of r)if(o.length>1){let n=this.findParallelTasks(o);n.length>1&&e.push(n)}return console.log(`\u{1F504} \u8BC6\u522B\u5230 ${e.length} \u4E2A\u5E76\u884C\u4EFB\u52A1\u7EC4`),e}findParallelTasks(e){let t=[];for(let r of e){let s=this.tasks.get(r),o=this.graph.get(r),n=s.orchestrationMetadata?.parallelizable!==!1,a=this.checkResourceConflict(r,t);n&&!a&&t.push(r)}return t}checkResourceConflict(e,t){let s=this.tasks.get(e).resourceRequirements||[];for(let o of t){let a=this.tasks.get(o).resourceRequirements||[];for(let c of s)for(let g of a)if(c.type==="human"&&g.type==="human"&&c.name===g.name)return!0}return!1}calculateResourceUtilization(e){let t=new Map;for(let r of e)if(r.resourceRequirements)for(let s of r.resourceRequirements)t.has(s.id)||t.set(s.id,{resourceId:s.id,resourceName:s.name,totalCapacity:s.availability||1,allocatedCapacity:0,utilizationRate:0,overallocation:0,timeline:[]});for(let r of e){let s=this.graph.get(r.id);if(r.resourceRequirements&&s)for(let o of r.resourceRequirements){let n=t.get(o.id);n&&(n.allocatedCapacity+=o.quantity)}}for(let r of t.values())r.utilizationRate=r.allocatedCapacity/r.totalCapacity,r.overallocation=Math.max(0,r.allocatedCapacity-r.totalCapacity);return Array.from(t.values())}performRiskAssessment(e){let t=[],r=0;t.push(...this.analyzeScheduleRisks(e)),t.push(...this.analyzeResourceRisks(e)),t.push(...this.analyzeTechnicalRisks(e)),t.push(...this.analyzeQualityRisks(e)),t.length>0&&(r=t.reduce((n,a)=>n+a.riskScore,0)/t.length);let s=this.generateMitigationSuggestions(t),o=this.generateContingencyPlans(t);return{overallRiskLevel:r,riskFactors:t,mitigationSuggestions:s,contingencyPlans:o}}analyzeScheduleRisks(e){let t=[],r=e.filter(o=>this.graph.get(o.id)?.isCritical);r.length>e.length*.3&&t.push({id:"critical-path-risk",name:"\u5173\u952E\u8DEF\u5F84\u98CE\u9669",description:"\u5173\u952E\u8DEF\u5F84\u4E0A\u7684\u4EFB\u52A1\u8FC7\u591A\uFF0C\u9879\u76EE\u5EF6\u671F\u98CE\u9669\u8F83\u9AD8",probability:.7,impact:8,riskScore:5.6,affectedTaskIds:r.map(o=>o.id),category:"schedule"});let s=e.filter(o=>this.getTaskDuration(o)>40);return s.length>0&&t.push({id:"long-duration-risk",name:"\u957F\u6301\u7EED\u65F6\u95F4\u4EFB\u52A1\u98CE\u9669",description:"\u5B58\u5728\u6301\u7EED\u65F6\u95F4\u8FC7\u957F\u7684\u4EFB\u52A1\uFF0C\u53EF\u80FD\u5F71\u54CD\u9879\u76EE\u8FDB\u5EA6",probability:.5,impact:6,riskScore:3,affectedTaskIds:s.map(o=>o.id),category:"schedule"}),t}analyzeResourceRisks(e){let t=[];return this.calculateResourceUtilization(e).filter(o=>o.overallocation>0).length>0&&t.push({id:"resource-overallocation-risk",name:"\u8D44\u6E90\u8FC7\u5EA6\u5206\u914D\u98CE\u9669",description:"\u90E8\u5206\u8D44\u6E90\u5206\u914D\u8D85\u51FA\u53EF\u7528\u5BB9\u91CF",probability:.8,impact:7,riskScore:5.6,affectedTaskIds:e.map(o=>o.id),category:"resource"}),t}analyzeTechnicalRisks(e){let t=[],r=e.filter(s=>(s.orchestrationMetadata?.complexity||0)>7);return r.length>0&&t.push({id:"technical-complexity-risk",name:"\u6280\u672F\u590D\u6742\u5EA6\u98CE\u9669",description:"\u5B58\u5728\u9AD8\u590D\u6742\u5EA6\u7684\u6280\u672F\u4EFB\u52A1",probability:.6,impact:7,riskScore:4.2,affectedTaskIds:r.map(s=>s.id),category:"technical"}),t}analyzeQualityRisks(e){let t=[],r=e.filter(s=>s.orchestrationMetadata?.requiresReview===!1);return r.length>e.length*.5&&t.push({id:"quality-review-risk",name:"\u8D28\u91CF\u8BC4\u5BA1\u98CE\u9669",description:"\u8FC7\u591A\u4EFB\u52A1\u7F3A\u5C11\u8D28\u91CF\u8BC4\u5BA1\u73AF\u8282",probability:.4,impact:6,riskScore:2.4,affectedTaskIds:r.map(s=>s.id),category:"quality"}),t}generateMitigationSuggestions(e){let t=[];for(let r of e)switch(r.category){case"schedule":r.id==="critical-path-risk"&&(t.push("\u8003\u8651\u589E\u52A0\u5173\u952E\u8DEF\u5F84\u4E0A\u7684\u8D44\u6E90\u6295\u5165"),t.push("\u5BFB\u627E\u53EF\u4EE5\u5E76\u884C\u5316\u7684\u5173\u952E\u4EFB\u52A1"),t.push("\u8BC4\u4F30\u662F\u5426\u53EF\u4EE5\u7F29\u77ED\u5173\u952E\u4EFB\u52A1\u7684\u6301\u7EED\u65F6\u95F4")),r.id==="long-duration-risk"&&(t.push("\u5C06\u957F\u6301\u7EED\u65F6\u95F4\u4EFB\u52A1\u5206\u89E3\u4E3A\u66F4\u5C0F\u7684\u5B50\u4EFB\u52A1"),t.push("\u589E\u52A0\u91CC\u7A0B\u7891\u68C0\u67E5\u70B9"));break;case"resource":r.id==="resource-overallocation-risk"&&(t.push("\u91CD\u65B0\u5E73\u8861\u8D44\u6E90\u5206\u914D"),t.push("\u8003\u8651\u589E\u52A0\u989D\u5916\u8D44\u6E90\u6216\u5916\u5305"),t.push("\u8C03\u6574\u4EFB\u52A1\u65F6\u95F4\u5B89\u6392\u4EE5\u907F\u514D\u8D44\u6E90\u51B2\u7A81"));break;case"technical":r.id==="technical-complexity-risk"&&(t.push("\u4E3A\u9AD8\u590D\u6742\u5EA6\u4EFB\u52A1\u5206\u914D\u7ECF\u9A8C\u4E30\u5BCC\u7684\u56E2\u961F\u6210\u5458"),t.push("\u589E\u52A0\u6280\u672F\u8BC4\u5BA1\u548C\u539F\u578B\u9A8C\u8BC1"),t.push("\u8003\u8651\u6280\u672F\u57F9\u8BAD\u6216\u5916\u90E8\u54A8\u8BE2"));break;case"quality":r.id==="quality-review-risk"&&(t.push("\u4E3A\u5173\u952E\u4EFB\u52A1\u589E\u52A0\u8D28\u91CF\u8BC4\u5BA1\u73AF\u8282"),t.push("\u5EFA\u7ACB\u4EE3\u7801\u5BA1\u67E5\u548C\u6D4B\u8BD5\u6807\u51C6"),t.push("\u5B9E\u65BD\u6301\u7EED\u96C6\u6210\u548C\u81EA\u52A8\u5316\u6D4B\u8BD5"));break}return t}generateContingencyPlans(e){let t=[];for(let r of e)r.riskScore>4&&t.push({id:`contingency-${r.id}`,name:`${r.name}\u5E94\u6025\u8BA1\u5212`,description:`\u9488\u5BF9${r.name}\u7684\u5E94\u6025\u54CD\u5E94\u8BA1\u5212`,triggerConditions:[`${r.name}\u53D1\u751F\u6982\u7387\u8D85\u8FC7\u9608\u503C`,"\u9879\u76EE\u8FDB\u5EA6\u51FA\u73B0\u660E\u663E\u5EF6\u8FDF","\u76F8\u5173\u4EFB\u52A1\u72B6\u6001\u5F02\u5E38"],actions:["\u7ACB\u5373\u8BC4\u4F30\u5F71\u54CD\u8303\u56F4","\u542F\u52A8\u98CE\u9669\u54CD\u5E94\u6D41\u7A0B","\u8C03\u6574\u9879\u76EE\u8BA1\u5212\u548C\u8D44\u6E90\u5206\u914D","\u901A\u77E5\u76F8\u5173\u5229\u76CA\u76F8\u5173\u8005"],estimatedCost:r.impact*1e3,estimatedTime:r.impact*2});return t}generateRecommendations(e,t,r,s,o){let n=[];if(t.length>0&&(n.push(`\u9879\u76EE\u5173\u952E\u8DEF\u5F84\u5305\u542B ${t.length} \u4E2A\u4EFB\u52A1\uFF0C\u5EFA\u8BAE\u91CD\u70B9\u5173\u6CE8\u8FD9\u4E9B\u4EFB\u52A1\u7684\u6267\u884C`),t.length>e.length*.4&&n.push("\u5173\u952E\u8DEF\u5F84\u4EFB\u52A1\u6BD4\u4F8B\u8F83\u9AD8\uFF0C\u5EFA\u8BAE\u5BFB\u627E\u4F18\u5316\u673A\u4F1A\u4EE5\u51CF\u5C11\u9879\u76EE\u98CE\u9669")),r.length>0){let d=r.reduce((w,h)=>w+h.length,0);n.push(`\u8BC6\u522B\u5230 ${r.length} \u4E2A\u5E76\u884C\u4EFB\u52A1\u7EC4\uFF0C\u5171 ${d} \u4E2A\u4EFB\u52A1\u53EF\u5E76\u884C\u6267\u884C`),n.push("\u5408\u7406\u5B89\u6392\u5E76\u884C\u4EFB\u52A1\u53EF\u4EE5\u663E\u8457\u7F29\u77ED\u9879\u76EE\u5468\u671F")}let a=s.filter(d=>d.utilizationRate>1);a.length>0&&n.push(`\u53D1\u73B0 ${a.length} \u4E2A\u8D44\u6E90\u8FC7\u5EA6\u5206\u914D\uFF0C\u5EFA\u8BAE\u8C03\u6574\u8D44\u6E90\u8BA1\u5212`);let c=s.filter(d=>d.utilizationRate<.5);c.length>0&&n.push(`\u53D1\u73B0 ${c.length} \u4E2A\u8D44\u6E90\u5229\u7528\u7387\u8F83\u4F4E\uFF0C\u53EF\u8003\u8651\u91CD\u65B0\u5206\u914D`),o.overallRiskLevel>6&&n.push("\u9879\u76EE\u6574\u4F53\u98CE\u9669\u7B49\u7EA7\u8F83\u9AD8\uFF0C\u5EFA\u8BAE\u5236\u5B9A\u8BE6\u7EC6\u7684\u98CE\u9669\u5E94\u5BF9\u8BA1\u5212");let g=e.filter(d=>this.getTaskDuration(d)>40);return g.length>0&&n.push(`\u53D1\u73B0 ${g.length} \u4E2A\u957F\u6301\u7EED\u65F6\u95F4\u4EFB\u52A1\uFF0C\u5EFA\u8BAE\u8003\u8651\u4EFB\u52A1\u5206\u89E3`),n}calculateTotalDuration(e){let t=0;for(let r of e){let s=this.graph.get(r.id);s&&s.outDegree===0&&(t=Math.max(t,s.earliestFinish))}return t}createEmptyRiskAssessment(){return{overallRiskLevel:0,riskFactors:[],mitigationSuggestions:[],contingencyPlans:[]}}getTaskDuration(e){return e.timeInfo?.estimatedDuration||e.estimatedHours||8}findDependency(e,t){for(let r of this.dependencies.values())if(r.predecessorId===e&&r.successorId===t)return r}updateTaskTimeInfo(e){let t=[...e];for(let r of t){let s=this.graph.get(r.id);s&&(r.timeInfo={estimatedDuration:this.getTaskDuration(r),earliestStart:new Date(Date.now()+s.earliestStart*60*60*1e3),latestStart:new Date(Date.now()+s.latestStart*60*60*1e3),earliestFinish:new Date(Date.now()+s.earliestFinish*60*60*1e3),latestFinish:new Date(Date.now()+s.latestFinish*60*60*1e3),totalFloat:s.totalFloat,freeFloat:s.freeFloat,isCritical:s.isCritical})}return t}getOrchestrationStats(){let e=this.tasks.size,t=Array.from(this.graph.values()).filter(a=>a.isCritical).length,r=this.identifyParallelGroups().length,s=Array.from(this.graph.values()).reduce((a,c)=>a+c.totalFloat,0),o=e>0?s/e:0,n=Math.max(...Array.from(this.graph.values()).map(a=>a.earliestFinish));return{totalTasks:e,criticalTasks:t,parallelGroups:r,averageFloat:o,longestPath:n}}};O();var B=class{static{u(this,"OrchestrationFactory")}static createEngine(e,t){let s={...e?this.getPresetConfig(e):this.getDefaultConfig(),...t};return new V(s)}static getPresetConfig(e){switch(e){case"agile_sprint":return this.getAgileSprintConfig();case"waterfall":return this.getWaterfallConfig();case"critical_chain":return this.getCriticalChainConfig();case"lean_startup":return this.getLeanStartupConfig();case"rapid_prototype":return this.getRapidPrototypeConfig();case"enterprise":return this.getEnterpriseConfig();case"research":return this.getResearchConfig();case"maintenance":return this.getMaintenanceConfig();default:return this.getDefaultConfig()}}static getDefaultConfig(){return{enableCriticalPath:!0,enableParallelOptimization:!0,enableResourceLeveling:!1,enableRiskAnalysis:!0,schedulingStrategy:"critical_path",optimizationGoal:"minimize_duration",maxParallelTasks:5,workingHoursPerDay:8,workingDaysPerWeek:5,bufferPercentage:.1}}static getAgileSprintConfig(){return{enableCriticalPath:!0,enableParallelOptimization:!0,enableResourceLeveling:!0,enableRiskAnalysis:!0,schedulingStrategy:"priority_first",optimizationGoal:"maximize_quality",maxParallelTasks:8,workingHoursPerDay:8,workingDaysPerWeek:5,bufferPercentage:.15}}static getWaterfallConfig(){return{enableCriticalPath:!0,enableParallelOptimization:!1,enableResourceLeveling:!0,enableRiskAnalysis:!0,schedulingStrategy:"critical_path",optimizationGoal:"minimize_risk",maxParallelTasks:3,workingHoursPerDay:8,workingDaysPerWeek:5,bufferPercentage:.2}}static getCriticalChainConfig(){return{enableCriticalPath:!0,enableParallelOptimization:!0,enableResourceLeveling:!0,enableRiskAnalysis:!0,schedulingStrategy:"critical_path",optimizationGoal:"balance_resources",maxParallelTasks:6,workingHoursPerDay:8,workingDaysPerWeek:5,bufferPercentage:.25}}static getLeanStartupConfig(){return{enableCriticalPath:!1,enableParallelOptimization:!0,enableResourceLeveling:!1,enableRiskAnalysis:!1,schedulingStrategy:"shortest_first",optimizationGoal:"minimize_duration",maxParallelTasks:10,workingHoursPerDay:10,workingDaysPerWeek:6,bufferPercentage:.05}}static getRapidPrototypeConfig(){return{enableCriticalPath:!1,enableParallelOptimization:!0,enableResourceLeveling:!1,enableRiskAnalysis:!1,schedulingStrategy:"shortest_first",optimizationGoal:"minimize_duration",maxParallelTasks:12,workingHoursPerDay:8,workingDaysPerWeek:5,bufferPercentage:.05}}static getEnterpriseConfig(){return{enableCriticalPath:!0,enableParallelOptimization:!0,enableResourceLeveling:!0,enableRiskAnalysis:!0,schedulingStrategy:"resource_leveling",optimizationGoal:"balance_resources",maxParallelTasks:15,workingHoursPerDay:8,workingDaysPerWeek:5,bufferPercentage:.2}}static getResearchConfig(){return{enableCriticalPath:!1,enableParallelOptimization:!1,enableResourceLeveling:!1,enableRiskAnalysis:!0,schedulingStrategy:"longest_first",optimizationGoal:"maximize_quality",maxParallelTasks:3,workingHoursPerDay:6,workingDaysPerWeek:5,bufferPercentage:.3}}static getMaintenanceConfig(){return{enableCriticalPath:!1,enableParallelOptimization:!0,enableResourceLeveling:!0,enableRiskAnalysis:!1,schedulingStrategy:"priority_first",optimizationGoal:"minimize_cost",maxParallelTasks:6,workingHoursPerDay:8,workingDaysPerWeek:5,bufferPercentage:.1}}static getAvailablePresets(){return[{preset:"agile_sprint",name:"\u654F\u6377\u51B2\u523A",description:"\u9002\u7528\u4E8E\u654F\u6377\u5F00\u53D1\u7684\u8FED\u4EE3\u5F0F\u9879\u76EE\u7BA1\u7406",suitableFor:["\u654F\u6377\u5F00\u53D1","Scrum","\u8FED\u4EE3\u5F00\u53D1","\u5FEB\u901F\u4EA4\u4ED8"]},{preset:"waterfall",name:"\u7011\u5E03\u6A21\u578B",description:"\u4F20\u7EDF\u7684\u987A\u5E8F\u5F0F\u9879\u76EE\u7BA1\u7406\u65B9\u6CD5",suitableFor:["\u4F20\u7EDF\u9879\u76EE","\u9700\u6C42\u660E\u786E","\u98CE\u9669\u63A7\u5236","\u5408\u89C4\u8981\u6C42"]},{preset:"critical_chain",name:"\u5173\u952E\u94FE",description:"\u57FA\u4E8E\u7EA6\u675F\u7406\u8BBA\u7684\u9879\u76EE\u7BA1\u7406\u65B9\u6CD5",suitableFor:["\u8D44\u6E90\u7EA6\u675F","\u591A\u9879\u76EE\u7BA1\u7406","\u7F13\u51B2\u533A\u7BA1\u7406"]},{preset:"lean_startup",name:"\u7CBE\u76CA\u521B\u4E1A",description:"\u5FEB\u901F\u8FED\u4EE3\u548C\u9A8C\u8BC1\u7684\u521B\u4E1A\u9879\u76EE\u7BA1\u7406",suitableFor:["\u521B\u4E1A\u9879\u76EE","\u5FEB\u901F\u9A8C\u8BC1","MVP\u5F00\u53D1","\u5E02\u573A\u8BD5\u9519"]},{preset:"rapid_prototype",name:"\u5FEB\u901F\u539F\u578B",description:"\u4E13\u6CE8\u4E8E\u5FEB\u901F\u6784\u5EFA\u539F\u578B\u7684\u9879\u76EE\u7BA1\u7406",suitableFor:["\u539F\u578B\u5F00\u53D1","\u6982\u5FF5\u9A8C\u8BC1","\u5FEB\u901F\u6F14\u793A"]},{preset:"enterprise",name:"\u4F01\u4E1A\u7EA7",description:"\u9002\u7528\u4E8E\u5927\u578B\u4F01\u4E1A\u7684\u590D\u6742\u9879\u76EE\u7BA1\u7406",suitableFor:["\u5927\u578B\u9879\u76EE","\u591A\u56E2\u961F\u534F\u4F5C","\u4F01\u4E1A\u6CBB\u7406","\u5408\u89C4\u7BA1\u7406"]},{preset:"research",name:"\u7814\u7A76\u9879\u76EE",description:"\u9002\u7528\u4E8E\u7814\u7A76\u548C\u63A2\u7D22\u6027\u9879\u76EE",suitableFor:["\u79D1\u7814\u9879\u76EE","\u6280\u672F\u63A2\u7D22","\u4E0D\u786E\u5B9A\u6027\u9AD8","\u521B\u65B0\u7814\u53D1"]},{preset:"maintenance",name:"\u7EF4\u62A4\u9879\u76EE",description:"\u9002\u7528\u4E8E\u7CFB\u7EDF\u7EF4\u62A4\u548C\u8FD0\u8425\u9879\u76EE",suitableFor:["\u7CFB\u7EDF\u7EF4\u62A4","\u8FD0\u8425\u652F\u6301","\u7F3A\u9677\u4FEE\u590D","\u6027\u80FD\u4F18\u5316"]}]}static recommendPreset(e){let{teamSize:t=5,projectDuration:r=30,uncertaintyLevel:s=5,qualityRequirement:o=7,timeConstraint:n=5,budgetConstraint:a=5,isAgile:c=!1,isResearch:g=!1,isEnterprise:d=!1}=e;return d||t>20?"enterprise":g||s>8?"research":c||n>7&&r<90?"agile_sprint":r<14&&n>8?"rapid_prototype":s>6&&n>6&&t<10?"lean_startup":o<6&&s<4?"maintenance":s<4&&o>8?"waterfall":a>7||t>10?"critical_chain":"agile_sprint"}};z();x();z();z();S();x();O();z();var Ct="1.3.0";var rt=m(require("fs-extra"));var J=m(require("fs-extra")),St=m(require("path")),b=m(require("chalk"));W();var _e=m(require("conf")),Be=m(require("fs-extra")),Ge=m(require("path"));S();var ne=class{constructor(e="mcp"){this.projectConf=null;this.conf=new _e.default({configName:e,defaults:se});let t=Ge.default.join(process.cwd(),"mcp.config.json");if(Be.default.existsSync(t))try{this.projectConf=new _e.default({configName:"mcp.config",cwd:process.cwd(),defaults:se})}catch(r){console.error("Failed to load project configuration:",r)}}static{u(this,"ConfigManager")}getConfig(){return this.projectConf?{...this.conf.store,...this.projectConf.store,models:{...this.conf.store.models,...this.projectConf.store.models}}:this.conf.store}updateConfig(e,t=!1){let r=t&&this.projectConf?this.projectConf:this.conf,s=u((o,n)=>{for(let a in n)n[a]instanceof Object&&a in o?s(o[a],n[a]):o[a]=n[a];return o},"mergeDeep");r.store=s({...r.store},e)}set(e,t,r=!1){(r&&this.projectConf?this.projectConf:this.conf).set(e,t)}get(e,t){return this.projectConf&&this.projectConf.has(e)?this.projectConf.get(e):this.conf.get(e,t)}has(e){return this.projectConf?.has(e)||this.conf.has(e)}delete(e,t=!1){(t&&this.projectConf?this.projectConf:this.conf).delete(e)}reset(e=!1){let t=e&&this.projectConf?this.projectConf:this.conf;t.store=se}initProjectConfig(e){let t=Ge.default.join(e,"mcp.config.json");Be.default.writeJsonSync(t,se,{spaces:2}),this.projectConf=new _e.default({configName:"mcp.config",cwd:e,defaults:se})}getDefaultModelType(){return this.get("models.default","baidu")}setDefaultModelType(e,t=!1){this.set("models.default",e,t)}getConfigPath(e=!1){return(e&&this.projectConf?this.projectConf:this.conf).path}};re();S();var We=class{static{u(this,"VisualizeCommand")}constructor(){this.logger=E.getInstance({level:"info",output:"console"}),this.configManager=new ne,this.taskManager=new N(this.logger,this.configManager),this.visualizer=new ge(this.logger)}register(e){let t=e.command("visualize").alias("viz").description("\u751F\u6210\u4EFB\u52A1\u8BA1\u5212\u53EF\u89C6\u5316\u56FE\u8868").option("-t, --type <type>","\u53EF\u89C6\u5316\u7C7B\u578B (gantt|dependency|kanban|timeline|progress)","gantt").option("-f, --format <format>","\u8F93\u51FA\u683C\u5F0F (mermaid|json|html)","mermaid").option("-o, --output <path>","\u8F93\u51FA\u6587\u4EF6\u8DEF\u5F84").option("-i, --input <path>","\u4EFB\u52A1\u8BA1\u5212\u6587\u4EF6\u8DEF\u5F84").option("--include-subtasks","\u5305\u542B\u5B50\u4EFB\u52A1").option("--show-progress","\u663E\u793A\u8FDB\u5EA6\u4FE1\u606F").option("--group-by <field>","\u5206\u7EC4\u5B57\u6BB5 (type|assignee|priority)").action(async r=>{await this.handleVisualize(r)});t.command("gantt").description("\u751F\u6210\u7518\u7279\u56FE").option("-o, --output <path>","\u8F93\u51FA\u6587\u4EF6\u8DEF\u5F84").option("-i, --input <path>","\u4EFB\u52A1\u8BA1\u5212\u6587\u4EF6\u8DEF\u5F84").action(async r=>{await this.handleVisualize({...r,type:"gantt"})}),t.command("dependency").alias("deps").description("\u751F\u6210\u4F9D\u8D56\u5173\u7CFB\u56FE").option("-o, --output <path>","\u8F93\u51FA\u6587\u4EF6\u8DEF\u5F84").option("-i, --input <path>","\u4EFB\u52A1\u8BA1\u5212\u6587\u4EF6\u8DEF\u5F84").action(async r=>{await this.handleVisualize({...r,type:"dependency"})}),t.command("kanban").description("\u751F\u6210\u770B\u677F\u89C6\u56FE").option("-o, --output <path>","\u8F93\u51FA\u6587\u4EF6\u8DEF\u5F84").option("-i, --input <path>","\u4EFB\u52A1\u8BA1\u5212\u6587\u4EF6\u8DEF\u5F84").option("--group-by <field>","\u5206\u7EC4\u5B57\u6BB5 (type|assignee|priority)").action(async r=>{await this.handleVisualize({...r,type:"kanban"})}),t.command("progress").description("\u751F\u6210\u8FDB\u5EA6\u56FE\u8868").option("-o, --output <path>","\u8F93\u51FA\u6587\u4EF6\u8DEF\u5F84").option("-i, --input <path>","\u4EFB\u52A1\u8BA1\u5212\u6587\u4EF6\u8DEF\u5F84").action(async r=>{await this.handleVisualize({...r,type:"progress"})})}async handleVisualize(e){try{console.log(b.default.blue("\u{1F3A8} TaskFlow AI - \u4EFB\u52A1\u53EF\u89C6\u5316")),console.log();let t=["gantt","dependency","kanban","timeline","progress"],r=e.type||"gantt";if(!t.includes(r)){console.error(b.default.red(`\u274C \u65E0\u6548\u7684\u53EF\u89C6\u5316\u7C7B\u578B: ${r}`)),console.log(b.default.gray(`\u652F\u6301\u7684\u7C7B\u578B: ${t.join(", ")}`));return}let s=await this.loadTaskPlan(e.input);if(!s)return;console.log(b.default.green(`\u2705 \u5DF2\u52A0\u8F7D\u4EFB\u52A1\u8BA1\u5212: ${s.name}`)),console.log(b.default.gray(`   \u4EFB\u52A1\u6570\u91CF: ${s.tasks.length}`)),console.log(),console.log(b.default.blue(`\u{1F504} \u751F\u6210 ${r} \u53EF\u89C6\u5316...`));let o={type:r,format:e.format||"mermaid",includeSubtasks:e.includeSubtasks||!1,showProgress:e.showProgress||!1,groupBy:e.groupBy},n=this.visualizer.generateVisualization(s,o);if(e.output){let a=e.format||"mermaid";await this.saveVisualization(JSON.stringify(n),e.output,a),console.log(b.default.green(`\u2705 \u53EF\u89C6\u5316\u5DF2\u4FDD\u5B58\u5230: ${e.output}`))}else typeof n=="string"?(console.log(b.default.cyan("\u{1F4CA} \u53EF\u89C6\u5316\u7ED3\u679C:")),console.log(),console.log(n)):(console.log(b.default.cyan("\u{1F4CA} \u53EF\u89C6\u5316\u6570\u636E:")),console.log(),console.log(JSON.stringify(n,null,2)));console.log(),console.log(b.default.green("\u{1F389} \u53EF\u89C6\u5316\u751F\u6210\u5B8C\u6210!")),this.showUsageTips(r,e.format||"mermaid")}catch(t){console.error(b.default.red("\u274C \u53EF\u89C6\u5316\u751F\u6210\u5931\u8D25:")),console.error(b.default.red(t.message)),this.logger.error(`\u53EF\u89C6\u5316\u751F\u6210\u5931\u8D25: ${t.message}`)}}async loadTaskPlan(e){try{if(e)return J.existsSync(e)?await this.taskManager.loadTaskPlan(e):(console.error(b.default.red(`\u274C \u4EFB\u52A1\u8BA1\u5212\u6587\u4EF6\u4E0D\u5B58\u5728: ${e}`)),null);{let t=["./taskflow/tasks.json","./tasks/tasks.json","./tasks.json"];for(let r of t)if(J.existsSync(r))return await this.taskManager.loadTaskPlan(r);return console.error(b.default.red("\u274C \u672A\u627E\u5230\u4EFB\u52A1\u8BA1\u5212\u6587\u4EF6")),console.log(b.default.gray("\u8BF7\u4F7F\u7528 -i \u9009\u9879\u6307\u5B9A\u4EFB\u52A1\u8BA1\u5212\u6587\u4EF6\u8DEF\u5F84\uFF0C\u6216\u786E\u4FDD\u4EE5\u4E0B\u4F4D\u7F6E\u5B58\u5728\u4EFB\u52A1\u6587\u4EF6:")),t.forEach(r=>console.log(b.default.gray(`  - ${r}`))),null}}catch(t){return console.error(b.default.red(`\u274C \u52A0\u8F7D\u4EFB\u52A1\u8BA1\u5212\u5931\u8D25: ${t.message}`)),null}}async saveVisualization(e,t,r){await J.ensureDir(St.dirname(t)),typeof e=="string"?await J.writeFile(t,e,"utf-8"):await J.writeFile(t,JSON.stringify(e,null,2),"utf-8")}showUsageTips(e,t){switch(console.log(b.default.cyan("\u{1F4A1} \u4F7F\u7528\u63D0\u793A:")),t==="mermaid"&&(console.log(b.default.gray("  - \u53EF\u4EE5\u5C06Mermaid\u4EE3\u7801\u590D\u5236\u5230 https://mermaid.live \u67E5\u770B\u56FE\u8868")),console.log(b.default.gray("  - \u6216\u5728\u652F\u6301Mermaid\u7684Markdown\u7F16\u8F91\u5668\u4E2D\u4F7F\u7528"))),e){case"gantt":console.log(b.default.gray("  - \u7518\u7279\u56FE\u663E\u793A\u4EFB\u52A1\u65F6\u95F4\u5B89\u6392\u548C\u4F9D\u8D56\u5173\u7CFB")),console.log(b.default.gray("  - \u53EF\u7528\u4E8E\u9879\u76EE\u65F6\u95F4\u89C4\u5212\u548C\u8FDB\u5EA6\u8DDF\u8E2A"));break;case"dependency":console.log(b.default.gray("  - \u4F9D\u8D56\u5173\u7CFB\u56FE\u663E\u793A\u4EFB\u52A1\u95F4\u7684\u4F9D\u8D56\u5173\u7CFB")),console.log(b.default.gray("  - \u6709\u52A9\u4E8E\u8BC6\u522B\u5173\u952E\u8DEF\u5F84\u548C\u6F5C\u5728\u74F6\u9888"));break;case"kanban":console.log(b.default.gray("  - \u770B\u677F\u89C6\u56FE\u9002\u5408\u654F\u6377\u5F00\u53D1\u6D41\u7A0B")),console.log(b.default.gray("  - \u53EF\u6309\u72B6\u6001\u3001\u8D1F\u8D23\u4EBA\u6216\u4F18\u5148\u7EA7\u5206\u7EC4"));break;case"progress":console.log(b.default.gray("  - \u8FDB\u5EA6\u56FE\u8868\u663E\u793A\u9879\u76EE\u6574\u4F53\u5B8C\u6210\u60C5\u51B5")),console.log(b.default.gray("  - \u9002\u5408\u5411\u7BA1\u7406\u5C42\u6C47\u62A5\u9879\u76EE\u72B6\u6001"));break}}},Et=new We;var Je=m(require("fs-extra")),p=m(require("chalk"));W();re();O();S();var Ye=class{static{u(this,"StatusCommand")}constructor(){this.logger=E.getInstance({level:"info",output:"console"}),this.configManager=new ne,this.taskManager=new N(this.logger,this.configManager)}register(e){let t=e.command("status").description("\u67E5\u770B\u548C\u7BA1\u7406\u4EFB\u52A1\u72B6\u6001").option("-i, --input <path>","\u4EFB\u52A1\u8BA1\u5212\u6587\u4EF6\u8DEF\u5F84").option("-f, --filter <filter>","\u8FC7\u6EE4\u6761\u4EF6 (status|type|assignee|priority)").option("-v, --verbose","\u663E\u793A\u8BE6\u7EC6\u4FE1\u606F").action(async r=>{await this.handleStatus(r)});t.command("update <taskId> <status>").description("\u66F4\u65B0\u4EFB\u52A1\u72B6\u6001").option("-i, --input <path>","\u4EFB\u52A1\u8BA1\u5212\u6587\u4EF6\u8DEF\u5F84").action(async(r,s,o)=>{await this.handleUpdateStatus(r,s,o)}),t.command("progress").alias("stats").description("\u663E\u793A\u9879\u76EE\u8FDB\u5EA6\u7EDF\u8BA1").option("-i, --input <path>","\u4EFB\u52A1\u8BA1\u5212\u6587\u4EF6\u8DEF\u5F84").action(async r=>{await this.handleProgress(r)}),t.command("next").description("\u83B7\u53D6\u63A8\u8350\u7684\u4E0B\u4E00\u4E2A\u4EFB\u52A1").option("-i, --input <path>","\u4EFB\u52A1\u8BA1\u5212\u6587\u4EF6\u8DEF\u5F84").option("-n, --number <count>","\u663E\u793A\u4EFB\u52A1\u6570\u91CF","3").action(async r=>{await this.handleNext(r)}),t.command("list").alias("ls").description("\u5217\u51FA\u6240\u6709\u4EFB\u52A1").option("-i, --input <path>","\u4EFB\u52A1\u8BA1\u5212\u6587\u4EF6\u8DEF\u5F84").option("-s, --status <status>","\u6309\u72B6\u6001\u8FC7\u6EE4").option("-t, --type <type>","\u6309\u7C7B\u578B\u8FC7\u6EE4").option("-a, --assignee <assignee>","\u6309\u8D1F\u8D23\u4EBA\u8FC7\u6EE4").option("-p, --priority <priority>","\u6309\u4F18\u5148\u7EA7\u8FC7\u6EE4").action(async r=>{await this.handleList(r)})}async handleStatus(e){try{console.log(p.default.blue("\u{1F4CA} TaskFlow AI - \u4EFB\u52A1\u72B6\u6001")),console.log();let t=await this.loadTaskPlan(e.input);if(!t)return;console.log(p.default.green(`\u2705 \u9879\u76EE: ${t.name}`)),console.log(p.default.gray(`   \u63CF\u8FF0: ${t.description}`)),console.log(),await this.showProgressStats(t),e.verbose&&(console.log(p.default.cyan("\u{1F4CB} \u4EFB\u52A1\u5217\u8868:")),console.log(),this.displayTaskList(t.tasks,e))}catch(t){console.error(p.default.red("\u274C \u83B7\u53D6\u72B6\u6001\u5931\u8D25:")),console.error(p.default.red(t.message))}}async handleUpdateStatus(e,t,r){try{console.log(p.default.blue("\u{1F504} TaskFlow AI - \u66F4\u65B0\u4EFB\u52A1\u72B6\u6001")),console.log();let s=Object.values(q);if(!s.includes(t)){console.error(p.default.red(`\u274C \u65E0\u6548\u7684\u72B6\u6001\u503C: ${t}`)),console.log(p.default.gray(`\u652F\u6301\u7684\u72B6\u6001: ${s.join(", ")}`));return}let o=await this.loadTaskPlan(r.input);if(!o)return;this.taskManager.setTaskPlan(o);let n=this.taskManager.updateTask(e,{status:t});if(!n){console.error(p.default.red(`\u274C \u4EFB\u52A1\u4E0D\u5B58\u5728: ${e}`));return}if(await this.taskManager.saveTaskPlan(),console.log(p.default.green("\u2705 \u4EFB\u52A1\u72B6\u6001\u5DF2\u66F4\u65B0:")),console.log(p.default.gray(`   \u4EFB\u52A1: ${n.title}`)),console.log(p.default.gray(`   \u72B6\u6001: ${this.getStatusDisplay(n.status)} \u2192 ${this.getStatusDisplay(t)}`)),t==="completed"){let a=this.taskManager.getNextTasks();a.length>0&&(console.log(),console.log(p.default.cyan("\u{1F3AF} \u63A8\u8350\u7684\u4E0B\u4E00\u4E2A\u4EFB\u52A1:")),a.slice(0,3).forEach(c=>{console.log(p.default.gray(`   - ${c.title} (${c.priority})`))}))}}catch(s){console.error(p.default.red("\u274C \u66F4\u65B0\u72B6\u6001\u5931\u8D25:")),console.error(p.default.red(s.message))}}async handleProgress(e){try{console.log(p.default.blue("\u{1F4C8} TaskFlow AI - \u9879\u76EE\u8FDB\u5EA6")),console.log();let t=await this.loadTaskPlan(e.input);if(!t)return;await this.showProgressStats(t)}catch(t){console.error(p.default.red("\u274C \u83B7\u53D6\u8FDB\u5EA6\u5931\u8D25:")),console.error(p.default.red(t.message))}}async handleNext(e){try{console.log(p.default.blue("\u{1F3AF} TaskFlow AI - \u63A8\u8350\u4EFB\u52A1")),console.log();let t=await this.loadTaskPlan(e.input);if(!t)return;this.taskManager.setTaskPlan(t);let r=this.taskManager.getNextTasks();if(r.length===0){console.log(p.default.yellow("\u{1F389} \u6240\u6709\u4EFB\u52A1\u90FD\u5DF2\u5B8C\u6210\u6216\u88AB\u963B\u585E!"));return}let s=Math.min(parseInt(String(e.count))||3,r.length);console.log(p.default.green(`\u2705 \u63A8\u8350\u7684 ${s} \u4E2A\u4EFB\u52A1:`)),console.log(),r.slice(0,s).forEach((o,n)=>{console.log(p.default.cyan(`${n+1}. ${o.title}`)),console.log(p.default.gray(`   ID: ${o.id}`)),console.log(p.default.gray(`   \u4F18\u5148\u7EA7: ${this.getPriorityDisplay(o.priority)}`)),console.log(p.default.gray(`   \u7C7B\u578B: ${o.type}`)),console.log(p.default.gray(`   \u9884\u8BA1\u65F6\u95F4: ${o.estimatedHours||8} \u5C0F\u65F6`)),o.assignee&&console.log(p.default.gray(`   \u8D1F\u8D23\u4EBA: ${o.assignee}`)),console.log()})}catch(t){console.error(p.default.red("\u274C \u83B7\u53D6\u63A8\u8350\u4EFB\u52A1\u5931\u8D25:")),console.error(p.default.red(t.message))}}async handleList(e){try{console.log(p.default.blue("\u{1F4CB} TaskFlow AI - \u4EFB\u52A1\u5217\u8868")),console.log();let t=await this.loadTaskPlan(e.input);if(!t)return;this.taskManager.setTaskPlan(t);let r={};e.status&&(r.status=e.status),e.type&&(r.type=e.type),e.assignee&&(r.assignee=e.assignee),e.priority&&(r.priority=e.priority);let s=Object.keys(r).length>0?this.taskManager.filterTasks(r):this.taskManager.getAllTasks();if(s.length===0){console.log(p.default.yellow("\u{1F4ED} \u6CA1\u6709\u627E\u5230\u5339\u914D\u7684\u4EFB\u52A1"));return}console.log(p.default.green(`\u2705 \u627E\u5230 ${s.length} \u4E2A\u4EFB\u52A1:`)),console.log(),this.displayTaskList(s,e)}catch(t){console.error(p.default.red("\u274C \u83B7\u53D6\u4EFB\u52A1\u5217\u8868\u5931\u8D25:")),console.error(p.default.red(t.message))}}async loadTaskPlan(e){try{if(e)return Je.existsSync(e)?await this.taskManager.loadTaskPlan(e):(console.error(p.default.red(`\u274C \u4EFB\u52A1\u8BA1\u5212\u6587\u4EF6\u4E0D\u5B58\u5728: ${e}`)),null);{let t=["./taskflow/tasks.json","./tasks/tasks.json","./tasks.json"];for(let r of t)if(Je.existsSync(r))return await this.taskManager.loadTaskPlan(r);return console.error(p.default.red("\u274C \u672A\u627E\u5230\u4EFB\u52A1\u8BA1\u5212\u6587\u4EF6")),console.log(p.default.gray("\u8BF7\u4F7F\u7528 -i \u9009\u9879\u6307\u5B9A\u4EFB\u52A1\u8BA1\u5212\u6587\u4EF6\u8DEF\u5F84")),null}}catch(t){return console.error(p.default.red(`\u274C \u52A0\u8F7D\u4EFB\u52A1\u8BA1\u5212\u5931\u8D25: ${t.message}`)),null}}async showProgressStats(e){let t={total:e.tasks.length,completed:0,inProgress:0,notStarted:0,blocked:0};e.tasks.forEach(o=>{switch(o.status){case"completed":t.completed++;break;case"in_progress":t.inProgress++;break;case"not_started":t.notStarted++;break;case"blocked":t.blocked++;break}});let r=t.completed/t.total*100;console.log(p.default.cyan("\u{1F4CA} \u9879\u76EE\u8FDB\u5EA6:")),console.log(p.default.green(`   \u5B8C\u6210\u7387: ${r.toFixed(1)}%`)),console.log(p.default.gray(`   \u603B\u4EFB\u52A1: ${t.total}`)),console.log(p.default.gray(`   \u5DF2\u5B8C\u6210: ${t.completed}`)),console.log(p.default.gray(`   \u8FDB\u884C\u4E2D: ${t.inProgress}`)),console.log(p.default.gray(`   \u672A\u5F00\u59CB: ${t.notStarted}`)),console.log(p.default.gray(`   \u88AB\u963B\u585E: ${t.blocked}`)),console.log();let s=this.generateProgressBar(r);console.log(p.default.cyan(`\u8FDB\u5EA6: ${s} ${r.toFixed(1)}%`)),console.log()}displayTaskList(e,t){e.forEach((r,s)=>{let o=this.getStatusIcon(r.status),n=this.getPriorityColor(r.priority);console.log(`${o} ${n(r.title)}`),console.log(p.default.gray(`   ID: ${r.id}`)),console.log(p.default.gray(`   \u72B6\u6001: ${this.getStatusDisplay(r.status)}`)),console.log(p.default.gray(`   \u4F18\u5148\u7EA7: ${this.getPriorityDisplay(r.priority)}`)),r.assignee&&console.log(p.default.gray(`   \u8D1F\u8D23\u4EBA: ${r.assignee}`)),r.estimatedHours&&console.log(p.default.gray(`   \u9884\u8BA1\u65F6\u95F4: ${r.estimatedHours} \u5C0F\u65F6`)),r.dependencies&&r.dependencies.length>0&&console.log(p.default.gray(`   \u4F9D\u8D56: ${r.dependencies.join(", ")}`)),console.log()})}getStatusIcon(e){switch(e){case"completed":return"\u2705";case"in_progress":return"\u{1F504}";case"blocked":return"\u{1F6AB}";case"cancelled":return"\u274C";default:return"\u23F3"}}getStatusDisplay(e){switch(e){case"not_started":return"\u672A\u5F00\u59CB";case"in_progress":return"\u8FDB\u884C\u4E2D";case"completed":return"\u5DF2\u5B8C\u6210";case"blocked":return"\u88AB\u963B\u585E";case"cancelled":return"\u5DF2\u53D6\u6D88";default:return e}}getPriorityDisplay(e){switch(e){case"critical":return"\u7D27\u6025";case"high":return"\u9AD8";case"medium":return"\u4E2D";case"low":return"\u4F4E";default:return e}}getPriorityColor(e){switch(e){case"critical":return p.default.red;case"high":return p.default.yellow;case"medium":return p.default.blue;case"low":return p.default.gray;default:return p.default.white}}generateProgressBar(e){let r=Math.round(e/100*20),s=20-r;return p.default.green("\u2588".repeat(r))+p.default.gray("\u2591".repeat(s))}},vt=new Ye;var T=m(require("chalk")),R=m(require("inquirer")),me=m(require("ora")),Rt=m(require("boxen")),Mt=m(require("fs-extra"));z();x();O();var Qe=class{static{u(this,"InteractiveCommand")}register(e){e.command("interactive").alias("i").description("\u542F\u52A8\u4EA4\u4E92\u5F0F\u6A21\u5F0F").action(async()=>{await this.startInteractiveMode()})}async startInteractiveMode(){console.clear(),this.showWelcome();let e=!0;for(;e;)try{let{action:t}=await R.default.prompt([{type:"list",name:"action",message:"\u8BF7\u9009\u62E9\u8981\u6267\u884C\u7684\u64CD\u4F5C:",choices:[{name:"\u{1F4C4} \u89E3\u6790PRD\u6587\u6863",value:"parse"},{name:"\u{1F4CB} \u67E5\u770B\u4EFB\u52A1\u5217\u8868",value:"tasks"},{name:"\u2699\uFE0F  \u914D\u7F6E\u7BA1\u7406",value:"config"},{name:"\u{1F916} AI\u5BF9\u8BDD",value:"chat"},{name:"\u{1F4CA} \u9879\u76EE\u72B6\u6001",value:"status"},{name:"\u274C \u9000\u51FA",value:"exit"}]}]);if(t==="exit"){console.log(T.default.green(`
\u{1F44B} \u611F\u8C22\u4F7F\u7528 TaskFlow AI\uFF01`));break}await this.handleAction(t);let{continue:r}=await R.default.prompt([{type:"confirm",name:"continue",message:"\u662F\u5426\u7EE7\u7EED\u4F7F\u7528\uFF1F",default:!0}]);r||(console.log(T.default.green(`
\u{1F44B} \u611F\u8C22\u4F7F\u7528 TaskFlow AI\uFF01`)),e=!1),console.log(`
`+"\u2500".repeat(50)+`
`)}catch(t){console.error(T.default.red(`\u274C \u64CD\u4F5C\u5931\u8D25: ${t.message}`));let{retry:r}=await R.default.prompt([{type:"confirm",name:"retry",message:"\u662F\u5426\u91CD\u8BD5\uFF1F",default:!0}]);if(!r)break}}showWelcome(){let e=(0,Rt.default)(T.default.cyan.bold("TaskFlow AI")+`

`+T.default.white("\u667A\u80FDPRD\u6587\u6863\u89E3\u6790\u4E0E\u4EFB\u52A1\u7BA1\u7406\u52A9\u624B")+`
`+T.default.gray("\u8BA9AI\u5E2E\u60A8\u5C06\u4EA7\u54C1\u9700\u6C42\u8F6C\u5316\u4E3A\u53EF\u6267\u884C\u7684\u4EFB\u52A1\u8BA1\u5212"),{padding:1,margin:1,borderStyle:"round",borderColor:"cyan"});console.log(e)}async handleAction(e){switch(e){case"parse":await this.handleParsePRD();break;case"tasks":await this.handleViewTasks();break;case"config":await this.handleConfig();break;case"chat":await this.handleChat();break;case"status":await this.handleStatus();break}}async handleParsePRD(){console.log(T.default.blue(`
\u{1F4C4} PRD\u6587\u6863\u89E3\u6790`));let{inputType:e}=await R.default.prompt([{type:"list",name:"inputType",message:"\u8BF7\u9009\u62E9\u8F93\u5165\u65B9\u5F0F:",choices:[{name:"\u{1F4C1} \u4ECE\u6587\u4EF6\u8BFB\u53D6",value:"file"},{name:"\u270F\uFE0F  \u76F4\u63A5\u8F93\u5165\u6587\u672C",value:"text"}]}]),t="",r="";if(e==="file"){let{path:n}=await R.default.prompt([{type:"input",name:"path",message:"\u8BF7\u8F93\u5165PRD\u6587\u4EF6\u8DEF\u5F84:",validate:u(a=>a.trim()!==""||"\u6587\u4EF6\u8DEF\u5F84\u4E0D\u80FD\u4E3A\u7A7A","validate")}]);r=n}else{let{text:n}=await R.default.prompt([{type:"editor",name:"text",message:"\u8BF7\u8F93\u5165PRD\u6587\u6863\u5185\u5BB9:"}]);t=n}let{modelType:s}=await R.default.prompt([{type:"list",name:"modelType",message:"\u8BF7\u9009\u62E9AI\u6A21\u578B:",choices:[{name:"\u{1F680} DeepSeek (\u63A8\u8350)",value:"deepseek"},{name:"\u{1F9E0} \u667A\u8C31AI GLM",value:"zhipu"},{name:"\u{1F31F} \u901A\u4E49\u5343\u95EE",value:"qwen"},{name:"\u{1F4AB} \u6587\u5FC3\u4E00\u8A00",value:"wenxin"}]}]),o=(0,me.default)("\u6B63\u5728\u89E3\u6790PRD\u6587\u6863...").start();try{let n;if(e==="file"?n=await v.parsePRDFromFile(r,{modelType:s}):n=await v.parsePRD(t,"markdown",{modelType:s}),o.succeed("PRD\u89E3\u6790\u5B8C\u6210\uFF01"),n.success&&n.data){console.log(T.default.green(`
\u2705 \u89E3\u6790\u6210\u529F\uFF01`)),"sections"in n.data&&n.data.sections?console.log(T.default.white(`\u{1F4CB} \u89E3\u6790\u4E86 ${n.data.sections.length} \u4E2A\u7AE0\u8282`)):"metadata"in n.data&&n.data.metadata?.features?console.log(T.default.white(`\u{1F4CB} \u63D0\u53D6\u4E86 ${n.data.metadata.features.length} \u4E2A\u529F\u80FD\u7279\u6027`)):console.log(T.default.white("\u{1F4CB} PRD\u89E3\u6790\u5B8C\u6210"));let{save:a}=await R.default.prompt([{type:"confirm",name:"save",message:"\u662F\u5426\u4FDD\u5B58\u89E3\u6790\u7ED3\u679C\uFF1F",default:!0}]);if(a){let{outputPath:c}=await R.default.prompt([{type:"input",name:"outputPath",message:"\u8BF7\u8F93\u5165\u4FDD\u5B58\u8DEF\u5F84:",default:"./prd-parsed.json"}]);await Mt.writeJSON(c,n.data,{spaces:2}),console.log(T.default.green(`\u{1F4BE} \u89E3\u6790\u7ED3\u679C\u5DF2\u4FDD\u5B58\u5230: ${c}`))}}else console.log(T.default.red(`\u274C \u89E3\u6790\u5931\u8D25: ${n.error}`))}catch(n){throw o.fail("PRD\u89E3\u6790\u5931\u8D25"),n}}async handleViewTasks(){console.log(T.default.blue(`
\u{1F4CB} \u4EFB\u52A1\u5217\u8868`));let e=(0,me.default)("\u6B63\u5728\u83B7\u53D6\u4EFB\u52A1\u5217\u8868...").start();try{let t=v.getAllTasks();e.succeed("\u4EFB\u52A1\u5217\u8868\u83B7\u53D6\u5B8C\u6210"),t.success&&t.data&&t.data.length>0?(console.log(T.default.green(`
\u{1F4CA} \u5171\u6709 ${t.data.length} \u4E2A\u4EFB\u52A1
`)),t.data.forEach((r,s)=>{let o=this.getStatusIcon(r.status),n=this.getPriorityColor(r.priority);console.log(`${s+1}. ${o} ${T.default.white(r.title)} ${n(`[${r.priority}]`)} ${T.default.gray(`(${r.estimatedHours}h)`)}`)})):console.log(T.default.yellow("\u{1F4ED} \u6682\u65E0\u4EFB\u52A1"))}catch(t){throw e.fail("\u83B7\u53D6\u4EFB\u52A1\u5217\u8868\u5931\u8D25"),t}}async handleConfig(){console.log(T.default.blue(`
\u2699\uFE0F  \u914D\u7F6E\u7BA1\u7406`));let{configAction:e}=await R.default.prompt([{type:"list",name:"configAction",message:"\u8BF7\u9009\u62E9\u914D\u7F6E\u64CD\u4F5C:",choices:[{name:"\u{1F440} \u67E5\u770B\u5F53\u524D\u914D\u7F6E",value:"view"},{name:"\u{1F511} \u8BBE\u7F6EAPI\u5BC6\u94A5",value:"apikey"},{name:"\u{1F39B}\uFE0F  \u6A21\u578B\u8BBE\u7F6E",value:"model"}]}]);if(e==="view"){let t=v.getConfig();t.success&&(console.log(T.default.green(`
\u{1F4CB} \u5F53\u524D\u914D\u7F6E:`)),console.log(JSON.stringify(t.data,null,2)))}else e==="apikey"?await this.handleApiKeyConfig():e==="model"&&await this.handleModelConfig()}async handleApiKeyConfig(){let{modelType:e}=await R.default.prompt([{type:"list",name:"modelType",message:"\u8BF7\u9009\u62E9\u8981\u914D\u7F6E\u7684\u6A21\u578B:",choices:[{name:"DeepSeek",value:"deepseek"},{name:"\u667A\u8C31AI",value:"zhipu"},{name:"\u901A\u4E49\u5343\u95EE",value:"qwen"},{name:"\u6587\u5FC3\u4E00\u8A00",value:"wenxin"}]}]),{apiKey:t}=await R.default.prompt([{type:"password",name:"apiKey",message:`\u8BF7\u8F93\u5165${e}\u7684API\u5BC6\u94A5:`,mask:"*"}]),r={models:{[e]:{apiKey:t}}},s=v.updateConfig(r);s.success?console.log(T.default.green("\u2705 API\u5BC6\u94A5\u914D\u7F6E\u6210\u529F\uFF01")):console.log(T.default.red(`\u274C \u914D\u7F6E\u5931\u8D25: ${s.error}`))}async handleModelConfig(){let{defaultModel:e}=await R.default.prompt([{type:"list",name:"defaultModel",message:"\u8BF7\u9009\u62E9\u9ED8\u8BA4\u6A21\u578B:",choices:[{name:"DeepSeek",value:"deepseek"},{name:"\u667A\u8C31AI",value:"zhipu"},{name:"\u901A\u4E49\u5343\u95EE",value:"qwen"},{name:"\u6587\u5FC3\u4E00\u8A00",value:"wenxin"}]}]),t={models:{default:e}},r=v.updateConfig(t);r.success?console.log(T.default.green("\u2705 \u9ED8\u8BA4\u6A21\u578B\u8BBE\u7F6E\u6210\u529F\uFF01")):console.log(T.default.red(`\u274C \u8BBE\u7F6E\u5931\u8D25: ${r.error}`))}async handleChat(){console.log(T.default.blue(`
\u{1F916} AI\u5BF9\u8BDD\u6A21\u5F0F`)),console.log(T.default.gray(`\u8F93\u5165 "exit" \u9000\u51FA\u5BF9\u8BDD
`));let e=!0;for(;e;){let{message:t}=await R.default.prompt([{type:"input",name:"message",message:"\u60A8:",validate:u(s=>s.trim()!==""||"\u6D88\u606F\u4E0D\u80FD\u4E3A\u7A7A","validate")}]);if(t.toLowerCase()==="exit"){e=!1;continue}let r=(0,me.default)("AI\u6B63\u5728\u601D\u8003...").start();try{let s=await v.chat([{role:"user",content:t}]);r.stop(),s.success&&s.data?console.log(T.default.cyan("AI:"),s.data.content||s.data):console.log(T.default.red(`\u274C \u5BF9\u8BDD\u5931\u8D25: ${s.error}`))}catch(s){r.fail("\u5BF9\u8BDD\u5931\u8D25"),console.log(T.default.red(`\u274C ${s.message}`))}console.log()}}async handleStatus(){console.log(T.default.blue(`
\u{1F4CA} \u9879\u76EE\u72B6\u6001`));let e=(0,me.default)("\u6B63\u5728\u83B7\u53D6\u9879\u76EE\u72B6\u6001...").start();try{let t=v.getAllTasks(),r=v.getConfig();if(e.succeed("\u72B6\u6001\u83B7\u53D6\u5B8C\u6210"),t.success&&t.data){let s=t.data,o=s.filter(c=>c.status==="completed"||c.status==="done").length,n=s.filter(c=>c.status==="in_progress"||c.status==="running").length,a=s.filter(c=>c.status==="pending"||c.status==="not_started").length;console.log(T.default.green(`
\u{1F4C8} \u4EFB\u52A1\u7EDF\u8BA1:`)),console.log(`  \u2705 \u5DF2\u5B8C\u6210: ${o}`),console.log(`  \u{1F504} \u8FDB\u884C\u4E2D: ${n}`),console.log(`  \u23F3 \u5F85\u5F00\u59CB: ${a}`),console.log(`  \u{1F4CA} \u603B\u8BA1: ${s.length}`)}if(r.success&&r.data){let o=r.data.models;console.log(T.default.blue(`
\u2699\uFE0F  \u914D\u7F6E\u72B6\u6001:`)),console.log(`  \u{1F3AF} \u9ED8\u8BA4\u6A21\u578B: ${o?.default||"\u672A\u8BBE\u7F6E"}`),console.log(`  \u{1F511} \u5DF2\u914D\u7F6E\u6A21\u578B: ${Object.keys(o||{}).filter(n=>n!=="default").length}`)}}catch(t){throw e.fail("\u83B7\u53D6\u72B6\u6001\u5931\u8D25"),t}}getStatusIcon(e){return{pending:"\u23F3",in_progress:"\u{1F504}",completed:"\u2705",blocked:"\u{1F6AB}",cancelled:"\u274C"}[e]||"\u2753"}getPriorityColor(e){return{high:T.default.red,medium:T.default.yellow,low:T.default.green}[e]||T.default.gray}},Dt=new Qe;var C=m(require("chalk")),Ne=m(require("ora"));z();function Ze(i){let e=i.command("models").description("\u7BA1\u7406AI\u6A21\u578B\u914D\u7F6E\u548C\u72B6\u6001");e.command("list").description("\u5217\u51FA\u6240\u6709\u53EF\u7528\u7684AI\u6A21\u578B").option("--detailed","\u663E\u793A\u8BE6\u7EC6\u4FE1\u606F",!1).action(async t=>{try{console.log(C.default.blue("\u{1F4CB} \u53EF\u7528\u7684AI\u6A21\u578B:")),console.log();let r=[{type:"deepseek",name:"DeepSeek",description:"\u9AD8\u6027\u4EF7\u6BD4\uFF0C\u4EE3\u7801\u7406\u89E3\u80FD\u529B\u5F3A",status:"\u2705 \u53EF\u7528",cost:"\u4F4E",features:["\u4EE3\u7801\u751F\u6210","\u903B\u8F91\u63A8\u7406","\u4E2D\u82F1\u6587\u5BF9\u8BDD"]},{type:"zhipu",name:"\u667A\u8C31GLM-4",description:"\u7EFC\u5408\u80FD\u529B\u5F3A\uFF0C\u9002\u5408\u590D\u6742\u4EFB\u52A1",status:"\u2705 \u53EF\u7528",cost:"\u4E2D",features:["\u591A\u8F6E\u5BF9\u8BDD","\u6587\u6863\u7406\u89E3","\u521B\u610F\u5199\u4F5C"]},{type:"qwen",name:"\u901A\u4E49\u5343\u95EE",description:"\u963F\u91CC\u4E91\u5927\u6A21\u578B\uFF0C\u591A\u6A21\u6001\u652F\u6301",status:"\u2705 \u53EF\u7528",cost:"\u4E2D",features:["\u957F\u6587\u672C\u5904\u7406","\u591A\u6A21\u6001","\u4E13\u4E1A\u9886\u57DF"]},{type:"spark",name:"\u8BAF\u98DE\u661F\u706B",description:"\u8BED\u97F3\u4EA4\u4E92\u4F18\u5316\uFF0C\u6559\u80B2\u573A\u666F",status:"\u2705 \u53EF\u7528",cost:"\u4E2D",features:["\u8BED\u97F3\u7406\u89E3","\u6559\u80B2\u5185\u5BB9","\u5B9E\u65F6\u5BF9\u8BDD"]},{type:"moonshot",name:"\u6708\u4E4B\u6697\u9762Kimi",description:"\u8D85\u957F\u4E0A\u4E0B\u6587\uFF0C\u6587\u6863\u5904\u7406\u4E13\u5BB6",status:"\u2705 \u53EF\u7528",cost:"\u9AD8",features:["\u957F\u6587\u672C","\u6587\u6863\u5206\u6790","\u4FE1\u606F\u63D0\u53D6"]},{type:"baidu",name:"\u767E\u5EA6\u6587\u5FC3\u4E00\u8A00",description:"\u767E\u5EA6\u5927\u6A21\u578B\uFF0C\u4E2D\u6587\u4F18\u5316",status:"\u2705 \u53EF\u7528",cost:"\u4E2D",features:["\u4E2D\u6587\u7406\u89E3","\u521B\u610F\u751F\u6210","\u77E5\u8BC6\u95EE\u7B54"]}];for(let s of r)console.log(C.default.cyan(`\u{1F916} ${s.name} (${s.type})`)),console.log(`   ${s.description}`),console.log(`   \u72B6\u6001: ${s.status}`),console.log(`   \u6210\u672C: ${s.cost}`),t.detailed&&console.log(`   \u7279\u6027: ${s.features.join(", ")}`),console.log();console.log(C.default.yellow('\u{1F4A1} \u4F7F\u7528 "taskflow-ai models test <model>" \u6D4B\u8BD5\u6A21\u578B\u8FDE\u63A5')),console.log(C.default.yellow('\u{1F4A1} \u4F7F\u7528 "taskflow-ai config set models.default <model>" \u8BBE\u7F6E\u9ED8\u8BA4\u6A21\u578B'))}catch(r){console.error(C.default.red("\u274C \u83B7\u53D6\u6A21\u578B\u5217\u8868\u5931\u8D25:"),r)}}),e.command("test <model>").description("\u6D4B\u8BD5\u6307\u5B9A\u6A21\u578B\u7684\u8FDE\u63A5\u72B6\u6001").action(async t=>{let r=(0,Ne.default)(`\u6B63\u5728\u6D4B\u8BD5 ${t} \u6A21\u578B\u8FDE\u63A5...`).start();try{await xt(t)?r.succeed(C.default.green(`\u2705 ${t} \u6A21\u578B\u8FDE\u63A5\u6B63\u5E38`)):(r.fail(C.default.red(`\u274C ${t} \u6A21\u578B\u8FDE\u63A5\u5931\u8D25`)),console.log(C.default.yellow("\u8BF7\u68C0\u67E5:")),console.log("  1. API\u5BC6\u94A5\u662F\u5426\u6B63\u786E\u914D\u7F6E"),console.log("  2. \u7F51\u7EDC\u8FDE\u63A5\u662F\u5426\u6B63\u5E38"),console.log("  3. \u6A21\u578B\u670D\u52A1\u662F\u5426\u53EF\u7528"))}catch(s){r.fail(C.default.red(`\u274C \u6D4B\u8BD5 ${t} \u6A21\u578B\u65F6\u51FA\u9519: ${s}`))}}),e.command("benchmark").description("\u8FD0\u884C\u6A21\u578B\u6027\u80FD\u57FA\u51C6\u6D4B\u8BD5").option("--models <models>","\u6307\u5B9A\u6D4B\u8BD5\u7684\u6A21\u578B\uFF0C\u7528\u9017\u53F7\u5206\u9694","deepseek,zhipu,qwen").option("--iterations <count>","\u6D4B\u8BD5\u8FED\u4EE3\u6B21\u6570","3").action(async t=>{let r=t.models.split(",").map(a=>a.trim()),s=parseInt(t.iterations);console.log(C.default.blue("\u{1F3C3}\u200D\u2642\uFE0F \u5F00\u59CB\u6A21\u578B\u6027\u80FD\u57FA\u51C6\u6D4B\u8BD5")),console.log(`\u6D4B\u8BD5\u6A21\u578B: ${r.join(", ")}`),console.log(`\u8FED\u4EE3\u6B21\u6570: ${s}`),console.log();let o=[];for(let a of r){let c=(0,Ne.default)(`\u6D4B\u8BD5 ${a} \u6A21\u578B\u6027\u80FD...`).start();try{let g=await ur(a,s);o.push({model:a,success:!0,latency:g.avgLatency,avgLatency:g.avgLatency,successRate:g.successRate,tokensPerSecond:g.tokensPerSecond}),c.succeed(`\u2705 ${a} \u6D4B\u8BD5\u5B8C\u6210`)}catch(g){c.fail(`\u274C ${a} \u6D4B\u8BD5\u5931\u8D25: ${g}`),o.push({model:a,success:!1,latency:0,error:g instanceof Error?g.message:String(g)})}}console.log(),console.log(C.default.blue("\u{1F4CA} \u57FA\u51C6\u6D4B\u8BD5\u7ED3\u679C:")),console.log();let n=o.map(a=>a.error?`${a.model.padEnd(12)} | \u5931\u8D25: ${a.error}`:`${a.model.padEnd(12)} | ${a.avgLatency||a.latency}ms | ${a.successRate||0}% | ${a.tokensPerSecond||0} tokens/s`);console.log("\u6A21\u578B        | \u5E73\u5747\u5EF6\u8FDF | \u6210\u529F\u7387 | \u5904\u7406\u901F\u5EA6"),console.log("------------|----------|--------|----------"),n.forEach(a=>console.log(a))}),e.command("switch <model>").description("\u5207\u6362\u9ED8\u8BA4\u4F7F\u7528\u7684\u6A21\u578B").action(async t=>{let r=(0,Ne.default)(`\u6B63\u5728\u5207\u6362\u9ED8\u8BA4\u6A21\u578B\u5230 ${t}...`).start();try{if(!await xt(t)){r.fail(C.default.red(`\u274C \u65E0\u6CD5\u5207\u6362\u5230 ${t}\uFF0C\u6A21\u578B\u8FDE\u63A5\u5931\u8D25`));return}await v.updateConfig({models:{default:t}}),r.succeed(C.default.green(`\u2705 \u9ED8\u8BA4\u6A21\u578B\u5DF2\u5207\u6362\u5230 ${t}`)),console.log(C.default.yellow('\u{1F4A1} \u4F7F\u7528 "taskflow-ai config list" \u67E5\u770B\u5F53\u524D\u914D\u7F6E'))}catch(s){r.fail(C.default.red(`\u274C \u5207\u6362\u6A21\u578B\u5931\u8D25: ${s}`))}}),e.command("stats").description("\u67E5\u770B\u6A21\u578B\u4F7F\u7528\u7EDF\u8BA1").option("--period <period>","\u7EDF\u8BA1\u5468\u671F (day|week|month)","week").action(async t=>{try{console.log(C.default.blue("\u{1F4C8} \u6A21\u578B\u4F7F\u7528\u7EDF\u8BA1")),console.log(`\u7EDF\u8BA1\u5468\u671F: ${t.period}`),console.log();let r=await gr(t.period);console.log("\u6A21\u578B        | \u8C03\u7528\u6B21\u6570 | \u6210\u529F\u7387 | \u5E73\u5747\u5EF6\u8FDF | \u603B\u6210\u672C"),console.log("------------|----------|--------|----------|--------"),r.forEach(s=>{console.log(`${s.model.padEnd(12)} | ${s.calls.toString().padEnd(8)} | ${s.successRate}% | ${s.avgLatency}ms | $${s.cost}`)})}catch(r){console.error(C.default.red("\u274C \u83B7\u53D6\u7EDF\u8BA1\u6570\u636E\u5931\u8D25:"),r)}})}u(Ze,"modelsCommand");async function xt(i){try{return await new Promise(e=>setTimeout(e,1e3)),Math.random()>.2}catch{return!1}}u(xt,"testModelConnection");async function ur(i,e){let t=[];for(let a=0;a<e;a++){let c=Date.now();await new Promise(d=>setTimeout(d,Math.random()*2e3+500));let g=Date.now()-c;t.push({latency:g,success:Math.random()>.1,tokens:Math.floor(Math.random()*1e3+100)})}let r=Math.round(t.reduce((a,c)=>a+c.latency,0)/t.length),s=Math.round(t.filter(a=>a.success).length/t.length*100),o=Math.round(t.reduce((a,c)=>a+c.tokens,0)/t.length),n=Math.round(o/(r/1e3));return{avgLatency:r,successRate:s,tokensPerSecond:n}}u(ur,"runBenchmark");async function gr(i){return[{model:"deepseek",calls:156,successRate:98,avgLatency:1200,cost:2.34},{model:"zhipu",calls:89,successRate:96,avgLatency:1800,cost:4.56},{model:"qwen",calls:67,successRate:94,avgLatency:1500,cost:3.21},{model:"moonshot",calls:23,successRate:99,avgLatency:2200,cost:8.9}]}u(gr,"getModelStats");var Vt=require("commander"),f=m(require("chalk")),qe=m(require("ora"));W();et();S();function Bt(){let i=E.getInstance({level:"info",output:"console"}),e=new fe(i),t=new Vt.Command("mcp").description("MCP (Model Context Protocol) \u914D\u7F6E\u7BA1\u7406");return t.command("validate").description("\u9A8C\u8BC1 MCP \u914D\u7F6E\u6587\u4EF6").option("--editor <editor>","\u6307\u5B9A\u7F16\u8F91\u5668 (windsurf/trae/cursor/vscode)").option("--all","\u9A8C\u8BC1\u6240\u6709\u7F16\u8F91\u5668\u914D\u7F6E").action(async r=>{let s=(0,qe.default)("\u9A8C\u8BC1 MCP \u914D\u7F6E...").start();try{if(r.all){let o=["windsurf","trae","cursor","vscode"],n=!0;for(let a of o){let c=e.generateMCPConfig(a),g=e.validateMCPConfig(c);g.valid?console.log(f.default.green(`\u2705 ${a} \u914D\u7F6E\u6709\u6548`)):(console.log(f.default.red(`\u274C ${a} \u914D\u7F6E\u65E0\u6548:`)),g.errors?.forEach(d=>{console.log(f.default.red(`   - ${d}`))}),n=!1),g.warnings?.length&&g.warnings.forEach(d=>{console.log(f.default.yellow(`   \u26A0\uFE0F ${d}`))})}s.succeed(n?"\u6240\u6709\u914D\u7F6E\u9A8C\u8BC1\u901A\u8FC7":"\u90E8\u5206\u914D\u7F6E\u9A8C\u8BC1\u5931\u8D25")}else if(r.editor){let o=r.editor,n=e.generateMCPConfig(o),a=e.validateMCPConfig(n);a.valid?s.succeed(`${o} \u914D\u7F6E\u9A8C\u8BC1\u901A\u8FC7`):(s.fail(`${o} \u914D\u7F6E\u9A8C\u8BC1\u5931\u8D25`),a.errors?.forEach(c=>{console.log(f.default.red(`\u274C ${c}`))})),a.warnings?.length&&a.warnings.forEach(c=>{console.log(f.default.yellow(`\u26A0\uFE0F ${c}`))})}else s.fail("\u8BF7\u6307\u5B9A\u7F16\u8F91\u5668\u6216\u4F7F\u7528 --all \u9009\u9879")}catch(o){s.fail(`\u9A8C\u8BC1\u5931\u8D25: ${o.message}`),process.exit(1)}}),t.command("test").description("\u6D4B\u8BD5 MCP \u914D\u7F6E\u6709\u6548\u6027").option("--editor <editor>","\u6307\u5B9A\u7F16\u8F91\u5668").option("--all-editors","\u6D4B\u8BD5\u6240\u6709\u7F16\u8F91\u5668\u914D\u7F6E").option("--all-models","\u6D4B\u8BD5\u6240\u6709 AI \u6A21\u578B\u8FDE\u63A5").action(async r=>{let s=(0,qe.default)("\u6D4B\u8BD5 MCP \u914D\u7F6E...").start();try{if(r.allModels){let o=["deepseek","zhipu","qwen","baidu","moonshot","spark"];console.log(f.default.blue(`
\u{1F9EA} \u6D4B\u8BD5 AI \u6A21\u578B\u8FDE\u63A5:`));for(let n of o)try{let a=await e.testMCPConfiguration("cursor",{customEnvironment:{PREFERRED_MODEL:n}});a.valid?console.log(f.default.green(`\u2705 ${n} \u8FDE\u63A5\u6B63\u5E38 (${a.latency}ms)`)):(console.log(f.default.red(`\u274C ${n} \u8FDE\u63A5\u5931\u8D25`)),a.errors?.forEach(c=>{console.log(f.default.red(`   - ${c}`))}))}catch(a){console.log(f.default.red(`\u274C ${n} \u6D4B\u8BD5\u5F02\u5E38: ${a.message}`))}s.succeed("AI \u6A21\u578B\u8FDE\u63A5\u6D4B\u8BD5\u5B8C\u6210")}else if(r.allEditors){let o=["windsurf","trae","cursor","vscode"];console.log(f.default.blue(`
\u{1F9EA} \u6D4B\u8BD5\u7F16\u8F91\u5668\u914D\u7F6E:`));for(let n of o)try{let a=await e.testMCPConfiguration(n);a.valid?console.log(f.default.green(`\u2705 ${n} \u914D\u7F6E\u6D4B\u8BD5\u901A\u8FC7 (${a.latency}ms)`)):(console.log(f.default.red(`\u274C ${n} \u914D\u7F6E\u6D4B\u8BD5\u5931\u8D25`)),a.errors?.forEach(c=>{console.log(f.default.red(`   - ${c}`))})),a.warnings?.length&&a.warnings.forEach(c=>{console.log(f.default.yellow(`   \u26A0\uFE0F ${c}`))})}catch(a){console.log(f.default.red(`\u274C ${n} \u6D4B\u8BD5\u5F02\u5E38: ${a.message}`))}s.succeed("\u7F16\u8F91\u5668\u914D\u7F6E\u6D4B\u8BD5\u5B8C\u6210")}else if(r.editor){let o=r.editor,n=await e.testMCPConfiguration(o);n.valid?s.succeed(`${o} \u914D\u7F6E\u6D4B\u8BD5\u901A\u8FC7 (${n.latency}ms)`):(s.fail(`${o} \u914D\u7F6E\u6D4B\u8BD5\u5931\u8D25`),n.errors?.forEach(a=>{console.log(f.default.red(`\u274C ${a}`))})),n.warnings?.length&&n.warnings.forEach(a=>{console.log(f.default.yellow(`\u26A0\uFE0F ${a}`))})}else s.fail("\u8BF7\u6307\u5B9A\u6D4B\u8BD5\u9009\u9879")}catch(o){s.fail(`\u6D4B\u8BD5\u5931\u8D25: ${o.message}`),process.exit(1)}}),t.command("regenerate").description("\u91CD\u65B0\u751F\u6210 MCP \u914D\u7F6E\u6587\u4EF6").option("--editor <editor>","\u6307\u5B9A\u7F16\u8F91\u5668").option("--force","\u8986\u76D6\u73B0\u6709\u914D\u7F6E").action(async r=>{let s=(0,qe.default)("\u91CD\u65B0\u751F\u6210 MCP \u914D\u7F6E...").start();try{if(r.editor){let o=r.editor;await e.writeMCPConfigFiles(o,".",{includeAllModels:!0,enableStreaming:!0,enableHealthCheck:!0}),s.succeed(`${o} MCP \u914D\u7F6E\u91CD\u65B0\u751F\u6210\u5B8C\u6210`)}else await e.generateAllMCPConfigs(".",{includeAllModels:!0,enableStreaming:!0,enableHealthCheck:!0}),s.succeed("\u6240\u6709 MCP \u914D\u7F6E\u91CD\u65B0\u751F\u6210\u5B8C\u6210");console.log(f.default.blue(`
\u{1F4CB} \u751F\u6210\u7684\u914D\u7F6E\u6587\u4EF6:`)),console.log(f.default.gray("  .cursor/mcp.json          - Cursor \u7F16\u8F91\u5668\u914D\u7F6E")),console.log(f.default.gray("  .cursor-rules             - Cursor AI \u89C4\u5219")),console.log(f.default.gray("  .windsurf/mcp.json        - Windsurf \u7F16\u8F91\u5668\u914D\u7F6E")),console.log(f.default.gray("  .trae/mcp-config.json     - Trae \u7F16\u8F91\u5668\u914D\u7F6E")),console.log(f.default.gray("  .vscode/settings.json     - VSCode \u7F16\u8F91\u5668\u914D\u7F6E")),console.log(f.default.gray("  .vscode/extensions.json   - VSCode \u6269\u5C55\u63A8\u8350")),console.log(f.default.green(`
\u{1F389} MCP \u914D\u7F6E\u751F\u6210\u5B8C\u6210\uFF01\u73B0\u5728\u53EF\u4EE5\u5728\u7F16\u8F91\u5668\u4E2D\u4F7F\u7528 TaskFlow AI \u4E86\u3002`))}catch(o){s.fail(`\u91CD\u65B0\u751F\u6210\u5931\u8D25: ${o.message}`),process.exit(1)}}),t.command("info").description("\u663E\u793A MCP \u670D\u52A1\u4FE1\u606F").action(async()=>{let r=e.getMCPCapabilities();console.log(f.default.blue(`
\u{1F4CA} TaskFlow AI MCP \u670D\u52A1\u4FE1\u606F:`)),console.log(f.default.gray("\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501")),console.log(f.default.green(`
\u{1F3AF} \u652F\u6301\u7684\u7F16\u8F91\u5668:`)),r.supportedEditors.forEach(s=>{console.log(f.default.gray(`  \u2713 ${s}`))}),console.log(f.default.green(`
\u{1F916} \u652F\u6301\u7684 AI \u6A21\u578B:`)),r.supportedModels.forEach(s=>{console.log(f.default.gray(`  \u2713 ${s}`))}),console.log(f.default.green(`
\u26A1 \u652F\u6301\u7684\u529F\u80FD:`)),Object.entries(r.features).forEach(([s,o])=>{let n=o?"\u2713":"\u2717",a=o?f.default.gray:f.default.red;console.log(a(`  ${n} ${s}`))}),console.log(f.default.green(`
\u{1F527} MCP \u80FD\u529B:`)),Object.entries(r).forEach(([s,o])=>{if(typeof o=="boolean"){let n=o?"\u2713":"\u2717",a=o?f.default.gray:f.default.red;console.log(a(`  ${n} ${s}`))}}),console.log(f.default.blue(`
\u{1F4D6} \u4F7F\u7528\u8BF4\u660E:`)),console.log(f.default.gray("  1. \u8FD0\u884C taskflow init \u751F\u6210\u914D\u7F6E\u6587\u4EF6")),console.log(f.default.gray("  2. \u8BBE\u7F6E\u73AF\u5883\u53D8\u91CF\u4E2D\u7684 API \u5BC6\u94A5")),console.log(f.default.gray("  3. \u6253\u5F00\u7F16\u8F91\u5668\uFF0C\u670D\u52A1\u5C06\u81EA\u52A8\u542F\u52A8")),console.log(f.default.gray("  4. \u5F00\u59CB\u4F7F\u7528 AI \u9A71\u52A8\u7684\u5F00\u53D1\u529F\u80FD"))}),t.command("server").description("\u542F\u52A8 TaskFlow AI MCP \u670D\u52A1\u5668").option("--transport <type>","\u4F20\u8F93\u7C7B\u578B (stdio|http)","stdio").option("--port <port>","HTTP\u7AEF\u53E3\u53F7","3000").option("--verbose","\u8BE6\u7EC6\u65E5\u5FD7\u8F93\u51FA").action(async r=>{console.log(f.default.blue("\u{1F680} \u542F\u52A8 TaskFlow AI MCP \u670D\u52A1\u5668...")),console.log(f.default.gray(`\u{1F4CD} \u4F20\u8F93\u7C7B\u578B: ${r.transport}`)),r.transport==="http"&&console.log(f.default.gray(`\u{1F4CD} \u7AEF\u53E3: ${r.port}`));try{let{startMCPServer:s}=await Promise.resolve().then(()=>(Ut(),Kt));await s({transport:r.transport,port:parseInt(r.port),verbose:r.verbose})}catch(s){console.error(f.default.red("\u274C \u542F\u52A8MCP\u670D\u52A1\u5668\u5931\u8D25:"),s instanceof Error?s.message:String(s)),process.exit(1)}}),t}u(Bt,"createMCPCommand");var ie=require("commander"),k=m(require("chalk")),je=m(require("ora"));var Gt=require("events"),Z=m(require("fs-extra")),tt=m(require("path"));W();S();var he=class extends Gt.EventEmitter{constructor(t=".taskflow"){super();this.autoSaveInterval=null;this.tasks=new Map,this.logger=E.getInstance({level:"info",output:"console"}),this.dataFile=tt.default.join(t,"tasks.json"),this.initializeDataFile(),this.loadTasks(),this.startAutoSave()}static{u(this,"TaskManager")}async initializeDataFile(){try{await Z.default.ensureDir(tt.default.dirname(this.dataFile)),await Z.default.pathExists(this.dataFile)||await Z.default.writeJson(this.dataFile,{tasks:[]})}catch(t){this.logger.error("\u521D\u59CB\u5316\u4EFB\u52A1\u6570\u636E\u6587\u4EF6\u5931\u8D25:",{error:t instanceof Error?t.message:String(t),stack:t instanceof Error?t.stack:void 0})}}async loadTasks(){try{if(await Z.default.pathExists(this.dataFile)){let t=await Z.default.readJson(this.dataFile);if(t.tasks&&Array.isArray(t.tasks))for(let r of t.tasks){let s={...r,createdAt:new Date(r.createdAt),updatedAt:new Date(r.updatedAt),startedAt:r.startedAt?new Date(r.startedAt):void 0,completedAt:r.completedAt?new Date(r.completedAt):void 0,dueDate:r.dueDate?new Date(r.dueDate):void 0};this.tasks.set(s.id,s)}}this.logger.info(`\u5DF2\u52A0\u8F7D ${this.tasks.size} \u4E2A\u4EFB\u52A1`)}catch(t){this.logger.error("\u52A0\u8F7D\u4EFB\u52A1\u6570\u636E\u5931\u8D25:",{error:t instanceof Error?t.message:String(t),stack:t instanceof Error?t.stack:void 0})}}async saveTasks(){try{let t=Array.from(this.tasks.values());await Z.default.writeJson(this.dataFile,{tasks:t},{spaces:2})}catch(t){this.logger.error("\u4FDD\u5B58\u4EFB\u52A1\u6570\u636E\u5931\u8D25:",{error:t instanceof Error?t.message:String(t),stack:t instanceof Error?t.stack:void 0})}}startAutoSave(){this.autoSaveInterval&&clearInterval(this.autoSaveInterval),this.autoSaveInterval=setInterval(()=>{this.saveTasks()},3e4)}stopAutoSave(){this.autoSaveInterval&&(clearInterval(this.autoSaveInterval),this.autoSaveInterval=null)}createTask(t){let r={id:`task_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,createdAt:new Date,updatedAt:new Date,progress:0,...t};return this.tasks.set(r.id,r),this.emit("taskCreated",r),this.logger.info(`\u521B\u5EFA\u4EFB\u52A1: ${r.title} (${r.id})`),r}getTask(t){return this.tasks.get(t)}getAllTasks(){return Array.from(this.tasks.values())}updateTask(t,r){let s=this.tasks.get(t);return s?(Object.assign(s,r,{updatedAt:new Date}),this.tasks.set(t,s),this.emit("taskUpdated",{taskId:t,task:s,updates:r}),this.saveTasks(),this.logger.info(`\u4EFB\u52A1\u5DF2\u66F4\u65B0: ${t}`),!0):(this.logger.warn(`\u4EFB\u52A1\u4E0D\u5B58\u5728: ${t}`),!1)}updateTaskStatus(t,r,s={}){let o=this.tasks.get(t);if(!o)return this.logger.warn(`\u4EFB\u52A1\u4E0D\u5B58\u5728: ${t}`),!1;let n=o.status;return o.status=r,o.updatedAt=new Date,s.progress!==void 0&&(o.progress=Math.max(0,Math.min(100,s.progress))),s.actualHours!==void 0&&(o.actualHours=s.actualHours),s.assignee!==void 0&&(o.assignee=s.assignee),s.dueDate!==void 0&&(o.dueDate=s.dueDate),s.metadata&&(o.metadata={...o.metadata,...s.metadata}),r==="in_progress"&&n!=="in_progress"?o.startedAt=new Date:r==="completed"&&n!=="completed"&&(o.completedAt=new Date,o.progress=100),this.emit("taskUpdated",o,n),this.logger.info(`\u66F4\u65B0\u4EFB\u52A1\u72B6\u6001: ${o.title} (${n} -> ${r})`),!0}deleteTask(t){let r=this.tasks.get(t);return r?(this.tasks.delete(t),this.emit("taskDeleted",r),this.logger.info(`\u5220\u9664\u4EFB\u52A1: ${r.title} (${t})`),!0):!1}getTaskStats(){let t=Array.from(this.tasks.values()),r={total:t.length,pending:0,in_progress:0,completed:0,blocked:0,cancelled:0,overallProgress:0,estimatedTotalHours:0,actualTotalHours:0};for(let s of t){switch(s.status){case"pending":r.pending++;break;case"in_progress":r.in_progress++;break;case"completed":r.completed++;break;case"blocked":r.blocked++;break;case"cancelled":r.cancelled++;break}r.estimatedTotalHours+=s.estimatedHours,s.actualHours&&(r.actualTotalHours+=s.actualHours)}if(t.length>0){let s=t.reduce((o,n)=>o+n.progress,0);r.overallProgress=Math.round(s/t.length)}return r}getTasksByStatus(t){return Array.from(this.tasks.values()).filter(r=>r.status===t)}getTasksByPriority(t){return Array.from(this.tasks.values()).filter(r=>r.priority===t)}getTasksByAssignee(t){return Array.from(this.tasks.values()).filter(r=>r.assignee===t)}checkTaskDependencies(t){let r=this.tasks.get(t);if(!r)return{canStart:!1,blockedBy:[]};let s=[];for(let o of r.dependencies){let n=this.tasks.get(o);(!n||n.status!=="completed")&&s.push(o)}return{canStart:s.length===0,blockedBy:s}}getReadyTasks(){return Array.from(this.tasks.values()).filter(t=>{if(t.status!=="pending")return!1;let{canStart:r}=this.checkTaskDependencies(t.id);return r})}async save(){await this.saveTasks()}destroy(){this.stopAutoSave(),this.saveTasks(),this.removeAllListeners()}};var y=m(require("chalk"));function Wt(i){if(i.length===0){console.log(y.default.yellow("\u{1F4CB} \u6CA1\u6709\u6570\u636E\u53EF\u663E\u793A"));return}let e=Object.keys(i[0]),t=new Map;e.forEach(s=>{let o=Math.max(s.length,...i.map(n=>String(n[s]||"").length));t.set(s,Math.min(o,30))});let r=e.map(s=>y.default.bold.blue(s.padEnd(t.get(s)))).join(" \u2502 ");console.log("\u250C"+"\u2500".repeat(r.length-10)+"\u2510"),console.log("\u2502 "+r+" \u2502"),console.log("\u251C"+"\u2500".repeat(r.length-10)+"\u2524"),i.forEach(s=>{let o=e.map(n=>{let a=String(s[n]||""),c=t.get(n),g=a;return n.includes("\u72B6\u6001")||n.includes("Status")?g=dr(a):n.includes("\u4F18\u5148\u7EA7")||n.includes("Priority")?g=Qt(a):(n.includes("\u5173\u952E")||n.includes("Critical"))&&(g=a==="\u2705"?y.default.green(a):y.default.gray(a)),g.padEnd(c)}).join(" \u2502 ");console.log("\u2502 "+o+" \u2502")}),console.log("\u2514"+"\u2500".repeat(r.length-10)+"\u2518")}u(Wt,"displayTable");function Jt(i,e={}){if(i.length===0){console.log(y.default.yellow("\u{1F4CB} \u6CA1\u6709\u4EFB\u52A1\u53EF\u663E\u793A"));return}i.forEach((t,r)=>{let s=pr(t.status),o=Qt(t.priority);console.log(`${r+1}. ${s} ${y.default.bold(t.name)}`),console.log(`   ${y.default.gray("ID:")} ${t.id.substring(0,8)}`),console.log(`   ${y.default.gray("\u4F18\u5148\u7EA7:")} ${o}`),console.log(`   ${y.default.gray("\u7C7B\u578B:")} ${t.type}`),t.estimatedHours&&console.log(`   ${y.default.gray("\u9884\u8BA1\u65F6\u957F:")} ${t.estimatedHours}\u5C0F\u65F6`),e.showTimeInfo&&t.timeInfo&&(console.log(`   ${y.default.gray("\u6700\u65E9\u5F00\u59CB:")} ${t.timeInfo.earliestStart?new Date(t.timeInfo.earliestStart).toLocaleDateString():"\u672A\u8BBE\u7F6E"}`),console.log(`   ${y.default.gray("\u6D6E\u52A8\u65F6\u95F4:")} ${t.timeInfo.totalFloat?t.timeInfo.totalFloat.toFixed(1)+"\u5C0F\u65F6":"\u672A\u8BA1\u7B97"}`),console.log(`   ${y.default.gray("\u5173\u952E\u4EFB\u52A1:")} ${t.timeInfo.isCritical?y.default.red("\u662F"):y.default.green("\u5426")}`)),t.dependencies&&t.dependencies.length>0&&console.log(`   ${y.default.gray("\u4F9D\u8D56:")} ${t.dependencies.join(", ")}`),console.log(`   ${y.default.gray("\u63CF\u8FF0:")} ${t.description}`),console.log("")})}u(Jt,"displayTaskList");function Yt(i){if(console.log(y.default.bold.blue("\u{1F4CA} \u9879\u76EE\u7518\u7279\u56FE")),console.log("\u2550".repeat(60)),i.length===0){console.log(y.default.yellow("\u6CA1\u6709\u4EFB\u52A1\u6570\u636E"));return}let e=1/0,t=0;if(i.forEach(o=>{if(o.timeInfo){let n=o.timeInfo.earliestStart?new Date(o.timeInfo.earliestStart).getTime():0,a=(o.timeInfo.estimatedDuration||o.estimatedHours||8)*60*60*1e3,c=n+a;e=Math.min(e,n),t=Math.max(t,c)}}),e===1/0){console.log(y.default.yellow("\u4EFB\u52A1\u7F3A\u5C11\u65F6\u95F4\u4FE1\u606F\uFF0C\u65E0\u6CD5\u751F\u6210\u7518\u7279\u56FE"));return}let r=t-e,s=40;i.forEach(o=>{let n=o.name.substring(0,15).padEnd(15);if(o.timeInfo&&o.timeInfo.earliestStart){let a=new Date(o.timeInfo.earliestStart).getTime(),c=(o.timeInfo.estimatedDuration||o.estimatedHours||8)*60*60*1e3,g=Math.floor((a-e)/r*s),d=Math.max(1,Math.floor(c/r*s)),w=" ".repeat(g)+(o.timeInfo.isCritical?y.default.red("\u2588".repeat(d)):y.default.blue("\u2588".repeat(d)))+" ".repeat(Math.max(0,s-g-d));console.log(`${n} \u2502${w}\u2502`)}else console.log(`${n} \u2502${y.default.gray("\u2500".repeat(s))}\u2502`)}),console.log(" ".repeat(15)+"\u2502"+"\u2500".repeat(s)+"\u2502"),console.log(" ".repeat(15)+"\u2502"+new Date(e).toLocaleDateString().padEnd(s-10)+new Date(t).toLocaleDateString().padStart(10)+"\u2502")}u(Yt,"displayGanttChart");function pr(i){switch(i.toLowerCase()){case"completed":case"done":return y.default.green("\u2705");case"in_progress":case"in-progress":return y.default.yellow("\u{1F504}");case"blocked":return y.default.red("\u{1F6AB}");case"cancelled":return y.default.gray("\u274C");default:return y.default.blue("\u{1F4CB}")}}u(pr,"getStatusIcon");function dr(i){switch(i.toLowerCase()){case"completed":case"done":return y.default.green(i);case"in_progress":case"in-progress":return y.default.yellow(i);case"blocked":return y.default.red(i);case"cancelled":return y.default.gray(i);default:return y.default.blue(i)}}u(dr,"getStatusColor");function Qt(i){switch(i.toLowerCase()){case"critical":return y.default.red.bold(i);case"high":return y.default.red(i);case"medium":return y.default.yellow(i);case"low":return y.default.green(i);default:return y.default.gray(i)}}u(Qt,"getPriorityColor");function mr(i){return{id:i.id,name:i.title,title:i.title,description:i.description,status:fr(i.status),priority:i.priority,type:"feature",dependencies:i.dependencies,estimatedHours:i.estimatedHours,actualHours:i.actualHours,createdAt:i.createdAt,updatedAt:i.updatedAt,startedAt:i.startedAt,completedAt:i.completedAt,dueDate:i.dueDate,assignee:i.assignee,tags:i.tags,progress:i.progress,metadata:i.metadata}}u(mr,"convertToOrchestrationTask");function fr(i){return{pending:"not_started",in_progress:"in_progress",completed:"completed",blocked:"blocked",cancelled:"cancelled"}[i]||i}u(fr,"convertStatus");function Zt(){let i=new ie.Command("orchestrate");return i.description("\u667A\u80FD\u4EFB\u52A1\u7F16\u6392\u548C\u4F18\u5316").option("-p, --preset <preset>","\u4F7F\u7528\u9884\u8BBE\u7F16\u6392\u7B56\u7565").option("-s, --strategy <strategy>","\u8C03\u5EA6\u7B56\u7565").option("-g, --goal <goal>","\u4F18\u5316\u76EE\u6807").option("--max-parallel <number>","\u6700\u5927\u5E76\u884C\u4EFB\u52A1\u6570","10").option("--buffer <percentage>","\u7F13\u51B2\u65F6\u95F4\u767E\u5206\u6BD4","0.1").option("--critical-path","\u542F\u7528\u5173\u952E\u8DEF\u5F84\u5206\u6790",!0).option("--no-critical-path","\u7981\u7528\u5173\u952E\u8DEF\u5F84\u5206\u6790").option("--parallel-optimization","\u542F\u7528\u5E76\u884C\u4F18\u5316",!0).option("--no-parallel-optimization","\u7981\u7528\u5E76\u884C\u4F18\u5316").option("--resource-leveling","\u542F\u7528\u8D44\u6E90\u5E73\u8861").option("--no-resource-leveling","\u7981\u7528\u8D44\u6E90\u5E73\u8861").option("--risk-analysis","\u542F\u7528\u98CE\u9669\u5206\u6790",!0).option("--no-risk-analysis","\u7981\u7528\u98CE\u9669\u5206\u6790").option("--output <format>","\u8F93\u51FA\u683C\u5F0F (table|json|gantt)","table").option("--save","\u4FDD\u5B58\u7F16\u6392\u7ED3\u679C\u5230\u9879\u76EE").option("--dry-run","\u4EC5\u663E\u793A\u7F16\u6392\u7ED3\u679C\uFF0C\u4E0D\u4FDD\u5B58").action(async e=>{await hr(e)}),i.addCommand(br()),i.addCommand(wr()),i.addCommand(Pr()),i.addCommand(Cr()),i}u(Zt,"createOrchestrateCommand");async function hr(i){let e=(0,je.default)("\u6B63\u5728\u52A0\u8F7D\u4EFB\u52A1\u6570\u636E...").start();try{let t=new he,s=t.getAllTasks().map(mr);if(s.length===0){e.fail("\u6CA1\u6709\u627E\u5230\u4EFB\u52A1\uFF0C\u8BF7\u5148\u521B\u5EFA\u4EFB\u52A1");return}e.text="\u6B63\u5728\u914D\u7F6E\u7F16\u6392\u5F15\u64CE...";let o=yr(i),n=i.preset?B.createEngine(i.preset,o):new V(o);e.text=`\u6B63\u5728\u7F16\u6392 ${s.length} \u4E2A\u4EFB\u52A1...`;let a=await n.orchestrate(s);if(e.succeed("\u4EFB\u52A1\u7F16\u6392\u5B8C\u6210"),await kr(a,i.output),i.save&&!i.dryRun){let c=(0,je.default)("\u6B63\u5728\u4FDD\u5B58\u7F16\u6392\u7ED3\u679C...").start();try{let g=n.updateTaskTimeInfo(a.tasks);for(let d of g){let w={title:d.name,description:d.description,estimatedHours:d.estimatedHours||0,metadata:{...d.metadata,timeInfo:d.timeInfo,orchestrationMetadata:d.orchestrationMetadata}};t.updateTask(d.id,w)}c.succeed("\u7F16\u6392\u7ED3\u679C\u5DF2\u4FDD\u5B58")}catch(g){c.fail(`\u4FDD\u5B58\u5931\u8D25: ${g instanceof Error?g.message:"\u672A\u77E5\u9519\u8BEF"}`)}}}catch(t){e.fail(`\u7F16\u6392\u5931\u8D25: ${t instanceof Error?t.message:"\u672A\u77E5\u9519\u8BEF"}`),process.exit(1)}}u(hr,"handleOrchestrateCommand");function yr(i){let e={};return i.strategy&&(e.schedulingStrategy=i.strategy),i.goal&&(e.optimizationGoal=i.goal),i.maxParallel&&(e.maxParallelTasks=parseInt(i.maxParallel)),i.buffer&&(e.bufferPercentage=parseFloat(i.buffer)),e.enableCriticalPath=i.criticalPath,e.enableParallelOptimization=i.parallelOptimization,e.enableResourceLeveling=i.resourceLeveling,e.enableRiskAnalysis=i.riskAnalysis,e}u(yr,"buildOrchestrationConfig");async function kr(i,e){switch(console.log(`
`+k.default.bold.blue("\u{1F4CA} \u4EFB\u52A1\u7F16\u6392\u7ED3\u679C")),console.log("\u2550".repeat(60)),console.log(k.default.green(`\u2705 \u603B\u4EFB\u52A1\u6570: ${i.tasks.length}`)),console.log(k.default.yellow(`\u23F1\uFE0F  \u9879\u76EE\u6301\u7EED\u65F6\u95F4: ${i.totalDuration} \u5C0F\u65F6`)),console.log(k.default.red(`\u{1F3AF} \u5173\u952E\u8DEF\u5F84\u4EFB\u52A1: ${i.criticalPath.length}`)),console.log(k.default.blue(`\u{1F504} \u5E76\u884C\u4EFB\u52A1\u7EC4: ${i.parallelGroups.length}`)),console.log(k.default.magenta(`\u26A0\uFE0F  \u6574\u4F53\u98CE\u9669\u7B49\u7EA7: ${i.riskAssessment.overallRiskLevel.toFixed(1)}/10`)),console.log(`
`+k.default.bold("\u{1F4CB} \u7F16\u6392\u7B56\u7565")),console.log(`\u7B56\u7565: ${i.metadata.strategy}`),console.log(`\u76EE\u6807: ${i.metadata.goal}`),console.log(`\u7F16\u6392\u65F6\u95F4: ${i.metadata.orchestrationTime.toLocaleString()}`),e){case"json":console.log(`
`+k.default.bold("\u{1F4C4} \u8BE6\u7EC6\u7ED3\u679C (JSON)")),console.log(JSON.stringify(i,null,2));break;case"gantt":console.log(`
`+k.default.bold("\u{1F4CA} \u7518\u7279\u56FE")),Yt(i.tasks);break;case"table":default:await Tr(i);break}if(i.criticalPath.length>0){console.log(`
`+k.default.bold.red("\u{1F3AF} \u5173\u952E\u8DEF\u5F84"));let t=i.tasks.filter(r=>i.criticalPath.includes(r.id));Jt(t,{showTimeInfo:!0})}i.parallelGroups.length>0&&(console.log(`
`+k.default.bold.blue("\u{1F504} \u5E76\u884C\u4EFB\u52A1\u7EC4")),i.parallelGroups.forEach((t,r)=>{console.log(k.default.cyan(`\u7EC4 ${r+1}: ${t.join(", ")}`))})),i.recommendations.length>0&&(console.log(`
`+k.default.bold.green("\u{1F4A1} \u4F18\u5316\u5EFA\u8BAE")),i.recommendations.forEach((t,r)=>{console.log(k.default.green(`${r+1}. ${t}`))})),i.riskAssessment.riskFactors.length>0&&(console.log(`
`+k.default.bold.yellow("\u26A0\uFE0F  \u98CE\u9669\u8BC4\u4F30")),i.riskAssessment.riskFactors.forEach(t=>{console.log(k.default.yellow(`\u2022 ${t.name}: ${t.riskScore.toFixed(1)} (${t.category})`))}))}u(kr,"displayOrchestrationResult");async function Tr(i){console.log(`
`+k.default.bold("\u{1F4CB} \u4EFB\u52A1\u8BE6\u60C5"));let e=i.tasks.map(t=>{let r=t.timeInfo||{};return{ID:t.id.substring(0,8),\u4EFB\u52A1\u540D\u79F0:t.name,\u72B6\u6001:t.status,\u4F18\u5148\u7EA7:t.priority,\u9884\u8BA1\u65F6\u957F:`${t.estimatedHours||0}h`,\u6700\u65E9\u5F00\u59CB:r.earliestStart?new Date(r.earliestStart).toLocaleDateString():"-",\u6700\u665A\u5F00\u59CB:r.latestStart?new Date(r.latestStart).toLocaleDateString():"-",\u6D6E\u52A8\u65F6\u95F4:r.totalFloat?`${r.totalFloat.toFixed(1)}h`:"-",\u5173\u952E\u4EFB\u52A1:r.isCritical?"\u2705":"\u274C"}});Wt(e)}u(Tr,"displayTableResult");function br(){let i=new ie.Command("presets");return i.description("\u67E5\u770B\u53EF\u7528\u7684\u7F16\u6392\u9884\u8BBE").action(()=>{console.log(`
`+k.default.bold.blue("\u{1F4CB} \u53EF\u7528\u7F16\u6392\u9884\u8BBE")),console.log("\u2550".repeat(60)),B.getAvailablePresets().forEach(t=>{console.log(k.default.bold.green(`
${t.name} (${t.preset})`)),console.log(k.default.gray(t.description)),console.log(k.default.blue("\u9002\u7528\u573A\u666F: ")+t.suitableFor.join(", "))}),console.log(`
`+k.default.yellow("\u4F7F\u7528\u65B9\u6CD5:")),console.log(k.default.cyan("taskflow orchestrate --preset agile_sprint"))}),i}u(br,"createPresetsCommand");function wr(){let i=new ie.Command("analyze");return i.description("\u5206\u6790\u5F53\u524D\u4EFB\u52A1\u7ED3\u6784").action(async()=>{let e=(0,je.default)("\u6B63\u5728\u5206\u6790\u4EFB\u52A1\u7ED3\u6784...").start();try{if(new he().getAllTasks().length===0){e.fail("\u6CA1\u6709\u627E\u5230\u4EFB\u52A1");return}let o=new V().getOrchestrationStats();e.succeed("\u4EFB\u52A1\u5206\u6790\u5B8C\u6210"),console.log(`
`+k.default.bold.blue("\u{1F4CA} \u4EFB\u52A1\u7ED3\u6784\u5206\u6790")),console.log("\u2550".repeat(40)),console.log(k.default.green(`\u603B\u4EFB\u52A1\u6570: ${o.totalTasks}`)),console.log(k.default.red(`\u5173\u952E\u4EFB\u52A1\u6570: ${o.criticalTasks}`)),console.log(k.default.blue(`\u5E76\u884C\u4EFB\u52A1\u7EC4: ${o.parallelGroups}`)),console.log(k.default.yellow(`\u5E73\u5747\u6D6E\u52A8\u65F6\u95F4: ${o.averageFloat.toFixed(1)}h`)),console.log(k.default.magenta(`\u6700\u957F\u8DEF\u5F84: ${o.longestPath.toFixed(1)}h`))}catch(t){e.fail(`\u5206\u6790\u5931\u8D25: ${t instanceof Error?t.message:"\u672A\u77E5\u9519\u8BEF"}`)}}),i}u(wr,"createAnalyzeCommand");function Pr(){let i=new ie.Command("optimize");return i.description("\u4F18\u5316\u4EFB\u52A1\u5B89\u6392").option("--goal <goal>","\u4F18\u5316\u76EE\u6807","minimize_duration").action(async e=>{console.log(k.default.blue("\u{1F527} \u4EFB\u52A1\u4F18\u5316\u529F\u80FD\u5F00\u53D1\u4E2D...")),console.log(k.default.gray("\u5C06\u5728\u4E0B\u4E2A\u7248\u672C\u4E2D\u63D0\u4F9B\u66F4\u591A\u4F18\u5316\u9009\u9879"))}),i}u(Pr,"createOptimizeCommand");function Cr(){let i=new ie.Command("recommend");return i.description("\u63A8\u8350\u7F16\u6392\u7B56\u7565").option("--team-size <number>","\u56E2\u961F\u89C4\u6A21","5").option("--duration <days>","\u9879\u76EE\u6301\u7EED\u65F6\u95F4\uFF08\u5929\uFF09","30").option("--uncertainty <level>","\u4E0D\u786E\u5B9A\u6027\u7B49\u7EA7 (1-10)","5").option("--quality <level>","\u8D28\u91CF\u8981\u6C42 (1-10)","7").option("--time-constraint <level>","\u65F6\u95F4\u7EA6\u675F (1-10)","5").option("--budget-constraint <level>","\u9884\u7B97\u7EA6\u675F (1-10)","5").option("--agile","\u654F\u6377\u9879\u76EE").option("--research","\u7814\u7A76\u9879\u76EE").option("--enterprise","\u4F01\u4E1A\u7EA7\u9879\u76EE").action(e=>{let t={teamSize:parseInt(e.teamSize),projectDuration:parseInt(e.duration),uncertaintyLevel:parseInt(e.uncertainty),qualityRequirement:parseInt(e.quality),timeConstraint:parseInt(e.timeConstraint),budgetConstraint:parseInt(e.budgetConstraint),isAgile:e.agile,isResearch:e.research,isEnterprise:e.enterprise},r=B.recommendPreset(t),o=B.getAvailablePresets().find(n=>n.preset===r);console.log(`
`+k.default.bold.blue("\u{1F3AF} \u63A8\u8350\u7F16\u6392\u7B56\u7565")),console.log("\u2550".repeat(40)),o&&(console.log(k.default.bold.green(`\u63A8\u8350\u7B56\u7565: ${o.name}`)),console.log(k.default.gray(o.description)),console.log(k.default.blue("\u9002\u7528\u573A\u666F: ")+o.suitableFor.join(", ")),console.log(`
`+k.default.yellow("\u4F7F\u7528\u65B9\u6CD5:")),console.log(k.default.cyan(`taskflow orchestrate --preset ${r}`)))}),i}u(Cr,"createRecommendCommand");var st=m(require("ora")),ot=m(require("path"));S();z();var ce=class extends Error{static{u(this,"TaskFlowError")}constructor(e,t,r){super(e),this.name=this.constructor.name,this.code=t,this.timestamp=r.timestamp||new Date().toISOString(),this.context=r,Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)}toJSON(){return{name:this.name,message:this.message,code:this.code,context:this.context,stack:this.stack||""}}};var le=class{static{u(this,"ErrorHandler")}static handleUnknownError(e,t){if(e instanceof ce)return e;if(e instanceof Error){let s={timestamp:new Date().toISOString(),source:t,details:{originalName:e.name,originalStack:e.stack||""}};return new ce(e.message,"UNKNOWN_ERROR",s)}if(typeof e=="string"){let s={timestamp:new Date().toISOString(),source:t,details:{}};return new ce(e,"STRING_ERROR",s)}let r={timestamp:new Date().toISOString(),source:t,details:{errorType:typeof e,errorValue:String(e)}};return new ce("An unknown error occurred","UNKNOWN_ERROR",r)}static isRetryable(e){return["NETWORK_ERROR","API_ERROR","PERFORMANCE_ERROR"].includes(e.code)&&e.context.details?.retryable===!0}static getSeverity(e){let t=["FILESYSTEM_ERROR","CONFIGURATION_ERROR"],r=["API_ERROR","NETWORK_ERROR"],s=["VALIDATION_ERROR","PARSE_ERROR"];return t.includes(e.code)?"critical":r.includes(e.code)?"high":s.includes(e.code)?"medium":"low"}static formatUserMessage(e){let t=e.message,r=e.context.details?.suggestion;return r?`${t}
\u{1F4A1} \u5EFA\u8BAE: ${r}`:t}static createErrorReport(e){return{id:this.generateErrorId(),timestamp:e.timestamp,severity:this.getSeverity(e),retryable:this.isRetryable(e),error:e.toJSON(),environment:{nodeVersion:process.version,platform:process.platform,arch:process.arch}}}static generateErrorId(){return`err_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}};function er(i){let e=le.handleUnknownError(i,"cli"),t=le.formatUserMessage(e);console.error(l.default.red("\u274C \u9519\u8BEF:"),t),process.env.NODE_ENV==="development"&&(console.error(l.default.gray("\u8BE6\u7EC6\u9519\u8BEF\u4FE1\u606F:")),console.error(e.stack));let r=le.createErrorReport(e);console.error(l.default.gray(`\u9519\u8BEFID: ${r.id}`)),process.exit(1)}u(er,"handleGlobalError");process.on("uncaughtException",er);process.on("unhandledRejection",er);var M=new Xt.Command;M.name("taskflow").description(l.default.cyan("TaskFlow AI - \u667A\u80FDPRD\u6587\u6863\u89E3\u6790\u4E0E\u4EFB\u52A1\u7BA1\u7406\u52A9\u624B")).version(Ct).addHelpText("before",l.default.cyan.bold("TaskFlow AI")+` - \u8BA9AI\u5E2E\u60A8\u5C06\u4EA7\u54C1\u9700\u6C42\u8F6C\u5316\u4E3A\u53EF\u6267\u884C\u7684\u4EFB\u52A1\u8BA1\u5212
`).addHelpText("after",`
${l.default.yellow("\u5FEB\u901F\u5F00\u59CB:")}
  ${l.default.green("taskflow interactive")}     \u542F\u52A8\u4EA4\u4E92\u5F0F\u6A21\u5F0F (\u63A8\u8350\u65B0\u7528\u6237)
  ${l.default.green("taskflow init")}            \u521D\u59CB\u5316\u65B0\u9879\u76EE
  ${l.default.green("taskflow parse <file>")}    \u89E3\u6790PRD\u6587\u6863

${l.default.yellow("\u793A\u4F8B:")}
  ${l.default.gray("taskflow parse ./prd.md")}
  ${l.default.gray("taskflow status --verbose")}
  ${l.default.gray("taskflow config set model.deepseek.apiKey <your-key>")}

${l.default.yellow("\u66F4\u591A\u4FE1\u606F:")}
  ${l.default.blue("https://github.com/agions/taskflow-ai")}
`);Et.register(M);vt.register(M);Dt.register(M);Ze(M);M.addCommand(Bt());M.addCommand(Zt());M.command("init").description("\u521D\u59CB\u5316TaskFlow AI\u9879\u76EE\u5E76\u751F\u6210MCP\u914D\u7F6E").option("--editor <editor>","\u6307\u5B9A\u7F16\u8F91\u5668 (windsurf/trae/cursor/vscode)","all").option("--force","\u8986\u76D6\u73B0\u6709\u914D\u7F6E\u6587\u4EF6").action(async i=>{console.log(l.default.blue("\u{1F680} TaskFlow AI - \u9879\u76EE\u521D\u59CB\u5316")),console.log();try{let e=await import("fs-extra"),t=await import("path"),{Logger:r}=await Promise.resolve().then(()=>(W(),mt)),{ConfigManager:s}=await Promise.resolve().then(()=>(et(),zt)),o=process.cwd(),n=r.getInstance({level:"info",output:"console"}),a=new s(n);await e.default.ensureDir(t.join(o,".taskflow")),await e.default.ensureDir(t.join(o,"docs")),await e.default.ensureDir(t.join(o,"tasks")),await e.default.ensureDir(t.join(o,"output")),await e.default.writeFile(t.join(o,"docs","sample-prd.md"),`# \u793A\u4F8B\u4EA7\u54C1\u9700\u6C42\u6587\u6863

## 1. \u4EA7\u54C1\u6982\u8FF0

### 1.1 \u4EA7\u54C1\u540D\u79F0
\u793A\u4F8BWeb\u5E94\u7528

### 1.2 \u4EA7\u54C1\u63CF\u8FF0
\u8FD9\u662F\u4E00\u4E2A\u793A\u4F8B\u7684Web\u5E94\u7528\u4EA7\u54C1\u9700\u6C42\u6587\u6863\uFF0C\u7528\u4E8E\u6F14\u793ATaskFlow AI\u7684\u529F\u80FD\u3002

## 2. \u529F\u80FD\u9700\u6C42

### 2.1 \u7528\u6237\u7BA1\u7406
- \u7528\u6237\u6CE8\u518C\u529F\u80FD
- \u7528\u6237\u767B\u5F55\u529F\u80FD
- \u7528\u6237\u4FE1\u606F\u7BA1\u7406

### 2.2 \u5185\u5BB9\u7BA1\u7406
- \u5185\u5BB9\u521B\u5EFA\u529F\u80FD
- \u5185\u5BB9\u7F16\u8F91\u529F\u80FD
- \u5185\u5BB9\u5220\u9664\u529F\u80FD

### 2.3 \u6743\u9650\u7BA1\u7406
- \u89D2\u8272\u7BA1\u7406
- \u6743\u9650\u5206\u914D
- \u8BBF\u95EE\u63A7\u5236

## 3. \u975E\u529F\u80FD\u9700\u6C42

### 3.1 \u6027\u80FD\u8981\u6C42
- \u9875\u9762\u52A0\u8F7D\u65F6\u95F4\u4E0D\u8D85\u8FC73\u79D2
- \u652F\u63011000\u5E76\u53D1\u7528\u6237

### 3.2 \u5B89\u5168\u8981\u6C42
- \u6570\u636E\u52A0\u5BC6\u4F20\u8F93
- \u7528\u6237\u8EAB\u4EFD\u9A8C\u8BC1
- \u9632\u6B62SQL\u6CE8\u5165

## 4. \u6280\u672F\u8981\u6C42

### 4.1 \u524D\u7AEF\u6280\u672F
- React.js
- TypeScript
- Tailwind CSS

### 4.2 \u540E\u7AEF\u6280\u672F
- Node.js
- Express.js
- MongoDB
`),console.log(l.default.blue("\u{1F4DD} \u751F\u6210MCP\u914D\u7F6E\u6587\u4EF6...")),i.editor==="all"?(await a.generateAllMCPConfigs(o,{includeAllModels:!0,enableStreaming:!0,enableHealthCheck:!0}),console.log(l.default.green("\u2705 \u6240\u6709\u7F16\u8F91\u5668MCP\u914D\u7F6E\u751F\u6210\u5B8C\u6210"))):(await a.writeMCPConfigFiles(i.editor,o,{includeAllModels:!0,enableStreaming:!0,enableHealthCheck:!0}),console.log(l.default.green(`\u2705 ${i.editor} MCP\u914D\u7F6E\u751F\u6210\u5B8C\u6210`)));let g={project:{name:"\u793A\u4F8B\u9879\u76EE",description:"TaskFlow AI \u793A\u4F8B\u9879\u76EE"},engine:{autoSave:!0,saveInterval:300,outputDir:"./output",defaultModel:"deepseek",enableOptimization:!0}};await e.default.writeFile(t.join(o,"taskflow.config.json"),JSON.stringify(g,null,2)),await e.default.writeFile(t.join(o,".env.example"),`# TaskFlow AI \u73AF\u5883\u53D8\u91CF\u914D\u7F6E
# \u8BF7\u586B\u5165\u60A8\u7684API\u5BC6\u94A5

# DeepSeek API
DEEPSEEK_API_KEY=your-deepseek-api-key

# \u667A\u8C31AI API
ZHIPU_API_KEY=your-zhipu-api-key

# \u901A\u4E49\u5343\u95EE API
QWEN_API_KEY=your-qwen-api-key

# \u6587\u5FC3\u4E00\u8A00 API
BAIDU_API_KEY=your-baidu-api-key
BAIDU_SECRET_KEY=your-baidu-secret-key

# \u6708\u4E4B\u6697\u9762 API
MOONSHOT_API_KEY=your-moonshot-api-key

# \u8BAF\u98DE\u661F\u706B API
SPARK_APP_ID=your-spark-app-id
SPARK_API_KEY=your-spark-api-key
SPARK_API_SECRET=your-spark-api-secret

# TaskFlow \u914D\u7F6E
TASKFLOW_LOG_LEVEL=info
TASKFLOW_CACHE_ENABLED=true
`),console.log(l.default.green("\u{1F389} TaskFlow AI \u9879\u76EE\u521D\u59CB\u5316\u5B8C\u6210\uFF01")),console.log(),console.log(l.default.yellow("\u{1F4C1} \u751F\u6210\u7684\u6587\u4EF6\uFF1A")),console.log("  \u251C\u2500\u2500 .cursor/mcp.json          # Cursor MCP\u914D\u7F6E"),console.log("  \u251C\u2500\u2500 .cursor-rules             # Cursor AI\u89C4\u5219"),console.log("  \u251C\u2500\u2500 .windsurf/mcp.json        # Windsurf MCP\u914D\u7F6E"),console.log("  \u251C\u2500\u2500 .trae/mcp-config.json     # Trae MCP\u914D\u7F6E"),console.log("  \u251C\u2500\u2500 .vscode/settings.json     # VSCode MCP\u914D\u7F6E"),console.log("  \u251C\u2500\u2500 .vscode/extensions.json   # VSCode\u6269\u5C55\u63A8\u8350"),console.log("  \u251C\u2500\u2500 .taskflow/                # TaskFlow\u914D\u7F6E\u76EE\u5F55"),console.log("  \u251C\u2500\u2500 docs/sample-prd.md        # \u793A\u4F8BPRD\u6587\u6863"),console.log("  \u251C\u2500\u2500 taskflow.config.json      # TaskFlow\u914D\u7F6E"),console.log("  \u2514\u2500\u2500 .env.example              # \u73AF\u5883\u53D8\u91CF\u6A21\u677F"),console.log(),console.log(l.default.blue("\u{1F527} \u4E0B\u4E00\u6B65\u8BBE\u7F6E\uFF1A")),console.log("  1. \u590D\u5236 .env.example \u4E3A .env"),console.log("  2. \u5728 .env \u4E2D\u586B\u5165\u60A8\u7684API\u5BC6\u94A5"),console.log("  3. \u6253\u5F00\u60A8\u7684AI\u7F16\u8F91\u5668\uFF08Cursor/Windsurf/Trae/VSCode\uFF09"),console.log("  4. \u7F16\u8F91\u5668\u4F1A\u81EA\u52A8\u542F\u52A8TaskFlow AI MCP\u670D\u52A1"),console.log(),console.log(l.default.green("\u{1F680} \u73B0\u5728\u53EF\u4EE5\u5F00\u59CB\u4F7F\u7528AI\u9A71\u52A8\u7684\u5F00\u53D1\u4F53\u9A8C\u4E86\uFF01"))}catch(e){console.error(l.default.red("\u274C \u521D\u59CB\u5316\u5931\u8D25:")),console.error(l.default.red(e.message))}});M.command("parse <file>").description("\u89E3\u6790PRD\u6587\u6863\u5E76\u751F\u6210\u4EFB\u52A1\u8BA1\u5212").option("-o, --output <path>","\u8F93\u51FA\u4EFB\u52A1\u8BA1\u5212\u7684\u8DEF\u5F84","./taskflow/tasks.json").option("-m, --model <type>","\u4F7F\u7528\u7684\u6A21\u578B\u7C7B\u578B","deepseek").option("--optimize","\u542F\u7528\u4EFB\u52A1\u8BA1\u5212\u4F18\u5316",!0).option("--estimate-effort","\u4F30\u7B97\u5DE5\u4F5C\u91CF",!0).option("--detect-dependencies","\u68C0\u6D4B\u4F9D\u8D56\u5173\u7CFB",!0).action(async(i,e)=>{console.log(l.default.blue("\u{1F4C4} TaskFlow AI - PRD\u89E3\u6790")),console.log();try{let t=await import("fs-extra"),r=await import("path"),o=(await import("ora")).default("\u6B63\u5728\u89E3\u6790PRD\u6587\u6863...").start();t.default.existsSync(i)||(o.fail(`\u6587\u4EF6\u4E0D\u5B58\u5728: ${i}`),process.exit(1)),o.text="\u6B63\u5728\u751F\u6210\u4EFB\u52A1\u8BA1\u5212...",await new Promise(c=>setTimeout(c,2e3));let n=r.resolve(process.cwd(),e.output);await t.default.ensureDir(r.dirname(n));let a={id:"project-"+Date.now(),name:"\u793A\u4F8B\u9879\u76EE\u4EFB\u52A1\u8BA1\u5212",description:"\u57FA\u4E8EPRD\u6587\u6863\u751F\u6210\u7684\u4EFB\u52A1\u8BA1\u5212",tasks:[{id:"task-1",title:"\u9879\u76EE\u521D\u59CB\u5316",description:"\u521B\u5EFA\u9879\u76EE\u7ED3\u6784\uFF0C\u914D\u7F6E\u5F00\u53D1\u73AF\u5883",status:"not_started",priority:"high",type:"setup",dependencies:[],estimatedHours:4,tags:["setup","infrastructure"],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()},{id:"task-2",title:"\u7528\u6237\u7BA1\u7406\u6A21\u5757",description:"\u5B9E\u73B0\u7528\u6237\u6CE8\u518C\u3001\u767B\u5F55\u3001\u4FE1\u606F\u7BA1\u7406\u529F\u80FD",status:"not_started",priority:"high",type:"feature",dependencies:["task-1"],estimatedHours:16,tags:["user","authentication"],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()},{id:"task-3",title:"\u5185\u5BB9\u7BA1\u7406\u6A21\u5757",description:"\u5B9E\u73B0\u5185\u5BB9\u7684\u521B\u5EFA\u3001\u7F16\u8F91\u3001\u5220\u9664\u529F\u80FD",status:"not_started",priority:"medium",type:"feature",dependencies:["task-2"],estimatedHours:20,tags:["content","crud"],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),status:"active"};await t.default.writeFile(n,JSON.stringify(a,null,2)),o.succeed("\u6210\u529F\u89E3\u6790PRD\u5E76\u751F\u6210\u4EFB\u52A1\u8BA1\u5212"),console.log(),console.log(l.default.green("\u2705 \u4EFB\u52A1\u8BA1\u5212\u5DF2\u751F\u6210:")),console.log(l.default.gray(`   \u6587\u4EF6: ${n}`)),console.log(l.default.gray(`   \u4EFB\u52A1\u6570\u91CF: ${a.tasks.length}`)),console.log(),console.log(l.default.cyan("\u{1F3AF} \u4E0B\u4E00\u6B65:")),console.log(l.default.gray(`   taskflow status -i ${n}`)),console.log(l.default.gray(`   taskflow visualize gantt -i ${n}`))}catch(t){console.error(l.default.red("\u274C \u89E3\u6790\u5931\u8D25:")),console.error(l.default.red(t.message)),process.exit(1)}});M.command("help").description("\u663E\u793A\u5E2E\u52A9\u4FE1\u606F").action(()=>{console.log(l.default.blue("\u{1F916} TaskFlow AI - \u667A\u80FDPRD\u6587\u6863\u89E3\u6790\u4E0E\u4EFB\u52A1\u7BA1\u7406\u52A9\u624B")),console.log(),console.log(l.default.cyan("\u{1F4D6} \u4E3B\u8981\u529F\u80FD:")),console.log(l.default.gray("  \u2022 PRD\u6587\u6863\u667A\u80FD\u89E3\u6790")),console.log(l.default.gray("  \u2022 AI\u4EFB\u52A1\u7F16\u6392\u4F18\u5316")),console.log(l.default.gray("  \u2022 \u4EFB\u52A1\u72B6\u6001\u7BA1\u7406")),console.log(l.default.gray("  \u2022 \u53EF\u89C6\u5316\u56FE\u8868\u751F\u6210")),console.log(),console.log(l.default.cyan("\u{1F680} \u5FEB\u901F\u5F00\u59CB:")),console.log(l.default.gray("  1. taskflow init                    # \u521D\u59CB\u5316\u9879\u76EE")),console.log(l.default.gray("  2. taskflow parse docs/prd.md       # \u89E3\u6790PRD\u6587\u6863")),console.log(l.default.gray("  3. taskflow status                  # \u67E5\u770B\u4EFB\u52A1\u72B6\u6001")),console.log(l.default.gray("  4. taskflow visualize gantt         # \u751F\u6210\u7518\u7279\u56FE")),console.log(),console.log(l.default.cyan("\u{1F4CB} \u5E38\u7528\u547D\u4EE4:")),console.log(l.default.gray("  taskflow parse <file>               # \u89E3\u6790PRD\u6587\u6863")),console.log(l.default.gray("  taskflow status                     # \u67E5\u770B\u9879\u76EE\u72B6\u6001")),console.log(l.default.gray("  taskflow status next                # \u83B7\u53D6\u63A8\u8350\u4EFB\u52A1")),console.log(l.default.gray("  taskflow status update <id> <status> # \u66F4\u65B0\u4EFB\u52A1\u72B6\u6001")),console.log(l.default.gray("  taskflow visualize gantt            # \u751F\u6210\u7518\u7279\u56FE")),console.log(l.default.gray("  taskflow visualize dependency       # \u751F\u6210\u4F9D\u8D56\u56FE")),console.log(),console.log(l.default.cyan("\u{1F3A8} \u53EF\u89C6\u5316\u7C7B\u578B:")),console.log(l.default.gray("  \u2022 gantt      - \u7518\u7279\u56FE")),console.log(l.default.gray("  \u2022 dependency - \u4F9D\u8D56\u5173\u7CFB\u56FE")),console.log(l.default.gray("  \u2022 kanban     - \u770B\u677F\u89C6\u56FE")),console.log(l.default.gray("  \u2022 progress   - \u8FDB\u5EA6\u56FE\u8868")),console.log(),console.log(l.default.cyan("\u{1F4A1} \u66F4\u591A\u5E2E\u52A9:")),console.log(l.default.gray("  taskflow <command> --help           # \u67E5\u770B\u547D\u4EE4\u8BE6\u7EC6\u5E2E\u52A9")),console.log(l.default.gray("  https://github.com/taskflow-ai/docs  # \u5728\u7EBF\u6587\u6863"))});M.command("next-task").description("\u83B7\u53D6\u4E0B\u4E00\u4E2A\u8981\u5904\u7406\u7684\u4EFB\u52A1").option("-f, --file <path>","\u4EFB\u52A1\u8BA1\u5212\u6587\u4EF6\u8DEF\u5F84","./tasks/tasks.json").action(async i=>{try{let e=(0,st.default)("\u6B63\u5728\u67E5\u627E\u4E0B\u4E00\u4E2A\u4EFB\u52A1...").start(),t=ot.default.resolve(process.cwd(),i.file);rt.existsSync(t)||(e.fail(`\u4EFB\u52A1\u6587\u4EF6\u4E0D\u5B58\u5728: ${t}`),process.exit(1));let r=await $.loadTaskPlan(t);r.success||(e.fail(`\u52A0\u8F7D\u4EFB\u52A1\u5931\u8D25: ${r.error}`),process.exit(1));let s=await $.getNextTasks();s.success||(e.fail(`\u83B7\u53D6\u4E0B\u4E00\u4E2A\u4EFB\u52A1\u5931\u8D25: ${s.error}`),process.exit(1)),e.succeed("\u6210\u529F\u67E5\u627E\u4E0B\u4E00\u4E2A\u4EFB\u52A1");let o=s.data;(!o||o.length===0)&&(console.log(l.default.yellow("\u6CA1\u6709\u627E\u5230\u53EF\u5904\u7406\u7684\u4EFB\u52A1")),process.exit(0));let n=o[0];console.log(l.default.cyan(`
\u4E0B\u4E00\u4E2A\u4EFB\u52A1:`)),console.log(l.default.cyan("-".repeat(80))),console.log(l.default.cyan(`ID: ${n.id}`)),console.log(l.default.cyan(`\u540D\u79F0: ${n.name}`)),console.log(l.default.cyan(`\u4F18\u5148\u7EA7: ${n.priority}`)),console.log(l.default.cyan(`\u72B6\u6001: ${n.status}`)),console.log(l.default.cyan(`\u63CF\u8FF0: ${n.description}`)),n.subtasks&&n.subtasks.length>0&&(console.log(l.default.cyan(`
\u5B50\u4EFB\u52A1:`)),n.subtasks.forEach((a,c)=>{console.log(l.default.white(`  ${c+1}. [${a.status}] ${a.name}`))})),console.log(l.default.cyan("-".repeat(80))),console.log(l.default.green(`
\u6267\u884C\u6B64\u4EFB\u52A1:`)),console.log(l.default.white(`  yasi-ai update-task --id=${n.id} --status=in_progress`)),console.log(l.default.white("  # \u5B8C\u6210\u4EFB\u52A1\u540E:")),console.log(l.default.white(`  yasi-ai update-task --id=${n.id} --status=done`))}catch(e){console.error(l.default.red(`\u9519\u8BEF: ${e.message}`)),process.exit(1)}});M.command("update-task").description("\u66F4\u65B0\u4EFB\u52A1\u72B6\u6001\u6216\u4FE1\u606F").option("-f, --file <path>","\u4EFB\u52A1\u8BA1\u5212\u6587\u4EF6\u8DEF\u5F84","./tasks/tasks.json").requiredOption("--id <id>","\u4EFB\u52A1ID").option("--status <status>","\u65B0\u72B6\u6001").option("--name <name>","\u65B0\u540D\u79F0").option("--description <description>","\u65B0\u63CF\u8FF0").option("--priority <priority>","\u65B0\u4F18\u5148\u7EA7").action(async i=>{try{let e=(0,st.default)("\u6B63\u5728\u66F4\u65B0\u4EFB\u52A1...").start(),t=ot.default.resolve(process.cwd(),i.file);rt.existsSync(t)||(e.fail(`\u4EFB\u52A1\u6587\u4EF6\u4E0D\u5B58\u5728: ${t}`),process.exit(1));let r=await $.loadTaskPlan(t);r.success||(e.fail(`\u52A0\u8F7D\u4EFB\u52A1\u5931\u8D25: ${r.error}`),process.exit(1));let s={};i.status&&(s.status=i.status),i.name&&(s.name=i.name),i.description&&(s.description=i.description),i.priority&&(s.priority=i.priority);let o=await $.updateTask(i.id,s);o.success||(e.fail(`\u66F4\u65B0\u4EFB\u52A1\u5931\u8D25: ${o.error}`),process.exit(1));let n=await $.saveTaskPlan(r.data,t);n.success||(e.fail(`\u4FDD\u5B58\u4EFB\u52A1\u8BA1\u5212\u5931\u8D25: ${n.error}`),process.exit(1)),e.succeed(`\u6210\u529F\u66F4\u65B0\u4EFB\u52A1 ${i.id}`);let a=o.data;a&&(console.log(l.default.cyan(`
\u66F4\u65B0\u540E\u7684\u4EFB\u52A1:`)),console.log(l.default.cyan("-".repeat(80))),console.log(l.default.cyan(`ID: ${a.id}`)),console.log(l.default.cyan(`\u540D\u79F0: ${a.name}`)),console.log(l.default.cyan(`\u4F18\u5148\u7EA7: ${a.priority}`)),console.log(l.default.cyan(`\u72B6\u6001: ${a.status}`)),console.log(l.default.cyan(`\u63CF\u8FF0: ${a.description}`)),console.log(l.default.cyan("-".repeat(80))))}catch(e){console.error(l.default.red(`\u9519\u8BEF: ${e.message}`)),process.exit(1)}});M.command("config").description("\u67E5\u770B\u6216\u8BBE\u7F6E\u914D\u7F6E").option("--get","\u83B7\u53D6\u5F53\u524D\u914D\u7F6E").option("--set-model <type>","\u8BBE\u7F6E\u9ED8\u8BA4\u6A21\u578B\u7C7B\u578B").option("--set-api-key <key>","\u8BBE\u7F6EAPI\u5BC6\u94A5").option("--model-type <type>","\u6307\u5B9A\u8BBE\u7F6EAPI\u5BC6\u94A5\u7684\u6A21\u578B\u7C7B\u578B","baidu").action(async i=>{try{if(i.get){let e=await $.getConfig();e.success||(console.error(l.default.red(`\u83B7\u53D6\u914D\u7F6E\u5931\u8D25: ${e.error}`)),process.exit(1)),console.log(l.default.cyan(`
\u5F53\u524D\u914D\u7F6E:`)),console.log(JSON.stringify(e.data,null,2));return}if(i.setModel){let e=i.setModel,t=await $.updateConfig({models:{default:e}});t.success||(console.error(l.default.red(`\u8BBE\u7F6E\u9ED8\u8BA4\u6A21\u578B\u5931\u8D25: ${t.error}`)),process.exit(1)),console.log(l.default.green(`\u6210\u529F\u8BBE\u7F6E\u9ED8\u8BA4\u6A21\u578B\u4E3A: ${e}`))}if(i.setApiKey){let e=i.modelType,t=i.setApiKey,r={models:{[e]:{apiKey:t}}};if(e==="baidu"&&t.includes(":")){let[n,a]=t.split(":");r.models&&typeof r.models=="object"&&(r.models[e]={apiKey:n,secretKey:a})}let s=await $.updateConfig(r);s.success||(console.error(l.default.red(`\u8BBE\u7F6EAPI\u5BC6\u94A5\u5931\u8D25: ${s.error}`)),process.exit(1)),console.log(l.default.green(`\u6210\u529F\u8BBE\u7F6E${e}\u6A21\u578B\u7684API\u5BC6\u94A5`));let o=await $.validateModelApiKey(e);!o.success||!o.data?.valid?console.log(l.default.yellow("\u8B66\u544A: API\u5BC6\u94A5\u9A8C\u8BC1\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u5BC6\u94A5\u662F\u5426\u6B63\u786E")):console.log(l.default.green("API\u5BC6\u94A5\u9A8C\u8BC1\u6210\u529F"))}}catch(e){console.error(l.default.red(`\u9519\u8BEF: ${e.message}`)),process.exit(1)}});M.parse(process.argv);process.argv.slice(2).length||(console.log(l.default.blue("\u{1F916} TaskFlow AI - \u667A\u80FDPRD\u6587\u6863\u89E3\u6790\u4E0E\u4EFB\u52A1\u7BA1\u7406\u52A9\u624B")),console.log(),console.log(l.default.cyan("\u{1F680} \u5FEB\u901F\u5F00\u59CB:")),console.log(l.default.gray("  taskflow init                    # \u521D\u59CB\u5316\u9879\u76EE")),console.log(l.default.gray("  taskflow parse docs/prd.md       # \u89E3\u6790PRD\u6587\u6863")),console.log(l.default.gray("  taskflow orchestrate             # \u667A\u80FD\u4EFB\u52A1\u7F16\u6392")),console.log(l.default.gray("  taskflow status                  # \u67E5\u770B\u4EFB\u52A1\u72B6\u6001")),console.log(),console.log(l.default.cyan("\u{1F4A1} \u83B7\u53D6\u5E2E\u52A9:")),console.log(l.default.gray("  taskflow help                    # \u663E\u793A\u8BE6\u7EC6\u5E2E\u52A9")),console.log(l.default.gray("  taskflow <command> --help        # \u67E5\u770B\u547D\u4EE4\u5E2E\u52A9")));
