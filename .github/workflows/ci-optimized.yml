name: CI/CD Pipeline (Optimized)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]
  workflow_dispatch:

env:
  NODE_VERSION: '20.x'
  CACHE_VERSION: v1

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥ä½œä¸š
  quality-check:
    name: Code Quality & Security
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: |
        echo "ðŸ“¦ Installing dependencies..."
        npm ci --prefer-offline --no-audit
        echo "âœ… Dependencies installed"
        
    - name: TypeScript type check
      run: |
        echo "ðŸ” Running TypeScript type check..."
        npx tsc --noEmit --incremental --pretty --skipLibCheck
        echo "âœ… TypeScript type check passed"
        
    - name: ESLint check
      run: |
        echo "ðŸ” Running ESLint..."
        npx eslint . --ext .ts,.tsx,.js,.jsx --format=compact --max-warnings=0
        echo "âœ… ESLint check passed"
        
    - name: Prettier check
      run: |
        echo "ðŸ” Running Prettier check..."
        npx prettier --check "**/*.{ts,tsx,js,jsx,json,md,yml,yaml}"
        echo "âœ… Prettier check passed"
        
    - name: Security audit
      run: |
        echo "ðŸ”’ Running security audit..."
        npm audit --audit-level=moderate
        echo "âœ… Security audit passed"

  # æµ‹è¯•ä½œä¸š
  test:
    name: Test Suite
    runs-on: ubuntu-latest
    needs: quality-check
    timeout-minutes: 15
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
      fail-fast: false
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: Install dependencies
      run: |
        echo "ðŸ“¦ Installing dependencies for Node.js ${{ matrix.node-version }}..."
        npm ci --prefer-offline --no-audit
        
    - name: Create environment file
      run: |
        echo "ðŸ”§ Creating environment configuration..."
        cp .env.example .env
        
    - name: Run tests
      run: |
        echo "ðŸ§ª Running test suite..."
        if [ -f "jest.config.simple.js" ]; then
          npm test -- --config=jest.config.simple.js --passWithNoTests --coverage
        else
          npm test -- --passWithNoTests --coverage
        fi
        echo "âœ… Tests completed"
      continue-on-error: false
      
    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      if: matrix.node-version == '20.x'
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./coverage/lcov.info
        fail_ci_if_error: false

  # æž„å»ºä½œä¸š
  build:
    name: Build & Package
    runs-on: ubuntu-latest
    needs: [quality-check, test]
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: |
        echo "ðŸ“¦ Installing dependencies..."
        npm ci --prefer-offline --no-audit
        
    - name: Build project
      run: |
        echo "ðŸ”¨ Building project..."
        npm run build
        echo "âœ… Build completed"
        
    - name: Verify build artifacts
      run: |
        echo "ðŸ” Verifying build artifacts..."
        if [ -d "dist" ]; then
          echo "âœ… Build directory exists"
          echo "ðŸ“Š Build size: $(du -sh dist | cut -f1)"
          echo "ðŸ“ Build contents:"
          ls -la dist/
        else
          echo "âŒ Build directory not found"
          exit 1
        fi
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts-${{ github.sha }}
        path: |
          dist/
          package.json
          README.md
        retention-days: 30

  # å‘å¸ƒä½œä¸šï¼ˆä»…åœ¨releaseæ—¶è¿è¡Œï¼‰
  publish:
    name: Publish Package
    runs-on: ubuntu-latest
    needs: [quality-check, test, build]
    if: github.event_name == 'release'
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        registry-url: 'https://registry.npmjs.org'
        
    - name: Install dependencies
      run: npm ci --prefer-offline --no-audit
      
    - name: Build project
      run: npm run build
      
    - name: Publish to npm
      run: npm publish --access public
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # éƒ¨ç½²çŠ¶æ€æ±‡æ€»
  deployment-status:
    name: Deployment Status
    runs-on: ubuntu-latest
    needs: [quality-check, test, build]
    if: always()
    
    steps:
    - name: Check deployment status
      run: |
        echo "## ðŸš€ CI/CD Pipeline Status Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.quality-check.result }}" = "success" ]; then
          echo "âœ… **Code Quality**: Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Code Quality**: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.test.result }}" = "success" ]; then
          echo "âœ… **Test Suite**: Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Test Suite**: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.build.result }}" = "success" ]; then
          echo "âœ… **Build**: Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Build**: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“Š **Pipeline Metrics**:" >> $GITHUB_STEP_SUMMARY
        echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- Trigger: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- Node.js: ${{ env.NODE_VERSION }}" >> $GITHUB_STEP_SUMMARY
