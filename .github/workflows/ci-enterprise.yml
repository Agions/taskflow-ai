name: Enterprise CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]
  workflow_dispatch:

env:
  NODE_VERSION: '20.x'
  CACHE_VERSION: v2
  CI: true

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥ä½œä¸š
  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: |
        echo "ðŸ“¦ Installing dependencies..."
        npm ci --prefer-offline --no-audit --silent
        echo "âœ… Dependencies installed"
        
    - name: TypeScript type check
      run: |
        echo "ðŸ” Running TypeScript type check..."
        if [ -f "tsconfig.json" ]; then
          npx tsc --noEmit --incremental --pretty --skipLibCheck
          echo "âœ… TypeScript type check passed"
        else
          echo "âš ï¸ No TypeScript configuration found, skipping"
        fi
        
    - name: ESLint check
      run: |
        echo "ðŸ” Running ESLint..."
        if [ -f ".eslintrc.js" ] || [ -f ".eslintrc.json" ] || [ -f "eslint.config.js" ]; then
          npx eslint . --ext .ts,.tsx,.js,.jsx --format=compact --max-warnings=0
          echo "âœ… ESLint check passed"
        else
          echo "âš ï¸ No ESLint configuration found, skipping"
        fi
        
    - name: Prettier check
      run: |
        echo "ðŸ” Running Prettier check..."
        if [ -f ".prettierrc" ] || [ -f ".prettierrc.json" ] || [ -f "prettier.config.js" ]; then
          npx prettier --check "**/*.{ts,tsx,js,jsx,json,md,yml,yaml}" --ignore-unknown
          echo "âœ… Prettier check passed"
        else
          echo "âš ï¸ No Prettier configuration found, skipping"
        fi
        
    - name: Security audit
      run: |
        echo "ðŸ”’ Running security audit..."
        npm audit --audit-level=moderate || echo "âš ï¸ Security audit found issues, but continuing"
        echo "âœ… Security audit completed"

  # æµ‹è¯•ä½œä¸š
  test-suite:
    name: Test Suite
    runs-on: ubuntu-latest
    needs: quality-gate
    timeout-minutes: 15
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
      fail-fast: false
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: Install dependencies
      run: |
        echo "ðŸ“¦ Installing dependencies for Node.js ${{ matrix.node-version }}..."
        npm ci --prefer-offline --no-audit --silent
        
    - name: Create environment file
      run: |
        echo "ðŸ”§ Creating environment configuration..."
        if [ -f ".env.example" ]; then
          cp .env.example .env
        fi
        
    - name: Run tests
      run: |
        echo "ðŸ§ª Running test suite..."
        if [ -f "jest.config.simple.js" ]; then
          npm test -- --config=jest.config.simple.js --passWithNoTests --silent
        elif [ -f "jest.config.js" ]; then
          npm test -- --passWithNoTests --silent
        else
          echo "âš ï¸ No test configuration found, skipping tests"
        fi
        echo "âœ… Tests completed"
      continue-on-error: false

  # æ–‡æ¡£æž„å»ºä½œä¸š
  docs-build:
    name: Documentation Build
    runs-on: ubuntu-latest
    needs: [quality-gate]
    timeout-minutes: 15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: |
        echo "ðŸ“¦ Installing dependencies..."
        npm ci --prefer-offline --no-audit --silent
        
    - name: Build documentation
      run: |
        echo "ðŸ“š Building documentation..."
        cd docs
        
        # æ¸…ç†ç¼“å­˜
        rm -rf .vitepress/cache
        rm -rf .vitepress/dist
        rm -rf node_modules/.cache
        
        # å®‰è£…æ–‡æ¡£ä¾èµ–
        npm ci --prefer-offline --no-audit --silent
        
        # éªŒè¯é…ç½®
        echo "ðŸ” Verifying VitePress configuration..."
        if grep -q "æŒ‡å—\|APIå‚è€ƒ\|ç”¨æˆ·æ‰‹å†Œ\|æŠ€æœ¯å‚è€ƒ" .vitepress/config.ts; then
          echo "âœ… Configuration contains complete navigation"
        else
          echo "âŒ Configuration may be incomplete"
          head -50 .vitepress/config.ts
        fi
        
        # æž„å»ºæ–‡æ¡£
        npm run build
        
        # éªŒè¯æž„å»ºäº§ç‰©
        echo "ðŸ” Verifying build output..."
        if grep -q "æŒ‡å—\|APIå‚è€ƒ\|ç”¨æˆ·æ‰‹å†Œ\|æŠ€æœ¯å‚è€ƒ" .vitepress/dist/index.html; then
          echo "âœ… Build output contains complete navigation"
        else
          echo "âŒ Build output missing navigation"
        fi
        
        echo "âœ… Documentation build completed"
        
    - name: Upload documentation artifacts
      uses: actions/upload-artifact@v4
      with:
        name: documentation-${{ github.sha }}
        path: docs/.vitepress/dist
        retention-days: 30

  # é¡¹ç›®æž„å»ºä½œä¸š
  project-build:
    name: Project Build
    runs-on: ubuntu-latest
    needs: [quality-gate, test-suite]
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: |
        echo "ðŸ“¦ Installing dependencies..."
        npm ci --prefer-offline --no-audit --silent
        
    - name: Build project
      run: |
        echo "ðŸ”¨ Building project..."
        if [ -f "package.json" ] && grep -q '"build"' package.json; then
          npm run build
          echo "âœ… Project build completed"
        else
          echo "âš ï¸ No build script found, skipping project build"
        fi
        
    - name: Verify build artifacts
      run: |
        echo "ðŸ” Verifying build artifacts..."
        if [ -d "dist" ]; then
          echo "âœ… Build directory exists"
          echo "ðŸ“Š Build size: $(du -sh dist | cut -f1)"
          echo "ðŸ“ Build contents:"
          ls -la dist/ | head -10
        elif [ -d "build" ]; then
          echo "âœ… Build directory exists (build/)"
          echo "ðŸ“Š Build size: $(du -sh build | cut -f1)"
        else
          echo "âš ï¸ No build directory found"
        fi

  # éƒ¨ç½²çŠ¶æ€æ±‡æ€»
  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [quality-gate, test-suite, docs-build, project-build]
    if: always()
    
    steps:
    - name: Generate deployment summary
      run: |
        echo "## ðŸš€ Enterprise CI/CD Pipeline Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # è´¨é‡æ£€æŸ¥çŠ¶æ€
        if [ "${{ needs.quality-gate.result }}" = "success" ]; then
          echo "âœ… **Quality Gate**: Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Quality Gate**: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        # æµ‹è¯•çŠ¶æ€
        if [ "${{ needs.test-suite.result }}" = "success" ]; then
          echo "âœ… **Test Suite**: Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Test Suite**: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        # æ–‡æ¡£æž„å»ºçŠ¶æ€
        if [ "${{ needs.docs-build.result }}" = "success" ]; then
          echo "âœ… **Documentation Build**: Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Documentation Build**: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        # é¡¹ç›®æž„å»ºçŠ¶æ€
        if [ "${{ needs.project-build.result }}" = "success" ]; then
          echo "âœ… **Project Build**: Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Project Build**: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“Š **Pipeline Metrics**:" >> $GITHUB_STEP_SUMMARY
        echo "- Commit: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- Branch: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- Trigger: \`${{ github.event_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- Node.js: \`${{ env.NODE_VERSION }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- Timestamp: \`$(date -u)\`" >> $GITHUB_STEP_SUMMARY
