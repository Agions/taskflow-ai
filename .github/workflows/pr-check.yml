name: PR Checks

on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]

env:
  NODE_VERSION: '20.x'
  CI: true

jobs:
  # PR ÂÖÉÊï∞ÊçÆÊ£ÄÊü•
  pr-metadata:
    name: PR Metadata Check
    runs-on: ubuntu-latest

    steps:
    - name: Check PR title
      uses: amannn/action-semantic-pull-request@v5
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        types: |
          feat
          fix
          docs
          style
          refactor
          perf
          test
          build
          ci
          chore
          revert
        scopes: |
          mcp
          cli
          core
          ai
          parser
          config
          docs
          deps
        requireScope: false

  # ‰ª£Á†ÅË¥®ÈáèÊ£ÄÊü•
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci --prefer-offline --no-audit

    - name: Run ESLint
      run: npm run lint
      continue-on-error: true

    - name: Run Prettier check
      run: npm run format:check
      continue-on-error: true

    - name: Run TypeScript check
      run: npm run type-check
      continue-on-error: true

  # ÊµãËØï
  test:
    name: Test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: [18.x, 20.x]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci --prefer-offline --no-audit

    - name: Run tests
      run: npm test
      continue-on-error: true

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.os }}-${{ matrix.node-version }}
        path: |
          junit.xml
          coverage/

  # ÊûÑÂª∫ÊµãËØï
  build-test:
    name: Build Test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci --prefer-offline --no-audit

    - name: Build project
      run: npm run build

    - name: Test CLI
      run: |
        node dist/cli/index.js --help
        node dist/cli/index.js --version

    - name: Check build artifacts
      run: |
        ls -la dist/
        ls -la dist/cli/
        ls -la dist/mcp/

  # ‰æùËµñÊ£ÄÊü•
  dependency-check:
    name: Dependency Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Check for lockfile changes
      run: |
        if [ -f "package-lock.json" ]; then
          echo "‚úÖ package-lock.json exists"
        else
          echo "‚ùå package-lock.json is missing"
          exit 1
        fi

    - name: Check for unused dependencies
      run: |
        npm install -g depcheck
        depcheck --ignore-bin-package --skip-missing || true

    - name: Security audit
      run: npm audit --audit-level moderate --production || true

  # Â§ßÂ∞èÊ£ÄÊü•
  size-check:
    name: Size Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci --prefer-offline --no-audit

    - name: Build project
      run: npm run build

    - name: Check bundle size
      run: |
        echo "## üì¶ Bundle Size Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| File | Size |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|" >> $GITHUB_STEP_SUMMARY

        for file in dist/**/*.js; do
          if [ -f "$file" ]; then
            size=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file" 2>/dev/null || echo "0")
            size_kb=$((size / 1024))
            echo "| $(basename $file) | ${size_kb} KB |" >> $GITHUB_STEP_SUMMARY
          fi
        done

        # Check if bundle is too large
        max_size=10485760  # 10MB
        total_size=$(find dist -name "*.js" -exec stat -c%s {} + 2>/dev/null | awk '{sum+=$1} END {print sum}')
        if [ "$total_size" -gt "$max_size" ]; then
          echo "‚ö†Ô∏è Warning: Total bundle size exceeds 10MB"
        fi
