import { Command } from 'commander';
import path from 'path';
import fs from 'fs-extra';
import chalk from 'chalk';
import ora from 'ora';
import inquirer from 'inquirer';

import { ProjectTemplateManager } from '../core/templates/project-template-manager';
import { EditorConfigGenerator } from '../core/templates/editor-config-generator';
import { ProgrammingLanguage, ProjectType } from '../core/templates/ai-rules-generator';
// ç§»é™¤æœªä½¿ç”¨çš„å¯¼å…¥

/**
 * é¡¹ç›®åˆå§‹åŒ–å‘½ä»¤
 * æ”¯æŒå¤šç§é¡¹ç›®æ¨¡æ¿å’ŒAIç¼–è¾‘å™¨é…ç½®ç”Ÿæˆ
 */
export default function initCommand(program: Command): void {
  program
    .command('init [directory]')
    .description('åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„TaskFlow AIé¡¹ç›®')
    .option('-f, --force', 'å¼ºåˆ¶åˆå§‹åŒ–ï¼Œè¦†ç›–å·²å­˜åœ¨çš„é…ç½®')
    .option('-t, --template <template>', 'é¡¹ç›®æ¨¡æ¿ (web-app, api, mobile, ai-ml)', 'web-app')
    .option('-l, --language <language>', 'AIè§„åˆ™è¯­è¨€ (typescript, python, java, go, rust)', 'typescript')
    .option('-e, --editor <editor>', 'AIç¼–è¾‘å™¨é…ç½® (windsurf, trae, cursor, vscode, all)', 'windsurf,trae,cursor,vscode')
    .option('--no-examples', 'ä¸åˆ›å»ºç¤ºä¾‹æ–‡ä»¶')
    .option('--no-git', 'ä¸åˆå§‹åŒ–Gitä»“åº“')
    .option('--no-install', 'ä¸è‡ªåŠ¨å®‰è£…ä¾èµ–')
    .action(async (directory = '.', options) => {
      try {
        const spinner = ora('æ­£åœ¨åˆå§‹åŒ–TaskFlow AIé¡¹ç›®...').start();

        // ç¡®å®šç›®æ ‡ç›®å½•çš„ç»å¯¹è·¯å¾„
        const targetDir = path.resolve(process.cwd(), directory);
        const projectName = path.basename(targetDir);

        // æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º
        if (!fs.existsSync(targetDir)) {
          spinner.text = `åˆ›å»ºé¡¹ç›®ç›®å½• ${targetDir}...`;
          fs.mkdirSync(targetDir, { recursive: true });
        }

        // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨é…ç½®æ–‡ä»¶
        const configPath = path.join(targetDir, 'taskflow.config.json');
        if (fs.existsSync(configPath) && !options.force) {
          spinner.stop();
          const { overwrite } = await inquirer.prompt([
            {
              type: 'confirm',
              name: 'overwrite',
              message: 'é¡¹ç›®é…ç½®æ–‡ä»¶å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦†ç›–?',
              default: false,
            },
          ]);

          if (!overwrite) {
            console.log(chalk.yellow('åˆå§‹åŒ–å·²å–æ¶ˆ'));
            return;
          }
          spinner.start('æ­£åœ¨è¦†ç›–å·²æœ‰é…ç½®...');
        }

        // åˆå§‹åŒ–é¡¹ç›®æ¨¡æ¿ç®¡ç†å™¨
        const templateManager = new ProjectTemplateManager();
        const editorGenerator = new EditorConfigGenerator();

        // è·å–å¯ç”¨æ¨¡æ¿åˆ—è¡¨
        const availableTemplates = templateManager.getAvailableTemplates();

        // éªŒè¯æ¨¡æ¿é€‰æ‹©
        if (!availableTemplates.includes(options.template)) {
          spinner.stop();
          console.log(chalk.red(`âŒ ä¸æ”¯æŒçš„æ¨¡æ¿ç±»å‹: ${options.template}`));
          console.log(chalk.yellow(`å¯ç”¨æ¨¡æ¿: ${availableTemplates.join(', ')}`));
          return;
        }

        // ç”Ÿæˆé¡¹ç›®ç»“æ„
        spinner.text = `ä½¿ç”¨ ${options.template} æ¨¡æ¿ç”Ÿæˆé¡¹ç›®ç»“æ„...`;
        await templateManager.generateProject(targetDir, options.template, projectName, {
          examples: options.examples,
          git: options.git,
          install: options.install
        });

        // ç”ŸæˆAIç¼–è¾‘å™¨é…ç½®
        spinner.text = 'ç”ŸæˆAIç¼–è¾‘å™¨é…ç½®æ–‡ä»¶...';
        const editorVariables = {
          PROJECT_NAME: projectName,
          PROJECT_TYPE: options.template,
          PROJECT_DESCRIPTION: `${options.template} project generated by TaskFlow AI`,
          DATE: new Date().toISOString().split('T')[0],
          VERSION: '1.3.0',
          TYPESCRIPT: true,
          JAVASCRIPT: false,
          REACT: options.template === 'web-app',
          NODE_API: options.template === 'api',
          JEST: true,
          YAML: true,
          BASH: true,
          PORT: 3000,
          PROJECT_SPECIFIC_NOTES: `This is a ${options.template} project. Follow best practices for ${options.template} development.`
        };

        // ç”ŸæˆæŒ‡å®šç¼–è¾‘å™¨é…ç½®
        const supportedEditors = ['windsurf', 'trae', 'cursor', 'vscode'];
        let editors: string[] = [];

        if (options.editor === 'all') {
          editors = supportedEditors;
        } else {
          editors = options.editor.split(',').map((e: string) => e.trim());
        }

        // éªŒè¯ç¼–è¾‘å™¨é€‰é¡¹
        const invalidEditors = editors.filter(editor => !supportedEditors.includes(editor));
        if (invalidEditors.length > 0) {
          spinner.stop();
          console.log(chalk.red(`âŒ ä¸æ”¯æŒçš„ç¼–è¾‘å™¨: ${invalidEditors.join(', ')}`));
          console.log(chalk.yellow(`æ”¯æŒçš„ç¼–è¾‘å™¨: ${supportedEditors.join(', ')}`));
          return;
        }

        // ç”Ÿæˆç¼–è¾‘å™¨é…ç½®
        for (const editor of editors) {
          await editorGenerator.generateEditorConfig(targetDir, editor, editorVariables);
        }

        // ç”ŸæˆåŸºäºè¯­è¨€çš„AIè§„åˆ™
        spinner.text = 'ç”ŸæˆAIç¼–ç¨‹è§„åˆ™...';
        const language = mapLanguage(options.language);
        const projectType = mapProjectType(options.template);
        const features = getProjectFeatures(options.template);

        await editorGenerator.generateLanguageSpecificAIRules(
          targetDir,
          language,
          projectType,
          projectName,
          features
        );

        // åˆ›å»ºTaskFlowé…ç½®æ–‡ä»¶
        spinner.text = 'ç”ŸæˆTaskFlowé…ç½®æ–‡ä»¶...';
        const taskflowConfig = {
          project: {
            name: projectName,
            type: options.template,
            version: '1.0.0',
            description: `${options.template} project generated by TaskFlow AI`,
            createdAt: new Date().toISOString()
          },
          ai: {
            models: {
              default: 'deepseek',
              multiModel: {
                enabled: true,
                primary: 'deepseek',
                fallback: ['zhipu', 'qwen']
              }
            }
          },
          parsing: {
            language: 'zh',
            includeTests: true,
            includeDocs: true
          },
          planning: {
            teamSize: 5,
            sprintDuration: 14,
            workingHours: 8
          }
        };

        await fs.writeFile(
          path.join(targetDir, 'taskflow.config.json'),
          JSON.stringify(taskflowConfig, null, 2)
        );

        spinner.succeed(`ğŸ‰ TaskFlow AIé¡¹ç›®åˆå§‹åŒ–å®Œæˆï¼`);

        console.log(`
${chalk.cyan('ğŸ“ é¡¹ç›®ä¿¡æ¯:')}
  åç§°: ${chalk.green(projectName)}
  ç±»å‹: ${chalk.green(options.template)}
  ä½ç½®: ${chalk.green(targetDir)}

${chalk.cyan('ğŸ¤– AIç¼–è¾‘å™¨é…ç½®:')}
  ${editors.length === supportedEditors.length ? 'âœ… å·²ç”Ÿæˆæ‰€æœ‰ç¼–è¾‘å™¨é…ç½®' : `âœ… å·²ç”Ÿæˆ ${editors.join(', ')} é…ç½®`}
  - Windsurf: .windsurf/settings.json, mcp.json, ai-config.json
  - Trae: .trae/config.json, mcp.json, workflows.json
  - Cursor: .cursor-rules
  - VSCode: .vscode/settings.json, extensions.json

${chalk.cyan('ğŸ”— MCPæœåŠ¡é›†æˆ:')}
  ${editors.includes('windsurf') || editors.includes('trae') ? 'âœ… MCPæœåŠ¡é…ç½®å·²ç”Ÿæˆ' : 'âš ï¸  é€‰æ‹©Windsurfæˆ–Traeä»¥å¯ç”¨MCPæœåŠ¡'}
  - å¤šæ¨¡å‹ä»»åŠ¡ç¼–æ’
  - æ™ºèƒ½ä»»åŠ¡åˆ†è§£
  - å®æ—¶çŠ¶æ€åŒæ­¥
  - å›¢é˜Ÿåä½œåŠŸèƒ½

${chalk.cyan('ğŸš€ åç»­æ­¥éª¤:')}
1. ${chalk.yellow(`cd ${directory !== '.' ? directory : projectName}`)}
2. ${chalk.yellow('npm install')} ${options.install === false ? '(æ‰‹åŠ¨å®‰è£…ä¾èµ–)' : '(å·²è‡ªåŠ¨å®‰è£…)'}
3. ${chalk.yellow('taskflow-ai config set models.apiKeys.deepseek "your-api-key"')}
4. ${chalk.yellow('npm run dev')} å¯åŠ¨å¼€å‘æœåŠ¡å™¨
5. ${chalk.yellow('taskflow-ai parse ./docs/README.md')} è§£æé¡¹ç›®æ–‡æ¡£

${chalk.cyan('ğŸ“š æ–‡æ¡£:')}
  - README.md: é¡¹ç›®è¯´æ˜å’Œä½¿ç”¨æŒ‡å—
  - docs/: é¡¹ç›®æ–‡æ¡£ç›®å½•
  - taskflow.config.json: TaskFlow AIé…ç½®æ–‡ä»¶

${chalk.gray('Generated by TaskFlow AI v1.3.0')}
        `);

      } catch (error) {
        console.error(chalk.red('åˆå§‹åŒ–å¤±è´¥:'), error);
        process.exit(1);
      }
    });
}

/**
 * æ˜ å°„è¯­è¨€å­—ç¬¦ä¸²åˆ°ProgrammingLanguageæšä¸¾
 */
function mapLanguage(language: string): ProgrammingLanguage {
    const languageMap: Record<string, ProgrammingLanguage> = {
      'typescript': ProgrammingLanguage.TYPESCRIPT,
      'javascript': ProgrammingLanguage.JAVASCRIPT,
      'python': ProgrammingLanguage.PYTHON,
      'java': ProgrammingLanguage.JAVA,
      'go': ProgrammingLanguage.GO,
      'rust': ProgrammingLanguage.RUST,
      'csharp': ProgrammingLanguage.CSHARP,
      'php': ProgrammingLanguage.PHP
    };

    return languageMap[language.toLowerCase()] || ProgrammingLanguage.TYPESCRIPT;
  }

/**
 * æ˜ å°„é¡¹ç›®æ¨¡æ¿åˆ°ProjectTypeæšä¸¾
 */
function mapProjectType(template: string): ProjectType {
    const typeMap: Record<string, ProjectType> = {
      'web-app': ProjectType.WEB_APP,
      'api': ProjectType.API,
      'mobile': ProjectType.MOBILE,
      'ai-ml': ProjectType.AI_ML
    };

    return typeMap[template] || ProjectType.WEB_APP;
  }

/**
 * æ ¹æ®æ¨¡æ¿è·å–é¡¹ç›®ç‰¹æ€§
 */
function getProjectFeatures(template: string): string[] {
    const features: Record<string, string[]> = {
      'web-app': ['frontend', 'responsive', 'pwa', 'testing'],
      'api': ['rest-api', 'authentication', 'database', 'testing'],
      'mobile': ['mobile-ui', 'responsive', 'offline', 'testing'],
      'ai-ml': ['machine-learning', 'data-processing', 'api', 'testing']
    };

    return features[template] || ['basic', 'testing'];
}


